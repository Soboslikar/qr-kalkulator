<!-- UNUTAR <script> BLOKA PRI DNU -->
<script>
  let ukupno = 0;
  let povijest = [];
  let currentAmount = 0;
  let currentQRCode = '';
  let currentTime = '';
  let removeConfirm = false;

  function updateDisplay() {
    document.getElementById('total').innerText = `UKUPNO: ${ukupno.toFixed(2)} €`;
    document.getElementById('current-amount').innerText = `${currentAmount.toFixed(2)} €`;
    updateHistory();
    checkRemoveButtonVisibility();
    handleAmountLabelVisibility();
  }

  function updateHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    povijest.forEach((item, index) => {
      const listItem = document.createElement('li');
      listItem.classList.add('bold-text');
      listItem.innerText = `${index + 1}. ${item.amount.toFixed(2)} €  (${item.time})`;
      historyList.appendChild(listItem);
    });
  }

  function checkRemoveButtonVisibility() {
    const removeButton = document.getElementById('remove-from-list-btn');
    removeButton.style.display = povijest.length > 0 ? 'block' : 'none';
  }

  function handleAmountLabelVisibility() {
    const amountLabel = document.getElementById('amount-label');
    const currentAmountDiv = document.getElementById('current-amount');
    const duplicateWarning = document.getElementById('duplicate-warning');
    if (removeConfirm && povijest.length > 0) {
      const lastItem = povijest[povijest.length - 1];
      amountLabel.innerText = `OBRIŠI IZNOS: ${lastItem.amount.toFixed(2)} € (${lastItem.time})`;
      amountLabel.classList.add('delete-mode');
      amountLabel.style.display = 'block';
      currentAmountDiv.style.display = 'none';
      duplicateWarning.style.display = 'none';
    } else if (currentAmount > 0) {
      amountLabel.innerText = 'DODAJ IZNOS:';
      amountLabel.classList.remove('delete-mode');
      amountLabel.style.display = 'block';
      currentAmountDiv.style.display = 'block';
      duplicateWarning.style.display = 'none';
    } else {
      amountLabel.style.display = 'none';
      currentAmountDiv.style.display = 'none';
      duplicateWarning.style.display = 'none';
    }
  }

  function playSound(id) {
    const sound = document.getElementById(id);
    if (sound) {
      sound.currentTime = 0;
      sound.play().catch(err => console.warn('Zvuk nije mogao biti reproduciran:', err));
    }
  }

  function addCurrent() {
    if (currentAmount > 0) {
      povijest.push({ amount: currentAmount, qrCode: currentQRCode, time: currentTime });
      ukupno += currentAmount;
      currentAmount = 0;
      currentQRCode = '';
      currentTime = '';
      updateDisplay();
      document.getElementById('add-btn').style.display = 'none';
      document.getElementById('clear-current-btn').style.display = 'none';
      playSound('click-sound');
    }
  }

  function clearCurrent() {
    currentAmount = 0;
    currentQRCode = '';
    currentTime = '';
    updateDisplay();
    document.getElementById('add-btn').style.display = 'none';
    document.getElementById('clear-current-btn').style.display = 'none';
    playSound('remove-sound');
  }

  function startRemoveFromList() {
    const removeButton = document.getElementById('remove-from-list-btn');
    if (!removeConfirm) {
      removeButton.innerText = 'Potvrdi';
      removeButton.style.backgroundColor = 'yellow';
      removeButton.style.color = 'black';
      removeConfirm = true;
      handleAmountLabelVisibility();
    } else {
      if (povijest.length > 0) {
        const removed = povijest.pop();
        ukupno -= removed.amount;
        updateDisplay();
        playSound('remove-sound');
      }
      removeButton.innerText = 'Obriši iz liste';
      removeButton.style.backgroundColor = 'red';
      removeButton.style.color = 'yellow';
      removeConfirm = false;
      handleAmountLabelVisibility();
    }
  }

  function handleScan(decodedText) {
    const urlParams = new URLSearchParams(decodedText);
    const iznosCenti = parseFloat(urlParams.get('izn'));

    const datumVrijeme = urlParams.get('dat') || ''; // npr. 20240408T140732
    let hhmm = '';
    if (datumVrijeme.length >= 15) {
      hhmm = datumVrijeme.slice(9, 11) + ':' + datumVrijeme.slice(11, 13); // 14:07
    }

    if (!isNaN(iznosCenti)) {
      const iznosEuri = iznosCenti / 100;
      if (povijest.some(item => item.qrCode === decodedText)) {
        document.getElementById('duplicate-warning').style.display = 'block';
        document.getElementById('amount-label').style.display = 'none';
        document.getElementById('current-amount').style.display = 'none';
        document.getElementById('add-btn').style.display = 'none';
        document.getElementById('clear-current-btn').style.display = 'none';
      } else {
        currentAmount = iznosEuri;
        currentQRCode = decodedText;
        currentTime = hhmm;
        updateDisplay();
        document.getElementById('add-btn').style.display = 'block';
        document.getElementById('clear-current-btn').style.display = 'block';
        playSound('scan-sound');
      }
    }
  }

  const html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        handleScan
      ).catch(err => console.error(err));
    }
  });
</script>
