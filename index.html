    // *** AŽURIRANA FUNKCIJA ZA RENDERIRANJE POVIJESTI ***
    function renderHistoryView() { 
         // Ažuriraj ukupan broj računa
         if (historyTotalCountSpan) {
             historyTotalCountSpan.innerText = povijest.length;
         }
         
         if (!historyContentDiv) return;

         // --- Formatiranje datuma (ostaje isto) ---
         const danas = new Date();
         const opcijeDana = { weekday: 'long' };
         const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' };
         let imeDana = danas.toLocaleDateString('hr-HR', opcijeDana);
         imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); 
         const formatiraniDatum = danas.toLocaleDateString('hr-HR', opcijeDatuma);
         const datumHtml = `<h3 id="history-current-date-display">${imeDana}, ${formatiraniDatum}</h3>`;

         // --- Filtriranje i grupiranje računa za DANAS ---
         const pocetakDanaDanas = new Date();
         pocetakDanaDanas.setHours(0, 0, 0, 0); // Postavi na početak dana
         const krajDanaDanas = new Date();
         krajDanaDanas.setHours(23, 59, 59, 999); // Postavi na kraj dana

         // Filtriraj samo račune skenirane danas
         const danasnjiRacuni = povijest.filter(item => 
             item.scanTimestamp >= pocetakDanaDanas.getTime() && item.scanTimestamp <= krajDanaDanas.getTime()
         );

         // Sortiraj današnje račune po vremenu skeniranja (od najstarijeg do najnovijeg)
         danasnjiRacuni.sort((a, b) => a.scanTimestamp - b.scanTimestamp);

         let grupeRacunaHtml = '';
         if (danasnjiRacuni.length === 0) {
             grupeRacunaHtml = '<p style="text-align:center; color: grey;"><i>Nema skeniranih računa za danas.</i></p>';
         } else {
             let trenutnaGrupa = [];
             let zadnjeVrijemeUGrupi = 0;
             const GRUPIRANJE_SEKUNDE = 30; // 30 sekundi razmaka za novu grupu

             danasnjiRacuni.forEach((racun, index) => {
                 // Ako je prva grupa ili je prošlo više od 30 sekundi od zadnjeg u GRUPI
                 if (trenutnaGrupa.length === 0 || (racun.scanTimestamp - zadnjeVrijemeUGrupi) > GRUPIRANJE_SEKUNDE * 1000) {
                     // Završi prethodnu grupu (ako postoji)
                     if (trenutnaGrupa.length > 0) {
                         grupeRacunaHtml += generirajHtmlZaGrupu(trenutnaGrupa);
                     }
                     // Započni novu grupu
                     trenutnaGrupa = [racun];
                 } else {
                     // Dodaj u postojeću grupu
                     trenutnaGrupa.push(racun);
                 }
                 // Ažuriraj vrijeme zadnjeg računa u trenutnoj grupi
                 zadnjeVrijemeUGrupi = racun.scanTimestamp;

                 // Ako je ovo zadnji račun, završi i zadnju grupu
                 if (index === danasnjiRacuni.length - 1) {
                     grupeRacunaHtml += generirajHtmlZaGrupu(trenutnaGrupa);
                 }
             });
         }

         // --- Gumb za brisanje (ostaje isti) ---
         const obrisiBtnHtml = `<button id="clear-history-btn" class="red-btn" style="margin: 2em auto 1em auto; display: block;">OBRIŠI SVU POVIJEST</button>`;

         // --- Spajanje HTML-a ---
         historyContentDiv.innerHTML = datumHtml + grupeRacunaHtml + obrisiBtnHtml;
         
         // --- Ponovno dodavanje listenera ---
         const clearBtn = document.getElementById('clear-history-btn');
         if (clearBtn) { 
             clearBtn.addEventListener('click', () => {
                 if (confirm("Obrisati SVE račune?")) {
                     povijest = []; ukupno = 0; localStorage.removeItem(HISTORY_STORAGE_KEY); 
                     updateDisplay(); alert("Povijest obrisana."); 
                     if (document.body.classList.contains('history-view')) renderHistoryView(); 
                 }
             });
         }
    }

    // --- Nova pomoćna funkcija za generiranje HTML-a jedne grupe ---
    function generirajHtmlZaGrupu(grupa) {
        if (!grupa || grupa.length === 0) return '';

        // Izračunaj ukupan iznos grupe
        const ukupnoGrupa = grupa.reduce((sum, item) => sum + item.amount, 0);
        
        // Uzmi vrijeme zadnjeg računa u grupi
        const zadnjiRacun = grupa[grupa.length - 1];
        const vrijemeZadnjegSkena = new Date(zadnjiRacun.scanTimestamp);
        const sati = vrijemeZadnjegSkena.getHours().toString().padStart(2, '0');
        const minute = vrijemeZadnjegSkena.getMinutes().toString().padStart(2, '0');
        const vrijemeFormatirano = `${sati}:${minute}`;

        // Generiraj HTML za pojedinačne račune unutar grupe (za sada sakriveno, samo prikaz ukupnog)
        // Kasnije ćemo dodati opciju "RAŠIRI" za ovo
        /*
        let racuniHtml = '<ul style="margin-left: 20px; display: none;">'; // Sakriveno za sada
        grupa.forEach(racun => {
            racuniHtml += `<li>${racun.time} - ${racun.amount.toFixed(2)} €</li>`;
        });
        racuniHtml += '</ul>';
        */

        // Generiraj HTML za cijelu grupu
        // Kasnije ćemo ovdje dodati gumb "RAŠIRI"
        return `
            <div class="history-group" style="border: 1px solid #eee; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold;">${ukupnoGrupa.toFixed(2)} €</span>
                    <span style="color: grey; font-size: 0.9em;">Zadnji u ${vrijemeFormatirano}</span>
                     <!-- <button class="expand-group-btn" style="padding: 2px 5px; font-size: 0.8em;">Raširi</button> --> 
                </div>
                <!-- ${racuniHtml} --> 
            </div>
        `;
    }

    // --- Ostali JavaScript kod (ostaje isti) ---
    document.body.addEventListener('click', (event) => { if (!document.body.classList.contains('scanner-view')) return; const isClickOnRemoveButton = removeButton && removeButton.contains(event.target); const isClickOnDeleteWarning = deleteWarningDiv && deleteWarningDiv.contains(event.target); if (removeConfirm && !isClickOnRemoveButton && !isClickOnDeleteWarning) { if (deleteWarningDiv && deleteWarningDiv.dataset.beforeConfirmText) { deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.beforeConfirmText; } resetRemoveMode(); } }, true); 
    if (historyToggleButton) { historyToggleButton.addEventListener('click', () => { playSound('click-sound'); switchToHistoryView(); }); } else { console.warn("#history-toggle-btn nije pronađen."); }
    if (backToScannerButton) { backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); }); } else { console.warn("#back-to-scanner-btn nije pronađen."); }
    if (navigator.share) { if (shareButton) { shareButton.style.display = 'block'; shareButton.addEventListener('click', async () => { if (removeConfirm) resetRemoveMode(); try { await navigator.share({ title: 'QR SKENER-KALKULATOR', text: 'Skenira i zbraja račune...', url: window.location.href }); } catch (err) { if (err.name !== 'AbortError') console.error('Greška dijeljenja:', err); } }); } } else { if(shareButton) shareButton.style.display = 'none'; }
    function handleVisibilityChange() { if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) { console.log("Vis: Stranica vidljiva..."); if (!isScannerActive) initializeScanner(); } else if (document.visibilityState === 'hidden') { console.log("Vis: Stranica skrivena..."); stopScanner(); } }
    function attachVisibilityListener() { if (visibilityListenerAttached) return; console.log("Attaching visibility listener."); document.addEventListener("visibilitychange", handleVisibilityChange); visibilityListenerAttached = true; }
    document.addEventListener('DOMContentLoaded', () => { console.log("DOM spreman..."); loadHistoryFromLocalStorage(); console.log("Provjeravam inicijalni view..."); if (document.body.classList.contains('scanner-view')) { console.log("Init: Scanner view, pokrećem skener..."); initializeScanner(); } else { console.log("Init: History view, renderiram povijest..."); renderHistoryView(); attachVisibilityListener(); } console.log("Init: update displaya..."); updateDisplay(); });
  </script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>

</body>
</html>
