<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>QR Kalkulator</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: black;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #cameraView {
      width: 100%;
      height: 50vh;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #raText, #ukupnoText {
      position: absolute;
      bottom: 10px;
      font-size: 20px;
      font-weight: bold;
    }

    #raText { left: 10px; }
    #ukupnoText { right: 10px; }

    #output {
      font-size: 24px;
      margin: 10px;
    }

    #history {
      width: 90%;
      max-height: 200px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    #history ul {
      padding: 0;
      list-style: none;
    }

    #controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    #addBtn { background: green; color: white; }
    #clearLastBtn { background: red; color: yellow; }
    #clearAllBtn { background: grey; color: white; }
    #clearLastBtn.confirm { background: yellow; color: red; }

    #amountLabel {
      margin-bottom: 5px;
      font-size: 16px;
      color: yellow;
    }
  </style>
</head>
<body>

  <div id="cameraView">
    <div id="raText">RAČUNI</div>
    <div id="ukupnoText">UKUPNO</div>
  </div>

  <div id="output">Ukupno: 0.00 €</div>

  <div id="amountLabel"></div>

  <div id="controls">
    <button id="addBtn" style="display: none;">DODAJ</button>
    <button id="clearLastBtn" style="display: none;">OBRIŠI IZNOS</button>
    <button id="clearAllBtn">OBRIŠI SVE</button>
  </div>

  <div id="history"><ul id="historyList"></ul></div>

  <script>
    let total = 0;
    let currentAmount = 0;
    let currentQRCode = '';
    let povijest = [];
    let removeConfirm = false;

    const output = document.getElementById("output");
    const addBtn = document.getElementById("addBtn");
    const clearLastBtn = document.getElementById("clearLastBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const historyList = document.getElementById("historyList");
    const amountLabel = document.getElementById("amountLabel");

    // Funkcija za obradu QR skena (simulirano s URL parametrima)
    function handleScan(qrString) {
      const urlParams = new URLSearchParams(qrString.split('?')[1]);
      const iznos = urlParams.get('izn');
      const datv = urlParams.get('datv');

      if (iznos) {
        currentAmount = parseFloat(iznos.replace(',', '.'));
        currentQRCode = qrString;

        let vrijeme = '';
        if (datv && datv.includes('_')) {
          const parts = datv.split('_')[1]; // npr. 1310
          const sati = parts.substring(0, 2);
          const minute = parts.substring(2, 4);
          vrijeme = `${sati}:${minute}`;
        }

        povijest.push({ amount: currentAmount, qrCode: currentQRCode, time: vrijeme });

        total += currentAmount;
        updateOutput();
        updateHistory();
        handleAmountLabelVisibility();

        playSound();
      }
    }

    function updateOutput() {
      output.innerText = `Ukupno: ${total.toFixed(2)} €`;
    }

    function updateHistory() {
      historyList.innerHTML = '';
      povijest.forEach((item, index) => {
        const listItem = document.createElement('li');
        listItem.innerText = `${index + 1}.  ${item.amount.toFixed(2)} € (${item.time})`;
        historyList.appendChild(listItem);
      });
    }

    function handleAmountLabelVisibility() {
      if (povijest.length > 0) {
        const zadnji = povijest[povijest.length - 1];
        amountLabel.innerText = `OBRIŠI IZNOS: ${zadnji.amount.toFixed(2)} € (${zadnji.time})`;
        clearLastBtn.style.display = "inline-block";
      } else {
        amountLabel.innerText = '';
        clearLastBtn.style.display = "none";
      }

      if (currentAmount > 0) {
        addBtn.style.display = "inline-block";
      } else {
        addBtn.style.display = "none";
      }
    }

    function playSound() {
      const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
      audio.play();
    }

    addBtn.addEventListener("click", () => {
      currentAmount = 0;
      currentQRCode = '';
      addBtn.style.display = "none";
      handleAmountLabelVisibility();
    });

    clearLastBtn.addEventListener("click", () => {
      if (!removeConfirm) {
        clearLastBtn.classList.add("confirm");
        removeConfirm = true;
        setTimeout(() => {
          clearLastBtn.classList.remove("confirm");
          removeConfirm = false;
        }, 3000);
      } else {
        const removed = povijest.pop();
        total -= removed.amount;
        updateOutput();
        updateHistory();
        removeConfirm = false;
        clearLastBtn.classList.remove("confirm");
        handleAmountLabelVisibility();
      }
    });

    clearAllBtn.addEventListener("click", () => {
      if (confirm("Želite li obrisati sve unose?")) {
        povijest = [];
        total = 0;
        updateOutput();
        updateHistory();
        handleAmountLabelVisibility();
      }
    });

    // Simulacija QR skena — testiraj zamjenom ovog stringa
    const testQR = "https://some.url?izn=12.50&datv=20250408_1535";
    handleScan(testQR); // pokreće jedan testni unos
  </script>
</body>
</html>
