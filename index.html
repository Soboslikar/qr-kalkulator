
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR RAČUNATOR</title>
  <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
  <meta property="og:title" content="QR RAČUNATOR" />
  <meta property="og:description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu."/>
  <meta name="description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu.">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://soboslikar.github.io/QR-RACUNATOR/" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* CSS (Sve prethodno + NOVI STILOVI ZA OGLASE) */
    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }
    body.scanner-view #history-page, body.scanner-view #ads-page { display: none; }
    body.history-view { background-color: white; }
    /* IZMJENA: Pozadina stranice s oglasima je sada tamno plava */
    body.ads-view { background-color: #00008B; }

    /* Osigurava da history-page i ads-page zauzimaju cijelu visinu */
    body.history-view #history-page, body.ads-view #ads-page {
        display: flex;
        flex-direction: column;
        padding: 0;
        min-height: calc(100vh - 1em);
        max-height: calc(100vh - 1em);
        box-sizing: border-box;
        overflow: hidden;
    }

    /* Sakrij SVE elemente skenera kad smo u history ili ads view */
    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,
    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay,
    body.history-view #manual-entry-modal-overlay,
    body.ads-view #header, body.ads-view #scan-instruction, body.ads-view #reader, body.ads-view #loaded-message, body.ads-view #duplicate-warning, body.ads-view #total-container, body.ads-view #session-name-container, body.ads-view #invoice-count, body.ads-view #history, body.ads-view #remove-from-list-btn, body.ads-view #history-toggle-btn, body.ads-view #share-button, body.ads-view #delete-warning, body.ads-view #running-text-container, body.ads-view #share-prompt-overlay, body.ads-view #counter-deactivated-indicator,
    body.ads-view #switch-camera-btn, body.ads-view #camera-selection-overlay,
    body.ads-view #manual-entry-modal-overlay
    {
        display: none !important;
    }

    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }
    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }
    
    #total-container { position: fixed; top: 23.5em; left: 50%; transform: translateX(-50%); z-index: 6; display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }
    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    
    #ads-button {
        background-color: #1e7e34;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        padding: 0.6em 1.2em;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        animation: pulse-ads 1.5s ease-in-out infinite;
        display: none;
        white-space: nowrap;
    }
    #ads-button:active {
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        animation: none;
    }
    @keyframes pulse-ads {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }
    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    #ocisti-button.confirm-mode { background-color: yellow; color: black; }

    #session-name-container { position: fixed; top: 27.5em; left: 50%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; width: 95%; max-width: 400px; justify-content: space-between; min-height: 35px; text-align: center; margin-top: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; gap: 15px; }
    #session-name-wrapper { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; flex-shrink: 0; font-weight: bold; white-space: nowrap; }
    #session-name-input { font-size: 1.2em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 4px; width: 100%; display: none; box-sizing: border-box; flex-grow: 1; }
    #session-name-display { font-size: 1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; flex-grow: 1; min-width: 50px; text-align: left; box-sizing: border-box; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; flex-shrink: 0; }
    #manual-entry-btn { background-color: orange; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; line-height: 1.3; flex-shrink: 0; min-width: 90px; white-space: nowrap; margin-right: 5px; }
    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }
    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,4,8,0.2); }
    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }
    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }
    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    #history li:last-child { border-bottom: none; }
    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    .red-btn { background: #ff0000; color: yellow; }
    .yellow-btn { background-color: yellow; color: black; }
    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }
    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }
    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }
    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }
    #history-page, #ads-page { display: none; }

    /* STICKY HEADER STYLES (za History i Ads) */
    #history-sticky-header, #ads-sticky-header { position: sticky; top: 0; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    /* IZMJENA: Boja podloge headera za oglase */
    #history-sticky-header { background-color: white; }
    #ads-sticky-header { background-color: #f9f9f9; }

    #history-header, #ads-header { display: flex; align-items: center; justify-content: space-between; }
    #history-header h1, #ads-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-btn, #back-to-scanner-from-ads-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #back-to-scanner-btn:active, #back-to-scanner-from-ads-btn:active { background-color: darkgreen; }

    /* Sadržaj koji se skrola (za History i Ads) */
    #history-content, #ads-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }

    /* STILOVI ZA STRANICU S OGLASIMA */
    .ad-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: #f9f9f9;
    }
    .ad-title {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
    }
    .ad-image-link {
        display: block;
        margin-bottom: 10px;
        cursor: pointer;
    }
    .ad-image {
        width: 100%;
        height: auto;
        border-radius: 5px;
        display: block;
    }
    .ad-text {
        font-size: 1em;
        margin-bottom: 15px;
        line-height: 1.4;
    }
    .ad-contact {
        font-weight: bold;
        text-align: center;
        font-size: 1.1em;
    }
    #ads-footer-promo {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
        background-color: #f0f0f0;
        border-radius: 5px;
    }

    /* Ostali stilovi za povijest... */
     #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }
     #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
     #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }
     .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }
     .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
     .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }
     #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }
     #detail-scan-list { list-style: none; padding: 0; margin: 0; }
     #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}
     #detail-scan-list li:last-child { border-bottom: none; }
     #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }
     #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }
     #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }
     #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }
     #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }
     #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }
     #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }
     #all-days-list-rendered li:hover { background-color: #e0e0e0; }
     #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }
     #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }
     #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }
     #detail-summary-info { border-top: none; }
     #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }
     #search-container { display: none; border-bottom: 1px solid #eee; }
     #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }
     #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 25s linear infinite; white-space: pre; }
     @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
     #share-prompt-overlay { position: absolute; top: 7em; left: 50%; transform: translateX(-50%); width: 60%; height: auto; background-color: rgba(0, 0, 0, 0.75); color: lightgreen; font-size: 1.3em; font-weight: bold; text-align: center; padding: 1.5em 1em; border-radius: 10px; z-index: 4; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.3); line-height: 1.4; align-items: center; justify-content: center; }
     #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
     #switch-camera-btn { position: fixed; top: 10px; right: 10px; z-index: 5; padding: 6px 8px; background-color: #007bff; color: white; border: none; border-radius: 50%; font-size: 1.4em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; }
     #switch-camera-btn:active { background-color: rgba(0, 0, 0, 0.7); }
     #camera-selection-overlay { position: fixed; top: 55px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 6; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 150px; }
     #camera-list { list-style: none; padding: 0; margin: 0; }
     #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
     #camera-list li:hover { background-color: #f0f0f0; }
     #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }
     #manual-entry-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
     #manual-entry-modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-width: 90%; width: 300px; text-align: center; }
     #manual-entry-modal-content input[type="text"] { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
     #manual-entry-modal-content label { display: block; margin-bottom: 5px; font-weight: bold; text-align: left; }
     #manual-entry-modal-content div { margin-bottom: 15px; text-align: left; }
     #manual-entry-modal-content div:last-child { margin-bottom: 0; text-align: center; }
     #manual-entry-modal-content button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
     #manual-entry-modal-content button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
     #manual-entry-modal-content button#manual-add-btn { background-color: green; color: white; }
     #manual-entry-modal-content button#manual-cancel-btn { background-color: #dc3545; color: white; }
     #manual-entry-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }
     #import-file-input { display: none; }
     @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
     @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
  </style>
</head>
<body class="scanner-view">

  <div id="counter-deactivated-indicator" style="display: none;">✔</div>
  <div id="header">QR Skener-Kalkulator</div>
  <div id="scan-instruction">Pozicioniraj qr kod unutar kvadrata kamere</div>
  <div id="running-text-container" style="display: none;"><span></span></div>
  <div id="share-prompt-overlay" style="display: none;">KLIKNI ZELENI GUMB<br>I PODIJELI RAČUNATOR<br>PORUKA ĆE NESTATI</div>

  <div id="reader"></div>

  <button id="switch-camera-btn" style="display: none;">🔄</button>
  <div id="camera-selection-overlay" style="display: none;">
      <ul id="camera-list"></ul>
  </div>

  <div id="loaded-message" style="display: none;">UČITANO</div>
  <div id="duplicate-warning" style="display: none;">TAJ RAČUN JE URAČUNAT</div>

  <div id="total-container">
      <div id="total">UKUPNO: 0.00 €</div>
      <button id="ads-button" style="display: none;"></button>
      <button id="ocisti-button" onclick="startOcistiConfirm()" style="display: none;">SPREMI<br>I OČISTI</button>
  </div>

  <div id="session-name-container">
      <div id="session-name-wrapper">
          <button id="add-name-btn" onclick="startAddName()">DODAJ NAZIV</button>
          <input type="text" id="session-name-input" placeholder="Unesi naziv sesije..." maxlength="30">
          <span id="session-name-display">
              <span id="session-name-text"></span>
              <span class="edit-icon" onclick="startAddName()">Uredi</span>
          </span>
      </div>
      <button id="manual-entry-btn">SAM UPIŠI RAČ:</button>
  </div>

  <div id="invoice-count">0 RAČUNA</div>
  <div id="history" style="display: none;"> <ul id="historyList"></ul> </div>
  <button class="red-btn" id="remove-from-list-btn" onclick="startRemoveFromList()" style="display:none;">Obriši iz liste</button>
  <button id="history-toggle-btn">POVIJEST</button>
  <button id="share-button" style="display: none;">DIJELI RAČUNATOR</button>
  <div id="delete-warning" style="display: none;"></div>

  <div id="history-page">
      <div id="history-sticky-header">
          <div id="history-header"> <button id="back-to-scanner-btn">< NA SKENER</button> <h1>POVIJEST</h1> </div>
          <div id="history-dynamic-header-content"></div>
      </div>
      <div id="history-content"></div>
  </div>

  <div id="ads-page">
      <div id="ads-sticky-header">
          <div id="ads-header">
              <button id="back-to-scanner-from-ads-btn">< NA SKENER</button>
              <h1>PONUDE</h1>
          </div>
      </div>
      <div id="ads-content"></div>
  </div>

  <div id="manual-entry-modal-overlay" style="display: none;">
      <div id="manual-entry-modal-content">
          <h3 style="margin-top: 0; color: #333;">Ručni unos računa</h3>
          <div style="margin-bottom: 15px;">
              <label for="manual-amount-input">Iznos (€):</label>
              <input type="text" id="manual-amount-input" placeholder="npr. 15,99 ili 25.00">
          </div>
          <div style="margin-bottom: 20px;">
              <label for="manual-time-input">Vrijeme (HH:MM - opcionalno):</label>
              <input type="text" id="manual-time-input" placeholder="npr. 14:35" pattern="^([0-1]?\d|2[0-3]):([0-5]?\d)$">
          </div>
          <div style="display: flex; justify-content: space-around; gap: 10px;">
              <button id="manual-add-btn">Dodaj račun</button>
              <button id="manual-cancel-btn">Odustani</button>
          </div>
           <p id="manual-entry-error" style="color: red; font-size: 0.9em; margin-top: 10px; display: none;"></p>
      </div>
  </div>

  <input type="file" id="import-file-input" accept=".json">

  <audio id="scan-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/novo2.mp3" preload="auto"></audio>
  <audio id="click-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/click8.mp3" preload="auto"></audio>
  <audio id="remove-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/smeče.mp3" preload="auto"></audio>
  <audio id="error-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/error.mp3" preload="auto"></audio>
  <audio id="clear-session-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/Čiščenje.mp3" preload="auto"></audio>

<script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMqcnA/exec';
    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID';
    const SECONDS_PER_CHARACTER = 0.2;
    const MIN_MARQUEE_DURATION = 5;
    const MAX_MARQUEE_DURATION = 40;
    const USER_ID_KEY = 'qrCalculatorUserID';
    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';
    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';
    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';
    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';
    const COUNTER_KEY = 'qrCalculatorCounter';
    const COUNTER2_KEY = 'qrCalculatorCounter2';
    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';

    let ukupno = 0;
    let povijest = [];
    let removeConfirm = false;
    let ocistiConfirm = false;
    const removeBtnInitialText = 'Obriši iz liste';
    const ocistiBtnInitialText = 'SPREMI<br>I OČISTI';
    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';
    let html5QrCodeInstance = null;
    let isScannerActive = false;
    let availableCameras = [];
    let visibilityListenerAttached = false;
    let currentSessionName = null;
    let removeNameConfirm = false;
    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
    let previousHistoryViewState = 'day-view';
    let lastSearchTerm = '';
    let brojac = 0;
    let brojac2 = 0;
    let tekstPoruka = "";
    let isCounterDecrementActive = true;
    let currentUserID = null;
    let firstUseTimestamp = null;
    let adsConfiguration = { enabled: false, buttonText: "", adsList: [] };
    let adsFooterText = ""; // NOVA VARIJABLA

    // DOM Elementi
    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;
    let switchCameraButton, cameraSelectionOverlay, cameraListUl;
    let manualEntryBtn, manualEntryModalOverlay, manualAmountInput, manualTimeInput, manualAddBtn, manualCancelBtn, manualEntryErrorMsg;
    let importFileInput;
    let adsButton, adsPageDiv, adsContentDiv, backToScannerFromAdsButton;

    let errorSoundCooldown = false;
    let ignoreErrorSoundUntil = 0;
    let messageTimeoutId = null;
    let ignoreDuplicateLogUntil = 0;
    const DUPLICATE_LOG_COOLDOWN = 5000;

    const parseTime = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1; return hours * 60 + minutes; };
    function normalizeDateForSearch(input) { if (!input || typeof input !== 'string') { return null; } const term = input.trim(); const isoMatch = term.match(/^(\d{4})-(\d{2})-(\d{2})$/); if (isoMatch) { const year = parseInt(isoMatch[1], 10); const month = parseInt(isoMatch[2], 10) - 1; const day = parseInt(isoMatch[3], 10); const date = new Date(year, month, day); if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) { return getISODateString(date); } } const dotSlashMatch = term.match(/^(\d{1,2})[.\/](\d{1,2})[.\/]((\d{4})|(\d{2}))$/); if (dotSlashMatch) { const day = parseInt(dotSlashMatch[1], 10); const month = parseInt(dotSlashMatch[2], 10) - 1; let year = parseInt(dotSlashMatch[4] || dotSlashMatch[5], 10); if (year < 100) { year += 2000; } const date = new Date(year, month, day); if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day && !isNaN(date.getTime())) { return getISODateString(date); } } return null; }
    function playSound(id) { if (id === 'error-sound') { if (errorSoundCooldown) { return; } errorSoundCooldown = true; setTimeout(() => { errorSoundCooldown = false; }, 500); } const sound = document.getElementById(id); if (sound) { sound.pause(); sound.currentTime = 0; sound.play().catch(error => { if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') { console.warn(`Zvuk "${id}" greška:`, error); } }); } else { console.warn(`Audio element "${id}" nije pronađen.`); } }
    function showTemporaryMessage(messageElement, messageText, duration = 1500) { if (!messageElement) return; if (messageTimeoutId) { clearTimeout(messageTimeoutId); messageTimeoutId = null; } messageElement.innerText = messageText; messageElement.style.display = 'block'; messageElement.style.animation = 'none'; requestAnimationFrame(() => { messageElement.offsetHeight; if (messageElement.id === 'loaded-message') { messageElement.style.animation = 'zoomFade 1s ease-out'; } }); messageTimeoutId = setTimeout(() => { if (messageElement && messageElement.innerText === messageText) { messageElement.style.display = 'none'; messageTimeoutId = null; } }, duration); }
    function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error("getISODateString primio neispravan datum:", date); return null; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
    function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    function initializeUserTracking() { currentUserID = localStorage.getItem(USER_ID_KEY); firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY); if (!currentUserID) { console.log("Generiram novi UserID i FirstUseTimestamp."); currentUserID = generateUUID(); firstUseTimestamp = new Date().toISOString(); try { localStorage.setItem(USER_ID_KEY, currentUserID); localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp); } catch (error) { console.error("Greška spremanja UserID/FirstUse u localStorage:", error); currentUserID = 'localStorage_error_' + generateUUID(); firstUseTimestamp = new Date().toISOString(); } } console.log("UserID:", currentUserID, "FirstUse:", firstUseTimestamp); }
    async function sendLogData(eventData) { if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) { console.warn("Logovanje onemogućeno: APPS_SCRIPT_URL nije postavljen ili je neispravan."); return; } const dataToSend = { ...eventData, UserID: currentUserID, FirstUseTimestamp: firstUseTimestamp, Timestamp: new Date().toISOString(), Counter1: brojac, Counter2: brojac2, Active: isCounterDecrementActive, UserAgent: navigator.userAgent }; console.log(`Pokušavam poslati log '${dataToSend.Event}'...`); try { const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: {'Content-Type': 'application/json'}, redirect: 'follow', body: JSON.stringify(dataToSend) }); console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors).`); } catch (error) { console.error(`Greška prilikom slanja loga '${dataToSend.Event}':`, error); } }
    function saveFullHistoryToLocalStorage(fullHistory) { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory)); console.log("Puna povijest spremljena."); } catch (error) { console.error("Greška spremanja:", error); alert("Greška: Nije moguće spremiti povijest."); } }
    function loadFullHistoryFromLocalStorage() { try { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); if (historyJson) { const loadedHistory = JSON.parse(historyJson); return loadedHistory.map(group => ({ timestamp: group.timestamp || Date.now(), lastQrTime: group.lastQrTime || '??:??', name: group.name || null, racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({ ...item, scanTimestamp: item.scanTimestamp || 0 })) : [] })); } return []; } catch (error) { console.error("Greška učitavanja:", error); return []; } }
    function loadCountersState() { const storedBrojac = localStorage.getItem(COUNTER_KEY); const storedBrojac2 = localStorage.getItem(COUNTER2_KEY); const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY); brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 0) : 0; isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; if (isNaN(brojac)) brojac = null; if (isNaN(brojac2)) brojac2 = 0; console.log("Učitano stanje:", { brojac, brojac2, isCounterDecrementActive }); updateDeactivatedIndicator(); }
    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }
    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }
    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }
    async function fetchSheetData() {
        console.log("Pokušavam dohvatiti podatke iz Google Sheeta...");
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) {
            console.warn("Dohvaćanje iz Sheeta onemogućeno.");
            tekstPoruka = "";
            adsConfiguration = { enabled: false, buttonText: "", adsList: [] };
            adsFooterText = "";
            initializeCounters();
            updateRunningText();
            updateAdsButtonVisibility();
            return Promise.reject(new Error("URL za Sheet nije postavljen/ispravan"));
        }
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) { throw new Error(`HTTP greška ${response.status}`); }
            const data = await response.json();
            console.log("Podaci dohvaćeni:", data);
            let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 0;
            if (isNaN(newPrag) || newPrag < 0) { newPrag = 0; } else if (newPrag > 500) { newPrag = 500; }
            brojac2 = newPrag;
            saveBrojac2();
            tekstPoruka = data.trceciTekst || "";
            adsConfiguration = data.adsConfig || { enabled: false, buttonText: "", adsList: [] };
            adsFooterText = data.adsFooterText || "";
            initializeCounters();
            updateRunningText();
            updateAdsButtonVisibility();
            return Promise.resolve();
        } catch (error) {
            console.error("Greška pri dohvaćanju podataka iz Sheeta:", error);
            tekstPoruka = "";
            adsConfiguration = { enabled: false, buttonText: "", adsList: [] };
            adsFooterText = "";
            initializeCounters();
            updateRunningText();
            updateAdsButtonVisibility();
            return Promise.reject(error);
        }
    }
    function initializeCounters() { console.log("Inicijalizacija brojača..."); if (brojac === null) { console.log("Brojač 1 nije inicijaliziran, postavljanje na brojač 2."); brojac = brojac2; saveBrojac(); } else { console.log("Brojač 1 učitan s vrijednošću:", brojac); } checkSharePrompt(); updateRunningTextVisibility(); }
    function checkOcistiButtonVisibility() { if (!ocistiButton) return; ocistiButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if ((povijest.length === 0 && !currentSessionName) && ocistiConfirm) { resetOcistiMode(); } }
    function updateDisplay() { if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} €`; const count = povijest.length; if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAČUN' : 'RAČUNA'}`; if (document.body.classList.contains('scanner-view')) { updateSmallHistoryList(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); checkOcistiButtonVisibility(); updateNameDisplay(); updateAdsButtonVisibility(); } };
    function updateAdsButtonVisibility() { if (!adsButton || !totalDiv) return; const shouldShowAds = adsConfiguration.enabled && adsConfiguration.adsList && adsConfiguration.adsList.length > 0 && ukupno === 0 && povijest.length === 0; if (shouldShowAds) { adsButton.innerText = adsConfiguration.buttonText || "POGLEDAJ PONUDE"; adsButton.style.display = 'block'; totalDiv.style.display = 'none'; } else { adsButton.style.display = 'none'; totalDiv.style.display = 'block'; } }
    function updateSmallHistoryList() { if (!historyList || !historyDiv) return; if (povijest.length > 0) { historyDiv.style.display = 'block'; historyList.innerHTML = ''; const recentHistory = povijest; recentHistory.forEach((item, index) => { const globalIndex = povijest.length - recentHistory.length + index; const listItem = document.createElement('li'); listItem.innerText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} €`; historyList.appendChild(listItem); }); historyDiv.scrollTop = historyDiv.scrollHeight; } else { historyDiv.style.display = 'none'; } }
    function checkRemoveButtonVisibility() { if (!removeButton) return; removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if (povijest.length === 0 && !currentSessionName && (removeConfirm || removeNameConfirm)) resetRemoveMode(); }
    function handleInfoDeleteMessageVisibility() { const isScannerView = document.body.classList.contains('scanner-view'); if (!deleteWarningDiv || !isScannerView) { if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; return; } let shouldDisplay = false, textToShow = '', modeClass = ''; if (removeConfirm && povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; textToShow = `OBRIŠI ${lastItem.time} = ${lastItem.amount.toFixed(2)} €?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (removeNameConfirm && currentSessionName) { textToShow = `OBRIŠI NAZIV "${currentSessionName}"?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) { textToShow = deleteWarningDiv.dataset.lastScanText; modeClass = 'info-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length === 0 && currentSessionName && deleteWarningDiv.dataset.lastNameText) { textToShow = deleteWarningDiv.dataset.lastNameText; modeClass = 'info-mode'; shouldDisplay = true; } if (shouldDisplay) { deleteWarningDiv.innerText = textToShow; deleteWarningDiv.className = `delete-warning ${modeClass}`; deleteWarningDiv.style.display = 'block'; } else { deleteWarningDiv.style.display = 'none'; } }
    function updateRunningText() { if (runningTextSpan) { runningTextSpan.textContent = tekstPoruka; if (tekstPoruka && tekstPoruka.length > 0) { const textLength = tekstPoruka.length; let duration = textLength * SECONDS_PER_CHARACTER; duration = Math.max(MIN_MARQUEE_DURATION, Math.min(MAX_MARQUEE_DURATION, duration)); duration = Math.max(duration, 0.1); runningTextSpan.style.animation = 'none'; requestAnimationFrame(() => { runningTextSpan.offsetHeight; runningTextSpan.style.animation = `marquee ${duration}s linear infinite`; }); } else { runningTextSpan.style.animation = 'none'; } } updateRunningTextVisibility(); }
    function updateRunningTextVisibility() { const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex'; const shouldShowText = tekstPoruka && (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && !isManualEntryModalOpen && document.body.classList.contains('scanner-view'); if (runningTextContainer) { runningTextContainer.style.display = shouldShowText ? 'block' : 'none'; } }
    function checkSharePrompt() { const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex'; const shouldShowPrompt = brojac === 0 && brojac2 > 0 && !isManualEntryModalOpen && document.body.classList.contains('scanner-view'); if (sharePromptOverlay) { sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none'; updateRunningTextVisibility(); } }
    function updateDeactivatedIndicator() { const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex'; if (counterDeactivatedIndicator) { counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view') && !isManualEntryModalOpen) ? 'block' : 'none'; } }
    function resetRemoveMode() { if (!removeButton) return; removeButton.innerText = removeBtnInitialText; removeButton.classList.remove('yellow-btn'); removeButton.classList.add('red-btn'); removeConfirm = false; removeNameConfirm = false; if (deleteWarningDiv) { if (deleteWarningDiv.dataset.beforeConfirmText) { deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.beforeConfirmText; } else if (deleteWarningDiv.dataset.beforeConfirmNameText) { deleteWarningDiv.dataset.lastNameText = deleteWarningDiv.dataset.beforeConfirmNameText; delete deleteWarningDiv.dataset.beforeConfirmNameText; } else if (povijest.length === 0 && !currentSessionName) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.lastNameText; } } handleInfoDeleteMessageVisibility(); checkRemoveButtonVisibility(); }
    function resetOcistiMode() { if (!ocistiButton) return; ocistiButton.innerHTML = ocistiBtnInitialText; ocistiButton.classList.remove('confirm-mode'); ocistiConfirm = false; checkOcistiButtonVisibility(); }
    function startAddName() { if (!addNameBtn || !sessionNameInput || !sessionNameDisplay || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } playSound('click-sound'); addNameBtn.style.display = 'none'; sessionNameDisplay.style.display = 'none'; sessionNameInput.style.display = 'block'; sessionNameInput.value = currentSessionName || ''; sessionNameInput.focus(); sessionNameInput.select(); }
    function saveName() { if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (sessionNameInput.style.display === 'none') { return; } const inputText = sessionNameInput.value.trim(); if (inputText === "##--##") { showTemporaryMessage(loadedMsg, "RJEŠENO"); isCounterDecrementActive = false; saveCounterActiveState(); updateDeactivatedIndicator(); sessionNameInput.value = ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); checkRemoveButtonVisibility(); if(removeNameConfirm) resetRemoveMode(); sendLogData({ Event: 'cheat_code_deactivate', Details: '##--##' }); return; } else if (inputText === "##00##") { showTemporaryMessage(loadedMsg, "RESETIRANO"); brojac = 0; brojac2 = 0; isCounterDecrementActive = true; saveBrojac(); saveBrojac2(); saveCounterActiveState(); localStorage.removeItem(CAMERA_ID_KEY); updateDeactivatedIndicator(); sessionNameInput.value = ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); checkSharePrompt(); updateRunningTextVisibility(); checkRemoveButtonVisibility(); if(removeNameConfirm) resetRemoveMode(); sendLogData({ Event: 'cheat_code_reset', Details: '##00##' }); return; } const newName = inputText; const oldName = currentSessionName; currentSessionName = newName || null; if (deleteWarningDiv) { if (currentSessionName) { deleteWarningDiv.dataset.lastNameText = `NAZIV: "${currentSessionName}"`; } else { delete deleteWarningDiv.dataset.lastNameText; } } if (oldName !== currentSessionName) { sendLogData({ Event: 'session_name_changed', Details: currentSessionName || 'removed' }); } sessionNameInput.style.display = 'none'; updateNameDisplay(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); }
    function updateNameDisplay() { if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (currentSessionName) { sessionNameText.textContent = currentSessionName; sessionNameDisplay.style.display = 'flex'; addNameBtn.style.display = 'none'; } else { sessionNameDisplay.style.display = 'none'; addNameBtn.style.display = 'block'; } }
    function startRemoveFromList() { if (!removeButton || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (removeNameConfirm) { playSound('remove-sound'); const oldName = currentSessionName; currentSessionName = null; if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastNameText; resetRemoveMode(); updateNameDisplay(); checkRemoveButtonVisibility(); sendLogData({ Event: 'session_name_removed_confirmed', Details: oldName || 'N/A' }); return; } if (removeConfirm) { if (povijest.length > 0) { const removed = povijest.pop(); ukupno -= removed.amount; playSound('remove-sound'); const removedDetails = { amount: removed.amount, time: removed.time, isManual: removed.qrCode.startsWith('MANUAL_') }; sendLogData({ Event: 'last_invoice_removed_confirmed', Details: JSON.stringify(removedDetails) }); if (povijest.length === 0 && currentSessionName) { removeButton.innerHTML = 'Obriši<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; } handleInfoDeleteMessageVisibility(); } else { if (povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} €`; } else { if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; } resetRemoveMode(); } } else { resetRemoveMode(); console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva."); } updateDisplay(); return; } if (povijest.length > 0) { playSound('click-sound'); removeButton.innerText = 'Potvrdi'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = true; removeNameConfirm = false; if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; handleInfoDeleteMessageVisibility(); sendLogData({ Event: 'last_invoice_remove_prompt' }); } else if (currentSessionName) { playSound('click-sound'); removeButton.innerHTML = 'Obriši<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; handleInfoDeleteMessageVisibility(); sendLogData({ Event: 'session_name_remove_prompt' }); } else { resetRemoveMode(); console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva."); } }
    function startOcistiConfirm() { if (!ocistiButton || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (!ocistiConfirm) { ocistiButton.innerHTML = ocistiConfirmText; ocistiButton.classList.add('confirm-mode'); ocistiConfirm = true; sendLogData({ Event: 'save_session_prompt' }); } else { ocistiTrenutnoSkeniranje(); resetOcistiMode(); playSound('clear-session-sound'); } }
    function ocistiTrenutnoSkeniranje() { if (povijest.length === 0 && !currentSessionName) { console.warn("Pokušaj spremanja prazne sesije."); return; } const vrijemeCiscenja = Date.now(); const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => { const timeA = parseTime(a.time); const timeB = parseTime(b.time); if (timeA === -1 && timeB !== -1) return -1; if (timeA !== -1 && timeB === -1) return 1; if (timeA === -1 && timeB === -1) return (a.scanTimestamp || 0) - (b.scanTimestamp || 0); return timeA - timeB; }); let zadnjeValidnoVrijemeIzSortiraneListe = '??:??'; for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) { if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') { zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time; break; } } const novaGrupa = { timestamp: vrijemeCiscenja, lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe, name: currentSessionName || null, racuni: sortiraniRacuniZaSpremanje }; console.log("Spremam sesiju:", novaGrupa); let punaPovijest = loadFullHistoryFromLocalStorage(); punaPovijest.push(novaGrupa); saveFullHistoryToLocalStorage(punaPovijest); const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0); const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime }; const eventData = { Event: 'session_saved', Details: JSON.stringify(sessionDetails) }; sendLogData(eventData); try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); console.log("Obrisano nesačuvano stanje nakon spremanja sesije."); } catch (lsError) { console.error("Greška brisanja nesačuvanog stanja u localStorage:", lsError); } povijest = []; ukupno = 0; currentSessionName = null; if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.lastNameText; delete deleteWarningDiv.dataset.beforeConfirmNameText; } resetRemoveMode(); updateDisplay(); console.log("Trenutna sesija spremljena i očišćena."); }
    function handleScan(decodedText) { if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (removeNameConfirm) resetRemoveMode(); if (removeConfirm) resetRemoveMode(); if (ocistiConfirm) resetOcistiMode(); if (duplicateWarning) duplicateWarning.style.display = 'none'; try { const qrParts = decodedText.split('?'); if (qrParts.length < 2) throw new Error("Invalid QR format"); const params = new URLSearchParams(qrParts[1]); const iznosCentStr = params.get('izn'); const datv = params.get('datv'); if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error("Invalid 'izn'"); const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText); let isDuplicateInRecentSaved = false; const fullHistory = loadFullHistoryFromLocalStorage(); if (fullHistory.length > 0) { const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000); const recentHistory = fullHistory.filter(grupa => grupa.timestamp >= thirtyDaysAgoTimestamp); isDuplicateInRecentSaved = recentHistory.some(grupa => grupa.racuni.some(item => item.qrCode === decodedText)); } if (isDuplicateInCurrent || isDuplicateInRecentSaved) { console.warn("Duplikat pronađen:", decodedText); if (Date.now() >= ignoreErrorSoundUntil) { playSound('error-sound'); showTemporaryMessage(duplicateWarning, "TAJ RAČUN JE URAČUNAT", 1500); if (Date.now() >= ignoreDuplicateLogUntil) { sendLogData({ Event: 'scan_duplicate' }); ignoreDuplicateLogUntil = Date.now() + DUPLICATE_LOG_COOLDOWN; console.log(`Duplicate log sent. Next duplicate log ignored until ${new Date(ignoreDuplicateLogUntil).toLocaleTimeString()}.`); } } return; } const iznosCenti = parseFloat(iznosCentStr); const iznosEura = iznosCenti / 100; let time = '??:??'; if (datv && typeof datv === 'string') { let hourStr = null, minuteStr = null; const underscoreIndex = datv.indexOf('_'); const tIndex = datv.toUpperCase().indexOf('T'); if (underscoreIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (tIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (datv.length === 12) { hourStr = datv.substring(8, 10); minuteStr = datv.substring(10, 12); } if (hourStr && minuteStr) { const hour = parseInt(hourStr, 10); const minute = parseInt(minuteStr, 10); if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; else time = '??:??'; } else time = '??:??'; } if (instructionDiv) instructionDiv.style.display = 'none'; const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() }; povijest.push(newItem); ukupno += iznosEura; if (isCounterDecrementActive && brojac > 0) { brojac--; console.log("Brojač smanjen na:", brojac); saveBrojac(); checkSharePrompt(); } try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Greška spremanja nesačuvanog stanja u localStorage:", lsError); } playSound('scan-sound'); ignoreErrorSoundUntil = Date.now() + 2000; updateDisplay(); showTemporaryMessage(loadedMsg, "UČITANO", 1000); if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`; handleInfoDeleteMessageVisibility(); } const scanDetails = { amount: newItem.amount, time: newItem.time, sessionInvoiceNumber: povijest.length }; sendLogData({ Event: 'scan_success', Details: JSON.stringify(scanDetails) }); } catch (error) { console.error("Greška obrade QR (parse error):", error, decodedText); if (Date.now() >= ignoreErrorSoundUntil) { playSound('error-sound'); showTemporaryMessage(loadedMsg, "GREŠKA SKENIRANJA!", 1500); } sendLogData({ Event: 'scan_parse_error', Details: { message: error.message, qrCodeStart: decodedText.substring(0, 50) + '...' } }); } }
    function isElementOrParentHidden(element) { if (!element) return true; while (element && element !== document.body) { if (window.getComputedStyle(element).display === 'none') return true; element = element.parentElement; } return false; }
    function startScannerWithCameraSelection(devices, qrConfig) { if (!devices || devices.length === 0) { if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Nema dostupnih kamera na uređaju.</div>'; console.warn("Nema dostupnih kamera za startanje skenera."); if (instructionDiv) instructionDiv.style.display = 'none'; if (switchCameraButton) switchCameraButton.style.display = 'none'; isScannerActive = false; html5QrCodeInstance = null; return; } let selectedCameraId = null; const savedCameraId = localStorage.getItem(CAMERA_ID_KEY); if (savedCameraId) { const cameraExists = devices.some(d => d.id === savedCameraId); if (cameraExists) { console.log("Koristim spremljenu kameru:", savedCameraId); selectedCameraId = savedCameraId; } else { console.warn("Spremljena kamera nije pronađena, brišem iz localStorage."); localStorage.removeItem(CAMERA_ID_KEY); } } if (!selectedCameraId) { const rearCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('zadnja') || d.label.toLowerCase().includes('environment')); if (rearCamera) { console.log("Koristim pronađenu stražnju kameru:", rearCamera.id); selectedCameraId = rearCamera.id; } else { console.log("Nema stražnje kamere, koristim prvu dostupnu:", devices[0].id); selectedCameraId = devices[0].id; } } if (!selectedCameraId && devices.length > 0) { selectedCameraId = devices[0].id; console.warn("Fallback na prvu kameru ID:", selectedCameraId); } if (!selectedCameraId) { console.error("Kritična greška: Nije bilo moguće odabrati kameru za start."); if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Greška: Nije moguće odabrati kameru.</div>'; if (instructionDiv) instructionDiv.style.display = 'none'; if (switchCameraButton) switchCameraButton.style.display = 'none'; isScannerActive = false; html5QrCodeInstance = null; return; } const finalCameraId = selectedCameraId; requestAnimationFrame(() => { if (!html5QrCodeInstance || isScannerActive || !document.body.classList.contains('scanner-view')) { return; } if (isElementOrParentHidden(readerDiv)) { if (readerDiv) readerDiv.innerHTML = '<div style="padding:20px; color: red;">Greška: Reader element je skriven.</div>'; console.error("[startScannerWithCameraSelection][rAF] Reader je skriven, ne mogu startati kameru."); isScannerActive = false; html5QrCodeInstance = null; return; } console.log(`[startScannerWithCameraSelection][rAF] Pokušavam startati kameru: ${finalCameraId}`); html5QrCodeInstance.start( finalCameraId, qrConfig, handleScan, (errorMessage) => { /* Ignoriraj */ } ).then(() => { console.log(`>>> [startScannerWithCameraSelection][rAF] start() OK za kameru: ${finalCameraId}`); isScannerActive = true; localStorage.setItem(CAMERA_ID_KEY, finalCameraId); console.log("Spremljen ID aktivne kamere u localStorage:", finalCameraId); if (switchCameraButton && availableCameras.length > 1) { switchCameraButton.style.display = 'block'; } setTimeout(() => { if (instructionDiv && document.body.classList.contains('scanner-view')) { instructionDiv.style.display = 'block'; } }, 50); }).catch(err => { console.error(`>>> [startScannerWithCameraSelection][rAF] start() FAILED za kameru ${finalCameraId}:`, err); isScannerActive = false; html5QrCodeInstance = null; if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Greška startanja kamere (${err.name || err.message || err}). Provjerite dozvole ili pokušajte odabrati drugu kameru.</div>`; if (instructionDiv) instructionDiv.style.display = 'none'; if (switchCameraButton && availableCameras.length > 1) { switchCameraButton.style.display = 'block'; } sendLogData({ Event: 'camera_start_failed', Details: { cameraId: finalCameraId, errorName: err.name, errorMessage: err.message } }); }); }); }
    function initializeScanner() { if (!document.body.classList.contains('scanner-view') || isScannerActive) { if (isScannerActive && document.body.classList.contains('scanner-view')) { if (switchCameraButton && availableCameras.length > 1) { switchCameraButton.style.display = 'block'; } } return; } console.log("[initializeScanner] Pokrećem..."); if (readerDiv) readerDiv.innerHTML = ''; if (instructionDiv) instructionDiv.style.display = 'none'; if (switchCameraButton) switchCameraButton.style.display = 'none'; if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; if (loadedMsg) loadedMsg.style.display = 'none'; if (duplicateWarning) duplicateWarning.style.display = 'none'; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { hideManualEntryModal(); } checkSharePrompt(); updateRunningTextVisibility(); updateDeactivatedIndicator(); html5QrCodeInstance = new Html5Qrcode("reader"); const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } }; if (availableCameras.length === 0) { console.log("[initializeScanner] Dohvaćam popis kamera prvi put..."); Html5Qrcode.getCameras().then(devices => { console.log("[initializeScanner] Dostupne kamere (inicijalno dohvatio):", devices); availableCameras = devices; startScannerWithCameraSelection(devices, qrConfig); }).catch(err => { console.error("[initializeScanner] Greška dohvaćanja kamera (getCameras failed):", err); isScannerActive = false; availableCameras = []; if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Greška pristupa kamerama (${err.name || err.message || err}). Provjerite dozvole.</div>`; if (instructionDiv) instructionDiv.style.display = 'none'; if (switchCameraButton) switchCameraButton.style.display = 'none'; html5QrCodeInstance = null; sendLogData({ Event: 'get_cameras_failed', Details: { errorName: err.name, errorMessage: err.message } }); }); } else { console.log("[initializeScanner] Koristim već dohvaćeni popis kamera:", availableCameras); startScannerWithCameraSelection(availableCameras, qrConfig); } };
    function stopScanner() { console.log("stopScanner: Pokrenuto."); if(runningTextContainer) runningTextContainer.style.display = 'none'; if(sharePromptOverlay) sharePromptOverlay.style.display = 'none'; if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none'; if(switchCameraButton) switchCameraButton.style.display = 'none'; if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; if(loadedMsg) loadedMsg.style.display = 'none'; if(duplicateWarning) duplicateWarning.style.display = 'none'; if(manualEntryModalOverlay) manualEntryModalOverlay.style.display = 'none'; const instanceToStop = html5QrCodeInstance; if (instanceToStop && isScannerActive) { console.log("Zaustavljam skener..."); isScannerActive = false; if (instructionDiv) instructionDiv.style.display = 'none'; const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for stop()")), 3000)); return Promise.race([instanceToStop.stop(), timeoutPromise]).then(() => { console.log("Skener uspješno zaustavljen."); }).catch(err => { console.warn("Greška ili timeout pri zaustavljanju skenera:", err); sendLogData({ Event: 'camera_stop_failed', Details: { errorName: err.name, errorMessage: err.message } }); }).finally(() => { if (readerDiv) readerDiv.innerHTML = ''; html5QrCodeInstance = null; }); } else { isScannerActive = false; if (readerDiv) readerDiv.innerHTML = ''; html5QrCodeInstance = null; return Promise.resolve(); } };
    function toggleCameraSelection() { playSound('click-sound'); if (!cameraSelectionOverlay || !cameraListUl || !switchCameraButton) { console.error("Nedostaju elementi za odabir kamere."); return; } if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (!availableCameras || availableCameras.length <= 1) { console.warn("Nema dostupnih kamera za odabir."); showTemporaryMessage(loadedMsg, "Nema drugih kamera za odabir.", 1500); cameraSelectionOverlay.style.display = 'none'; return; } if (cameraSelectionOverlay.style.display === 'block') { cameraSelectionOverlay.style.display = 'none'; return; } cameraListUl.innerHTML = ''; const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); availableCameras.forEach(device => { const listItem = document.createElement('li'); listItem.textContent = device.label || `Kamera ${device.id.substring(0, 8)}...`; listItem.dataset.cameraId = device.id; listItem.title = device.label || device.id; if (device.id === currentActiveCameraId) { listItem.classList.add('selected-camera'); } listItem.addEventListener('click', () => { switchCamera(device.id, device.label); }); cameraListUl.appendChild(listItem); }); cameraSelectionOverlay.style.display = 'block'; }
    function switchCamera(selectedCameraId, cameraLabel) { playSound('click-sound'); console.log(`Odabrana kamera: ID=${selectedCameraId}, Label=${cameraLabel || 'N/A'}`); if (cameraSelectionOverlay) { cameraSelectionOverlay.style.display = 'none'; } const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); if(selectedCameraId === currentActiveCameraId && isScannerActive) { console.log("Odabrana je već aktivna kamera."); showTemporaryMessage(loadedMsg, `Kamera: ${cameraLabel || 'Već aktivna'}`, 1500); sendLogData({ Event: 'camera_switch_selected_same', Details: { cameraId: selectedCameraId, label: cameraLabel } }); return; } localStorage.setItem(CAMERA_ID_KEY, selectedCameraId); sendLogData({ Event: 'camera_switch_attempt', Details: { cameraId: selectedCameraId, label: cameraLabel } }); showTemporaryMessage(loadedMsg, `Mijenjam na: ${cameraLabel || 'Kamera'}...`, 1000); stopScanner().finally(() => { console.log("Nakon stopScanner, pozivam initializeScanner za novu kameru."); initializeScanner(); }); }
    function showManualEntryModal() { if (!manualEntryBtn || !manualEntryModalOverlay || !manualAmountInput || !manualTimeInput || !manualEntryErrorMsg || !document.body.classList.contains('scanner-view')) { console.warn("Ne mogu prikazati modal za ručni unos."); return; } if (loadedMsg) loadedMsg.style.display = 'none'; if (duplicateWarning) duplicateWarning.style.display = 'none'; if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; updateRunningTextVisibility(); checkSharePrompt(); updateDeactivatedIndicator(); playSound('click-sound'); sendLogData({ Event: 'manual_entry_modal_opened' }); manualAmountInput.value = ''; manualTimeInput.value = ''; manualEntryErrorMsg.innerText = ''; manualEntryErrorMsg.style.display = 'none'; const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); manualTimeInput.value = `${hours}:${minutes}`; manualEntryModalOverlay.style.display = 'flex'; manualAmountInput.focus(); }
    function hideManualEntryModal() { if (!manualEntryModalOverlay) return; manualEntryModalOverlay.style.display = 'none'; manualAmountInput.value = ''; manualTimeInput.value = ''; manualEntryErrorMsg.innerText = ''; manualEntryErrorMsg.style.display = 'none'; updateRunningTextVisibility(); checkSharePrompt(); updateDeactivatedIndicator(); }
    function addManualEntry() { if (!manualAmountInput || !manualTimeInput || !manualEntryErrorMsg) { console.error("Nedostaju elementi za dodavanje ručnog unosa."); return; } manualEntryErrorMsg.innerText = ''; manualEntryErrorMsg.style.display = 'none'; const amountStr = manualAmountInput.value.trim().replace(',', '.'); const timeStr = manualTimeInput.value.trim(); const parsedAmount = parseFloat(amountStr); if (isNaN(parsedAmount) || parsedAmount <= 0) { manualEntryErrorMsg.innerText = 'Molimo unesite ispravan iznos veći od 0.'; manualEntryErrorMsg.style.display = 'block'; manualAmountInput.focus(); sendLogData({ Event: 'manual_entry_add_failed', Details: 'invalid_amount' }); return; } let parsedTime = '??:??'; if (timeStr) { const timeMatch = timeStr.match(/^([0-1]?\d|2[0-3]):([0-5]?\d)$/); if (timeMatch) { const hour = parseInt(timeMatch[1], 10); const minute = parseInt(timeMatch[2], 10); parsedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; } else { console.warn("Neispravan format vremena unesen:", timeStr); manualEntryErrorMsg.innerText = 'Upozorenje: Vrijeme nije u formatu HH:MM. Dodano kao "??:??".'; manualEntryErrorMsg.style.display = 'block'; parsedTime = '??:??'; } } const newItem = { amount: parsedAmount, qrCode: `MANUAL_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`, time: parsedTime, datv: null, scanTimestamp: Date.now() }; povijest.push(newItem); ukupno += parsedAmount; if (isCounterDecrementActive && brojac > 0) { brojac--; console.log("Brojač smanjen (ručni unos) na:", brojac); saveBrojac(); checkSharePrompt(); } try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Greška spremanja nesačuvanog stanja (ručni unos):", lsError); } updateDisplay(); showTemporaryMessage(loadedMsg, "RUČNO DODANO", 1000); playSound('scan-sound'); if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI DODAN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`; handleInfoDeleteMessageVisibility(); } hideManualEntryModal(); const manualEntryDetails = { amount: parsedAmount, time: parsedTime, sessionInvoiceNumber: povijest.length, isManual: true }; sendLogData({ Event: 'manual_entry_added', Details: JSON.stringify(manualEntryDetails) }); }
    function cancelManualEntry() { if (!manualEntryModalOverlay) return; playSound('click-sound'); hideManualEntryModal(); sendLogData({ Event: 'manual_entry_cancelled' }); }
      function switchToScannerView() {
        console.log("switchToScannerView: Pokrenuto.");
        if (document.body.classList.contains('scanner-view') && !isScannerActive) {
            console.log("switchToScannerView: Skener nije aktivan, inicijaliziram...");
            initializeScanner();
        }
        document.body.classList.remove('history-view', 'ads-view');
        document.body.classList.add('scanner-view');
        // Linija "document.body.style.backgroundColor = '#f4f4f4';" je UKLONJENA
        updateDisplay();
        requestAnimationFrame(initializeScanner);
        if (!visibilityListenerAttached) { attachVisibilityListener(); }
    }
    function switchToHistoryView() { console.log("switchToHistoryView: Pokrenuto."); if (document.body.classList.contains('history-view')) return; if (removeConfirm || removeNameConfirm) resetRemoveMode(); if (ocistiConfirm) resetOcistiMode(); if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } stopScanner().finally(() => { document.body.classList.remove('scanner-view', 'ads-view'); document.body.classList.add('history-view'); currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0); previousHistoryViewState = 'day-view'; renderHistoryView(currentlyViewedDate); }); }
    function switchToAdsView() { console.log("switchToAdsView: Pokrenuto."); playSound('click-sound'); sendLogData({ Event: 'ads_page_opened' }); stopScanner().finally(() => { document.body.classList.remove('scanner-view', 'history-view'); document.body.classList.add('ads-view'); renderAdsPage(); }); }
    function renderAdsPage() {
        if (!adsContentDiv) return;
        let adsHtml = '';
        if (adsConfiguration.adsList && adsConfiguration.adsList.length > 0) {
            adsConfiguration.adsList.forEach(ad => {
                const hasWebLink = ad.web && ad.web.trim() !== '';
                const imageTag = ad.slika ? `<img src="${ad.slika}" alt="${ad.nazivFirme}" class="ad-image">` : '';
                const imageHtml = hasWebLink ? `<a href="${ad.web}" target="_blank" class="ad-image-link">${imageTag}</a>` : imageTag;
                adsHtml += ` <div class="ad-card"> ${ad.nazivFirme ? `<div class="ad-title">${ad.nazivFirme}</div>` : ''} ${imageHtml} ${ad.tekst ? `<div class="ad-text">${ad.tekst}</div>` : ''} ${ad.kontakt ? `<div class="ad-contact">KONTAKT: ${ad.kontakt}</div>` : ''} </div> `;
            });
        } else {
            adsHtml = '<p style="text-align:center; color: grey; padding: 2em 0;">Trenutno nema dostupnih ponuda.</p>';
        }
        if (adsFooterText && adsFooterText.trim() !== "") {
            adsHtml += `<div id="ads-footer-promo">${adsFooterText}</div>`;
        }
        adsContentDiv.innerHTML = adsHtml;
    }
    function clearDynamicHeaderContent() { if (historyDynamicHeaderContentDiv) { historyDynamicHeaderContentDiv.innerHTML = ''; } }
    function renderHistoryView(dateToShow = currentlyViewedDate) { console.log("renderHistoryView: Pokrenuto za datum:", dateToShow); previousHistoryViewState = 'day-view'; currentlyViewedDate = new Date(dateToShow); currentlyViewedDate.setHours(0,0,0,0); const punaPovijest = loadFullHistoryFromLocalStorage(); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) { console.error("renderHistoryView: Kritični DOM elementi nedostaju!"); return; } clearDynamicHeaderContent(); const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' }; let imeDana = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDatuma); const startOfDay = new Date(currentlyViewedDate); const endOfDay = new Date(currentlyViewedDate); endOfDay.setHours(23, 59, 59, 999); const sesijeZaPrikazaniDan = punaPovijest.filter(grupa => { const grupaDate = new Date(grupa.timestamp); return grupaDate >= startOfDay && grupaDate <= endOfDay; }); sesijeZaPrikazaniDan.sort((a, b) => a.timestamp - b.timestamp); const brojRacunaOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); const dateInfoDiv = document.createElement('div'); dateInfoDiv.id = 'history-date-info'; const currentViewDateStr = getISODateString(currentlyViewedDate); const hasOtherDays = punaPovijest.some(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr && grupaDateStr !== currentViewDateStr; }); dateInfoDiv.innerHTML = `<span style="font-weight: bold;">${imeDana}, ${formatiraniDatum}</span> <button id="history-view-toggle-btn" style="background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;" ${!hasOtherDays ? 'disabled' : ''}>OSTALI DANI ></button>`; historyDynamicHeaderContentDiv.appendChild(dateInfoDiv); const historyViewToggleButton = dateInfoDiv.querySelector('#history-view-toggle-btn'); if (historyViewToggleButton) { const newHistoryViewToggleButton = historyViewToggleButton.cloneNode(true); historyViewToggleButton.parentNode.replaceChild(newHistoryViewToggleButton, historyViewToggleButton); if (!newHistoryViewToggleButton.disabled) { newHistoryViewToggleButton.addEventListener('click', () => { playSound('click-sound'); renderAllDaysView(); }); newHistoryViewToggleButton.style.cursor = 'pointer'; newHistoryViewToggleButton.style.opacity = '1'; } else { newHistoryViewToggleButton.style.cssText += ';cursor: not-allowed; opacity: 0.7;'; } } const summaryInfoDiv = document.createElement('div'); summaryInfoDiv.id = 'history-summary-info'; summaryInfoDiv.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaOvajDan}</span></span> <span style="font-weight: bold;">UKUPNO: ${ukupanIznosOvajDan.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(summaryInfoDiv); const uputaHtml = `<p id="history-select-group-text" style="text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;">IZABERI SKEN ILI <button id="start-search-btn" style="background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;">(TRAŽI)</button></p>`; let sesijeHtml = '<ul id="scan-group-list" style="list-style: none; padding: 0; margin: 0;">'; if (sesijeZaPrikazaniDan.length === 0) { sesijeHtml += '<li style="text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;"><i>Nema spremljenih skenova za ovaj dan.</i></li>'; } else { sesijeZaPrikazaniDan.forEach((sesija, index) => { sesijeHtml += generirajHtmlZaSpremljenuGrupu(sesija, index + 1); }); } sesijeHtml += '</ul>'; historyContentDiv.innerHTML = uputaHtml + sesijeHtml; if (sesijeZaPrikazaniDan.length > 0) { const clearDayButton = document.createElement('button'); clearDayButton.id = 'clear-day-btn'; clearDayButton.className = 'red-btn'; clearDayButton.style.margin = '2em auto 1em auto'; clearDayButton.style.display = 'block'; clearDayButton.innerText = 'IZBRIŠI OVAJ DAN'; historyContentDiv.appendChild(clearDayButton); clearDayButton.dataset.confirming = 'false'; const newClearDayBtn = clearDayButton.cloneNode(true); clearDayButton.parentNode.replaceChild(newClearDayBtn, clearDayButton); newClearDayBtn.addEventListener('click', () => { if (newClearDayBtn.disabled) return; if (newClearDayBtn.dataset.confirming !== 'true') { playSound('click-sound'); newClearDayBtn.innerText = "Potvrdi Brisanje Dana?"; newClearDayBtn.classList.add('confirm-mode'); newClearDayBtn.dataset.confirming = 'true'; sendLogData({ Event: 'delete_day_prompt', Details: getISODateString(currentlyViewedDate) }); } else { const dateToConfirmDelete = new Date(currentlyViewedDate); deleteScansForDay(dateToConfirmDelete); } }); } const groupList = document.getElementById('scan-group-list'); if (groupList) { const newGroupList = groupList.cloneNode(true); groupList.parentNode.replaceChild(newGroupList, groupList); newGroupList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); previousHistoryViewState = 'day-view'; renderGroupDetailView(selectedGroup); } else { console.error("Nije pronađena grupa:", timestamp); alert("Greška otvaranja detalja."); } } }); } const searchBtn = document.getElementById('start-search-btn'); if(searchBtn) { const newSearchBtn = searchBtn.cloneNode(true); searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn); newSearchBtn.addEventListener('click', startSearch); } }
    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { const vrijemeSpremanja = new Date(grupa.timestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name} U ${vrijemeSpremanjaFormatirano}</span>` : `<span class="scan-time-history">SKEN U ${vrijemeSpremanjaFormatirano}</span>`; return `<li data-timestamp="${grupa.timestamp}" style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;"><span style="flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;"><span style="margin-right: 5px; flex-shrink: 0;">${redniBroj}.</span> ${prikazNaziva}</span><span class="scan-group-last-qr-time" style="flex-shrink: 0; margin-left: 15px;">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style="font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;">${ukupnoGrupa.toFixed(2)} €</span></span></li>`; }
    function renderGroupDetailView(groupData) { if (!historyContentDiv || !groupData || !groupData.racuni || !historyDynamicHeaderContentDiv) { console.error("Nedostaju podaci za detalje."); renderHistoryView(); return; } clearDynamicHeaderContent(); const sessionTimestamp = groupData.timestamp; const vrijemeSpremanja = new Date(sessionTimestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = groupData.racuni.reduce((sum, item) => sum + item.amount, 0); const brojRacunaSesije = groupData.racuni.length; const naslovDetalja = groupData.name ? groupData.name : `SKEN U ${vrijemeSpremanjaFormatirano}`; const detailHeaderDiv = document.createElement('div'); detailHeaderDiv.id = 'detail-header-info'; detailHeaderDiv.innerHTML = `<button id="back-to-group-list-btn" style="background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">< Lista</button><h3 style="margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;">${naslovDetalja}</h3><span style="font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;">${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailHeaderDiv); const detailSummaryDiv = document.createElement('div'); detailSummaryDiv.id = 'detail-summary-info'; detailSummaryDiv.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaSesije}</span></span><span style="font-weight: bold;">UKUPNO: ${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailSummaryDiv); let detailListHtml = '<ul id="detail-scan-list">'; const racuniZaPrikaz = groupData.racuni; racuniZaPrikaz.forEach((racun, index) => { const vrijemeRacuna = racun.time !== '??:??' ? `${racun.time}` : 'Vrijeme?'; detailListHtml += `<li><span style="color: #333; min-width: 80px;">${index + 1}. ${vrijemeRacuna}</span><span style="font-weight: bold; margin-left: auto;">${racun.amount.toFixed(2)} €${racun.qrCode.startsWith('MANUAL_') ? ' (ručno)' : ''}</span></li>`; }); detailListHtml += `</ul>`; detailListHtml += `<button id="delete-session-btn" class="red-btn" data-timestamp="${sessionTimestamp}" style="margin: 2em auto 1em auto; display: block;">IZBRIŠI OVAJ SKEN</button>`; historyContentDiv.innerHTML = detailListHtml; const backBtn = document.getElementById('back-to-group-list-btn'); if (backBtn) { const newBackBtn = backBtn.cloneNode(true); backBtn.parentNode.replaceChild(newBackBtn, backBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); console.log("Vraćanje iz detalja, prethodno stanje:", previousHistoryViewState); switch (previousHistoryViewState) { case 'day-search-results': renderHistoryView(currentlyViewedDate); startSearch(); const searchInputDay = document.getElementById('search-input'); if(searchInputDay) searchInputDay.value = lastSearchTerm; executeSearch(); break; case 'all-days-search-results': renderAllDaysView(); const searchInputAll = document.getElementById('all-days-search-input'); if(searchInputAll) searchInputAll.value = lastSearchTerm; executeAllDaysSearch(); break; case 'day-view': default: renderHistoryView(currentlyViewedDate); break; } }); } const deleteSessionBtn = document.getElementById('delete-session-btn'); if(deleteSessionBtn) { deleteSessionBtn.dataset.confirming = 'false'; const newDeleteSessionBtn = deleteSessionBtn.cloneNode(true); deleteSessionBtn.parentNode.replaceChild(newDeleteSessionBtn, deleteSessionBtn); newDeleteSessionBtn.addEventListener('click', () => { if (newDeleteSessionBtn.disabled) return; if (newDeleteSessionBtn.dataset.confirming !== 'true') { playSound('click-sound'); newDeleteSessionBtn.innerText = "Potvrdi brisanje?"; newDeleteSessionBtn.classList.add('confirm-mode'); newDeleteSessionBtn.dataset.confirming = 'true'; sendLogData({ Event: 'delete_session_prompt', Details: groupData.timestamp }); } else { const timestampToDelete = newDeleteSessionBtn.dataset.timestamp; deleteSpecificSession(timestampToDelete); } }); } }
    function deleteScansForDay(dateToDelete) { if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) { console.error("Pokušaj brisanja dana s neispravnim datumom."); alert("Greška: Nije moguće identificirati dan za brisanje."); return; } const dateToDeleteStr = getISODateString(dateToDelete); if (!dateToDeleteStr) return; console.log("Brisanje svih skenova za dan:", dateToDeleteStr); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const sessionsToDelete = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr === dateToDeleteStr; }); const filtriranaPovijest = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr !== dateToDeleteStr; }); const newLength = filtriranaPovijest.length; console.log(`Originalna dužina: ${originalLength}, Nova dužina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`); const dayDetails = { date: dateToDeleteStr, sessionCount: sessionsToDelete.length, totalCount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.length, 0), totalAmount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.reduce((gSum, r) => gSum + r.amount, 0), 0) }; sendLogData({ Event: 'day_deleted_confirmed', Details: JSON.stringify(dayDetails) }); renderAllDaysView(); } else { console.warn("Nisu pronađeni skenovi za brisanje za dan:", dateToDeleteStr); alert("Greška: Nisu pronađeni skenovi za ovaj dan."); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = "IZBRIŠI OVAJ DAN"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }
    function renderAllDaysView() { previousHistoryViewState = 'all-days-view'; const punaPovijest = loadFullHistoryFromLocalStorage(); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) return; clearDynamicHeaderContent(); const searchBarHtml = `<div id="all-days-search-container"><div style="display: flex; gap: 5px;"><input type="text" id="all-days-search-input" placeholder="UPIŠI ZA PRETRAGU..." style="flex-grow: 1; padding: 0.5em; font-size: 0.9em;"><button id="execute-all-days-search-btn" style="padding: 0.5em 0.6em; font-size: 0.9em;">Traži</button><button id="close-all-days-search-btn" style="padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;">Svi Dani</button></div></div><div id="all-days-summary-info" style="display: none;"></div>`; historyDynamicHeaderContentDiv.innerHTML = searchBarHtml; const resultsPlaceholderHtml = `<div id="search-results-all-days"><p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p></div>`; historyContentDiv.innerHTML = resultsPlaceholderHtml; const searchInput = document.getElementById('all-days-search-input'); const executeBtn = document.getElementById('execute-all-days-search-btn'); const closeBtn = document.getElementById('close-all-days-search-btn'); const searchResultsContainer = document.getElementById('search-results-all-days'); const allDaysSummaryContainer = document.getElementById('all-days-summary-info'); const sessionsByDate = punaPovijest.reduce((acc, session) => { const dateStr = getISODateString(new Date(session.timestamp)); if (!dateStr) return acc; if (!acc[dateStr]) { acc[dateStr] = { date: new Date(session.timestamp), sessions: [], totalAmount: 0, totalCount: 0 }; acc[dateStr].date.setHours(0, 0, 0, 0); } acc[dateStr].sessions.push(session); acc[dateStr].totalAmount += session.racuni.reduce((sum, item) => sum + item.amount, 0); acc[dateStr].totalCount += session.racuni.length; return acc; }, {}); const sortedDays = Object.values(sessionsByDate).sort((a, b) => b.date - a.date); if(searchInput && executeBtn && closeBtn && searchResultsContainer && allDaysSummaryContainer) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeAllDaysSearch(); }); const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', () => { executeAllDaysSearch(); }); const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); newSearchInput.value = ''; renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = punaPovijest.length > 0 ? 'flex' : 'none'; }); } else { console.error("Nisu pronađeni svi elementi za pretragu u All Days View."); } if (punaPovijest.length > 0) { const backButtonHtml = `<button id="back-to-current-day-btn" style="background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">< NATRAG</button>`; const clearAllButtonHtml = `<button id="clear-history-btn" class="red-btn" style="padding: 0.5em 1em; font-size: 1em;">IZBRIŠI SVU POVIJEST</button>`; const exportImportButtonsHtml = `<div style="text-align: center; margin-top: 1em; margin-bottom: 1em;"><button id="export-history-btn" style="background-color: #007bff; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">Izvezi povijest</button><button id="import-history-btn" style="background-color: #28a745; color: white; padding: 0.5em 1em; font-size: 1em;">Uvezi povijest</button></div>`; const buttonsHtml = `<div style="text-align: center; margin-top: 1.5em; margin-bottom: 1em;">${backButtonHtml}${clearAllButtonHtml}</div> ${exportImportButtonsHtml}`; if (!document.getElementById('back-to-current-day-btn')) { historyContentDiv.insertAdjacentHTML('beforeend', buttonsHtml); const exportBtn = document.getElementById('export-history-btn'); const importBtn = document.getElementById('import-history-btn'); if (exportBtn) { exportBtn.addEventListener('click', exportHistory); } if (importBtn) { importBtn.addEventListener('click', importHistory); } } const backToDayBtn = document.getElementById('back-to-current-day-btn'); if (backToDayBtn) { const newBackBtn = backToDayBtn.cloneNode(true); backToDayBtn.parentNode.replaceChild(newBackBtn, backToDayBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); renderHistoryView(currentlyViewedDate); }); } const clearAllBtn = document.getElementById('clear-history-btn'); if (clearAllBtn) { if (punaPovijest.length === 0) { clearAllBtn.disabled = true; clearAllBtn.style.opacity = '0.6'; clearAllBtn.style.cursor = 'not-allowed'; } else { clearAllBtn.disabled = false; clearAllBtn.style.opacity = '1'; clearAllBtn.style.cursor = 'pointer'; } clearAllBtn.dataset.confirming = 'false'; const newClearAllBtn = clearAllBtn.cloneNode(true); clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn); newClearAllBtn.addEventListener('click', () => { if (newClearAllBtn.disabled) return; if (newClearAllBtn.dataset.confirming !== 'true') { playSound('click-sound'); newClearAllBtn.innerText = "Potvrdi Brisanje SVEGA?"; newClearAllBtn.classList.add('confirm-mode'); newClearAllBtn.dataset.confirming = 'true'; sendLogData({ Event: 'clear_all_prompt' }); } else { localStorage.clear(); alert("Sva spremljena povijest i podaci obrisani."); sendLogData({ Event: 'clear_all_confirmed' }); currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0,0,0,0); loadCountersState(); initializeUserTracking(); fetchSheetData().then(() => { renderAllDaysView(); }).catch(() => { renderAllDaysView(); }); playSound('remove-sound'); } }); } } if (punaPovijest.length > 0 && searchResultsContainer && allDaysSummaryContainer) { renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = 'flex'; } else { if (allDaysSummaryContainer) allDaysSummaryContainer.style.display = 'none'; } }
    function renderAllDaysList(daysData, containerElement) { if (!containerElement) return; const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; let daysHtml = '<ul id="all-days-list-rendered" style="list-style: none; padding: 0; margin: 0;">'; if (daysData.length === 0) { if (containerElement.id === 'search-results-all-days' && document.getElementById('all-days-search-input')?.value.trim()) { daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></li>'; } else { daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema spremljene povijesti.</i></li>'; } } else { daysData.forEach(dayInfo => { let imeDana = dayInfo.date.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = dayInfo.date.toLocaleDateString('hr-HR', opcijeDatuma); const isoDate = getISODateString(dayInfo.date); daysHtml += `<li data-date-iso="${isoDate}" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;"><span style="font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${imeDana}, ${formatiraniDatum}</span><div style="flex-shrink: 0; text-align: right;"><span style="font-size: 0.9em; color: #555; white-space: nowrap;">Računa: ${dayInfo.totalCount}</span><span style="font-weight: bold; margin-left: 15px; white-space: nowrap;">${dayInfo.totalAmount.toFixed(2)} €</span></div></li>`; }); } daysHtml += '</ul>'; containerElement.innerHTML = daysHtml; const listElement = containerElement.querySelector('ul'); if (listElement) { const newListElement = listElement.cloneNode(true); listElement.parentNode.replaceChild(newListElement, listElement); newListElement.addEventListener('click', (e) => { const clickedDayLi = e.target.closest('li[data-date-iso]'); if (clickedDayLi && clickedDayLi.dataset.dateIso) { const selectedDate = new Date(clickedDayLi.dataset.dateIso + 'T00:00:00'); playSound('click-sound'); currentlyViewedDate = selectedDate; renderHistoryView(selectedDate); } }); } }
    function executeAllDaysSearch() { const searchInput = document.getElementById('all-days-search-input'); const resultsContainer = document.getElementById('search-results-all-days'); const summaryContainer = document.getElementById('all-days-summary-info'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm && !normalizedSearchDate) { resultsContainer.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu.</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; punaPovijest.forEach(grupa => { const sessionDate = new Date(grupa.timestamp); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit', year: 'numeric' }); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit', year: '2-digit' }); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', { weekday: 'long' }).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { match = true; } if (!match && searchTerm) { if (formattedDateShort.includes(searchTerm) || formattedDateNumeric.includes(searchTerm) || dayName.includes(searchTerm) || (sessionName && sessionName.includes(searchTerm)) || grupa.racuni.some(racun => racun.qrCode.toLowerCase().includes(searchTerm) || (racun.datv && racun.datv.toLowerCase().includes(searchTerm)))) { match = true; } } if (match) { searchResults.push(grupa); } }); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); resultsContainer.style.display = 'block'; sendLogData({ Event: 'history_search_all_days', Details: { term: searchTerm, resultCount: searchResults.length } }); }
    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { if (!containerElement || !summaryContainer) return; containerElement.innerHTML = ''; summaryContainer.innerHTML = ''; summaryContainer.style.display = 'none'; if (results.length === 0) { containerElement.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></p>'; return; } const brojRacunaRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); summaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaRezultati}</span></span><span style="font-weight: bold;">UKUPNO: ${ukupanIznosRezultati.toFixed(2)} €</span>`; summaryContainer.style.display = 'flex'; results.sort((a, b) => b.timestamp - a.timestamp); let resultsHtml = '<ul id="search-results-list" style="list-style: none; padding: 0; margin: 0;">'; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; results.forEach(grupa => { const vrijemeSpremanja = new Date(grupa.timestamp); const datumString = vrijemeSpremanja.toLocaleDateString('hr-HR', opcijeDatuma); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name}</span>` : `<span class="scan-time-history">SKEN</span>`; resultsHtml += `<li data-timestamp="${grupa.timestamp}" style="border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;"><div style="font-weight: bold; margin-right: 8px; color: #666;">${datumString}</div><div style="flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;">${prikazNaziva} <span style="font-size:0.9em; color:#555; margin-left: 5px;">u ${vrijemeSpremanjaFormatirano}</span></div><div style="flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;"><span class="scan-group-last-qr-time">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style="font-weight: bold; margin-left: 10px;">${ukupnoGrupa.toFixed(2)} €</span></div></li>`; }); resultsHtml += '</ul>'; containerElement.innerHTML = resultsHtml; const resultsList = containerElement.querySelector('ul'); if (resultsList) { const newListElement = resultsList.cloneNode(true); resultsList.parentNode.replaceChild(newListElement, resultsList); newListElement.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const punaPovijest = loadFullHistoryFromLocalStorage(); const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); if (containerElement.id === 'search-results') { previousHistoryViewState = 'day-search-results'; lastSearchTerm = document.getElementById('search-input')?.value.trim() || ''; } else if (containerElement.id === 'search-results-all-days') { previousHistoryViewState = 'all-days-search-results'; lastSearchTerm = document.getElementById('all-days-search-input')?.value.trim() || ''; } currentlyViewedDate = new Date(selectedGroup.timestamp); currentlyViewedDate.setHours(0,0,0,0); renderGroupDetailView(selectedGroup); } else { console.error("Nije pronađena grupa iz rezultata pretrage:", timestamp); alert("Greška pri otvaranju detalja."); } } }); } }
    function executeSearch() { const searchInput = document.getElementById('search-input'); const resultsContainer = document.getElementById('search-results'); const summaryContainer = document.getElementById('search-summary-info-day'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm && !normalizedSearchDate) { resultsContainer.innerHTML = '<p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu.</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; punaPovijest.forEach(grupa => { const sessionDate = new Date(grupa.timestamp); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit', year: 'numeric' }); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit', year: '2-digit' }); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', { weekday: 'long' }).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { match = true; } if (!match && searchTerm) { if (formattedDateShort.includes(searchTerm) || formattedDateNumeric.includes(searchTerm) || dayName.includes(searchTerm) || (sessionName && sessionName.includes(searchTerm)) || grupa.racuni.some(racun => racun.qrCode.toLowerCase().includes(searchTerm) || (racun.datv && racun.datv.toLowerCase().includes(searchTerm)))) { match = true; } } if (match) { searchResults.push(grupa); } }); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; sendLogData({ Event: 'history_search_day_view', Details: { term: searchTerm, resultCount: searchResults.length } }); }
    function startSearch() { playSound('click-sound'); console.log("Pokretanje pretrage..."); if (!historyContentDiv || !historyDynamicHeaderContentDiv) return; const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; const dateInfoDiv = document.getElementById('history-date-info'); const summaryInfoDiv = document.getElementById('history-summary-info'); if (dateInfoDiv) dateInfoDiv.style.display = 'none'; if (summaryInfoDiv) summaryInfoDiv.style.display = 'none'; let searchContainer = document.getElementById('search-container'); if (!searchContainer) { searchContainer = document.createElement('div'); searchContainer.id = 'search-container'; searchContainer.innerHTML = `<div style="display: flex; gap: 10px; margin-bottom: 0.8em;"><input type="text" id="search-input" placeholder="Pretraži SVE..." style="flex-grow: 1; padding: 0.5em;"><button id="execute-search-btn" style="padding: 0.5em 1em;">Traži</button><button id="close-search-btn" style="padding: 0.5em 1em; background-color: #ccc;">Zatvori</button></div><div id="search-summary-info-day" style="display: none;"></div>`; historyDynamicHeaderContentDiv.appendChild(searchContainer); } searchContainer.style.display = 'block'; historyContentDiv.innerHTML = '<div id="search-results"><p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu.</i></p></div>'; const searchResultsDiv = document.getElementById('search-results'); if(searchResultsDiv) searchResultsDiv.style.display = 'block'; const searchInput = document.getElementById('search-input'); const executeBtn = document.getElementById('execute-search-btn'); const closeBtn = document.getElementById('close-search-btn'); const searchSummaryDay = document.getElementById('search-summary-info-day'); if (searchInput) { searchInput.value = ''; searchInput.focus(); } if (searchSummaryDay) { searchSummaryDay.style.display = 'none'; searchSummaryDay.innerHTML = ''; } if (executeBtn) { const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', executeSearch); } if (closeBtn) { const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); if (searchContainer) searchContainer.style.display = 'none'; renderHistoryView(currentlyViewedDate); }); } if (searchInput) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeSearch(); }); } }
    function deleteSpecificSession(timestampToDelete) { if (timestampToDelete === undefined || timestampToDelete === null) { console.error("Pokušaj brisanja sesije s neispravnim timestampom."); alert("Greška: Nije moguće identificirati sken za brisanje."); return; } console.log("Brisanje specifične sesije s timestampom:", timestampToDelete); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const indexToDelete = punaPovijest.findIndex(grupa => String(grupa.timestamp) === String(timestampToDelete)); if (indexToDelete > -1) { const sessionToDelete = punaPovijest[indexToDelete]; const sessionDetails = { timestamp: sessionToDelete.timestamp, name: sessionToDelete.name || null, invoiceCount: sessionToDelete.racuni.length, totalAmount: sessionToDelete.racuni.reduce((sum, r) => sum + r.amount, 0).toFixed(2), lastQrTime: sessionToDelete.lastQrTime || '??:??' }; punaPovijest.splice(indexToDelete, 1); const newLength = punaPovijest.length; if (newLength < originalLength) { saveFullHistoryToLocalStorage(punaPovijest); playSound('remove-sound'); alert(`Sken (sesija) uspješno obrisan.`); sendLogData({ Event: 'session_deleted_confirmed', Details: JSON.stringify(sessionDetails) }); switch (previousHistoryViewState) { case 'day-view': renderHistoryView(currentlyViewedDate); break; case 'day-search-results': renderHistoryView(currentlyViewedDate); startSearch(); const searchInputDay = document.getElementById('search-input'); if(searchInputDay) searchInputDay.value = lastSearchTerm; executeSearch(); break; case 'all-days-search-results': renderAllDaysView(); const searchInputAll = document.getElementById('all-days-search-input'); if(searchInputAll) searchInputAll.value = lastSearchTerm; executeAllDaysSearch(); break; default: renderHistoryView(currentlyViewedDate); break; } } else { console.warn("Nije pronađen sken s timestampom za brisanje:", timestampToDelete); alert("Greška: Nije moguće pronaći sken za brisanje."); } } else { console.warn("Nije pronađen sken s timestampom za brisanje (findIndex -1):", timestampToDelete); alert("Greška: Nije moguće pronaći sken za brisanje."); } }
    function exportHistory() { playSound('click-sound'); const punaPovijest = loadFullHistoryFromLocalStorage(); const unsavedData = (povijest.length > 0 || currentSessionName) ? { count: povijest.length, amount: ukupno, currentSession: povijest, currentName: currentSessionName || null } : null; if (punaPovijest.length === 0 && !unsavedData) { alert("Nema povijesti za izvoz."); sendLogData({ Event: 'history_exported', Details: 'no_data' }); return; } try { const dataToExport = { savedHistory: punaPovijest, unsavedState: unsavedData, exportTimestamp: new Date().toISOString(), appVersion: '1.1.0' }; const historyJson = JSON.stringify(dataToExport, null, 2); const blob = new Blob([historyJson], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; a.download = `qr_racunator_povijest_${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert("Povijest je izvezena kao JSON datoteka."); const exportDetails = { savedItemCount: punaPovijest.length, unsavedItemCount: unsavedData ? unsavedData.count : 0 }; sendLogData({ Event: 'history_exported', Details: JSON.stringify(exportDetails) }); } catch (error) { console.error("Greška pri izvozu povijesti:", error); alert("Greška pri izvozu povijesti."); sendLogData({ Event: 'history_export_failed', Details: error.message }); } }
    function importHistory() { playSound('click-sound'); const fileInput = document.getElementById('import-file-input'); if (!fileInput) { console.error("Input za datoteku za uvoz nije pronađen."); alert("Greška pri pokretanju uvoza."); return; } fileInput.click(); fileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) { fileInput.value = ''; sendLogData({ Event: 'history_import_cancelled', Details: 'no_file_selected' }); return; } const reader = new FileReader(); reader.onload = (e) => { try { const rawData = e.target.result; const importedData = JSON.parse(rawData); let historyToImport = null; let unsavedToImport = null; if (Array.isArray(importedData)) { historyToImport = importedData; } else if (typeof importedData === 'object' && importedData !== null && Array.isArray(importedData.savedHistory)) { historyToImport = importedData.savedHistory; unsavedToImport = importedData.unsavedState; } else { throw new Error("Neispravan format datoteke."); } if (!historyToImport.every(group => typeof group === 'object' && group !== null && Array.isArray(group.racuni) && group.racuni.every(racun => typeof racun === 'object' && racun !== null && typeof racun.amount === 'number' && typeof racun.qrCode === 'string'))) { throw new Error("Neispravna struktura podataka."); } if (unsavedToImport) { if (typeof unsavedToImport !== 'object' || unsavedToImport === null || typeof unsavedToImport.count !== 'number' || typeof unsavedToImport.amount !== 'number' || !Array.isArray(unsavedToImport.currentSession) || (unsavedToImport.currentName !== null && typeof unsavedToImport.currentName !== 'string' && typeof unsavedToImport.currentName !== 'undefined') || !unsavedToImport.currentSession.every(racun => typeof racun === 'object' && racun !== null && typeof racun.amount === 'number' && typeof racun.qrCode === 'string')) { console.warn("Uvezeni podaci sadrže neispravno nesačuvano stanje. Ignoriram."); unsavedToImport = null; } } const confirmMessage = `Pronađeno ${historyToImport.length} spremljenih sesija ${unsavedToImport && unsavedToImport.count > 0 ? ` i nesačuvano stanje (${unsavedToImport.count} računa)` : ''}.\n\nŽelite li PREPISATI vašu trenutnu povijest?`; if (confirm(confirmMessage)) { localStorage.clear(); saveFullHistoryToLocalStorage(historyToImport); if (unsavedToImport && unsavedToImport.currentSession && unsavedToImport.currentSession.length > 0) { povijest = unsavedToImport.currentSession; ukupno = unsavedToImport.amount; currentSessionName = unsavedToImport.currentName || null; try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Greška spremanja uvezenog nesačuvanog stanja:", lsError); } } else { povijest = []; ukupno = 0; currentSessionName = null; } if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.lastNameText; delete deleteWarningDiv.dataset.beforeConfirmNameText; } resetRemoveMode(); resetOcistiMode(); loadCountersState(); initializeUserTracking(); updateDisplay(); alert("Povijest uspješno uvezena."); const importDetails = { savedItemCount: historyToImport.length, unsavedItemCount: unsavedToImport ? unsavedToImport.count : 0, mode: 'overwrite' }; sendLogData({ Event: 'history_imported', Details: JSON.stringify(importDetails) }); fetchSheetData().then(() => { renderAllDaysView(); }).catch(() => { renderAllDaysView(); }); } else { alert("Uvoz otkazan."); sendLogData({ Event: 'history_import_cancelled', Details: 'user_cancelled' }); } } catch (error) { console.error("Greška pri obradi datoteke za uvoz:", error); alert(`Greška pri uvozu: ${error.message}`); sendLogData({ Event: 'history_import_failed', Details: error.message }); } finally { fileInput.value = ''; } }; reader.readAsText(file); }, { once: true }); }
    function handleVisibilityChange() { if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) { console.log("Aplikacija postala vidljiva u Scanner View."); initializeScanner(); } else if (document.visibilityState === 'hidden') { console.log("Aplikacija postala nevidljiva, zaustavljam skener."); stopScanner(); } };
    function attachVisibilityListener() { if (visibilityListenerAttached) return; document.addEventListener("visibilitychange", handleVisibilityChange); visibilityListenerAttached = true; console.log("Visibility listener dodan."); }
    function globalClickListener(event) { if (cameraSelectionOverlay && cameraSelectionOverlay.style.display === 'block') { const isClickInsideOverlay = cameraSelectionOverlay.contains(event.target); const isClickOnSwitchButton = switchCameraButton && switchCameraButton.contains(event.target); if (!isClickInsideOverlay && !isClickOnSwitchButton) { cameraSelectionOverlay.style.display = 'none'; } } if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { const manualEntryModalContent = document.getElementById('manual-entry-modal-content'); const isClickInsideModalContent = manualEntryModalContent && manualEntryModalContent.contains(event.target); const isClickOnManualEntryBtn = manualEntryBtn && manualEntryBtn.contains(event.target); if (!isClickInsideModalContent && !isClickOnManualEntryBtn) { cancelManualEntry(); } } const isClickOnRemoveButton = removeButton && removeButton.contains(event.target); const isClickOnOcistiButton = ocistiButton && ocistiButton.contains(event.target); const isClickOnNameInput = sessionNameInput && sessionNameInput.contains(event.target); const isClickOnAddNameBtn = addNameBtn && addNameBtn.contains(event.target); const isClickOnEditIcon = event.target.classList.contains('edit-icon'); const isClickInsideNameArea = isClickOnNameInput || isClickOnAddNameBtn || isClickOnEditIcon; if ((removeConfirm || removeNameConfirm) && !isClickOnRemoveButton) { resetRemoveMode(); } if (ocistiConfirm && !isClickOnOcistiButton) { resetOcistiMode(); } if (sessionNameInput && sessionNameInput.style.display === 'block' && !isClickInsideNameArea) { saveName(); } }
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM spreman...");
        totalDiv = document.getElementById('total');
        totalContainer = document.getElementById('total-container');
        ocistiButton = document.getElementById('ocisti-button');
        invoiceCountDiv = document.getElementById('invoice-count');
        historyList = document.getElementById('historyList');
        removeButton = document.getElementById('remove-from-list-btn');
        duplicateWarning = document.getElementById('duplicate-warning');
        loadedMsg = document.getElementById('loaded-message');
        instructionDiv = document.getElementById('scan-instruction');
        deleteWarningDiv = document.getElementById('delete-warning');
        shareButton = document.getElementById('share-button');
        readerDiv = document.getElementById('reader');
        historyToggleButton = document.getElementById('history-toggle-btn');
        historyDiv = document.getElementById('history');
        historyPageDiv = document.getElementById('history-page');
        backToScannerButton = document.getElementById('back-to-scanner-btn');
        historyContentDiv = document.getElementById('history-content');
        sessionNameContainer = document.getElementById('session-name-container');
        addNameBtn = document.getElementById('add-name-btn');
        sessionNameInput = document.getElementById('session-name-input');
        sessionNameDisplay = document.getElementById('session-name-display');
        sessionNameText = document.getElementById('session-name-text');
        historyStickyHeaderDiv = document.getElementById('history-sticky-header');
        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');
        runningTextContainer = document.getElementById('running-text-container');
        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;
        sharePromptOverlay = document.getElementById('share-prompt-overlay');
        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');
        switchCameraButton = document.getElementById('switch-camera-btn');
        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');
        cameraListUl = document.getElementById('camera-list');
        manualEntryBtn = document.getElementById('manual-entry-btn');
        manualEntryModalOverlay = document.getElementById('manual-entry-modal-overlay');
        manualAmountInput = document.getElementById('manual-amount-input');
        manualTimeInput = document.getElementById('manual-time-input');
        manualAddBtn = document.getElementById('manual-add-btn');
        manualCancelBtn = document.getElementById('manual-cancel-btn');
        manualEntryErrorMsg = document.getElementById('manual-entry-error');
        importFileInput = document.getElementById('import-file-input');
        adsButton = document.getElementById('ads-button');
        adsPageDiv = document.getElementById('ads-page');
        adsContentDiv = document.getElementById('ads-content');
        backToScannerFromAdsButton = document.getElementById('back-to-scanner-from-ads-btn');

        if (!readerDiv || !historyPageDiv || !adsPageDiv ) { console.error("GREŠKA: Nedostaju kritični DOM elementi!"); document.body.innerHTML = '<div style="padding: 20px; color: red; font-weight: bold;">Greška pri učitavanju aplikacije.</div>'; return; }

        document.body.addEventListener('click', globalClickListener, true);
        historyToggleButton.addEventListener('click', () => { playSound('click-sound'); switchToHistoryView(); });
        backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); });
        adsButton.addEventListener('click', switchToAdsView);
        backToScannerFromAdsButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); });

        if (navigator.share) { shareButton.style.display = 'block'; shareButton.addEventListener('click', async () => { if (removeConfirm || removeNameConfirm) resetRemoveMode(); if (ocistiConfirm) resetOcistiMode(); if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { hideManualEntryModal(); } const shareData = { title: 'QR SKENER-RAČUNATOR', text: 'Skenira i zbraja račune bez instaliranja. Isprobaj!', url: 'https://soboslikar.github.io/QR-RACUNATOR/' }; try { await navigator.share(shareData); sendLogData({ Event: 'share_success' }); } catch (err) { if (err.name === 'AbortError') { sendLogData({ Event: 'share_cancelled' }); } else { showTemporaryMessage(loadedMsg, "Dijeljenje neuspješno.", 1500); sendLogData({ Event: 'share_failed', Details: err.message }); } } finally { if (brojac === 0 && brojac2 > 0) { brojac = brojac2; saveBrojac(); sendLogData({ Event: 'share_counter_reset', Details: brojac }); } checkSharePrompt(); updateRunningTextVisibility(); updateDeactivatedIndicator(); } }); } else { shareButton.style.display = 'none'; }
        sessionNameInput.addEventListener('keydown', (e) => { if (sessionNameInput.style.display === 'none') return; if (e.key === 'Enter') { e.preventDefault(); saveName(); } else if (e.key === 'Escape') { e.preventDefault(); sessionNameInput.value = currentSessionName || ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); if(removeNameConfirm) resetRemoveMode(); sendLogData({ Event: 'session_name_input_cancelled_escape' }); } });
        sessionNameInput.addEventListener('blur', saveName);
        switchCameraButton.addEventListener('click', toggleCameraSelection);
        manualEntryBtn.addEventListener('click', showManualEntryModal);
        manualAddBtn.addEventListener('click', addManualEntry);
        manualCancelBtn.addEventListener('click', cancelManualEntry);
        manualEntryModalOverlay.addEventListener('keydown', (e) => { if (manualEntryModalOverlay.style.display === 'none') return; if (e.key === 'Enter') { if (document.activeElement === manualAmountInput || document.activeElement === manualTimeInput) { e.preventDefault(); addManualEntry(); } } else if (e.key === 'Escape') { e.preventDefault(); cancelManualEntry(); } });

        loadCountersState();
        initializeUserTracking();
        updateDisplay();
        if (document.body.classList.contains('scanner-view')) {
            initializeScanner();
            attachVisibilityListener();
        } else {
            renderHistoryView(currentlyViewedDate);
        }
        fetchSheetData().then(() => {
            const appLoadedDetails = { status: 'ok', fetchSuccess: true };
            sendLogData({ Event: 'app_loaded', Details: JSON.stringify(appLoadedDetails) });
            if (document.body.classList.contains('history-view')) {
                renderHistoryView(currentlyViewedDate);
            }
        }).catch(error => {
            console.error("Greška tijekom pozadinskog dohvaćanja podataka:", error);
            const appLoadedErrorEventData = { Event: 'app_loaded', Details: JSON.stringify({ status: 'error', fetchError: error.toString() }) };
            sendLogData(appLoadedErrorEventData);
            if (document.body.classList.contains('history-view')) { renderHistoryView(currentlyViewedDate); }
        });
    });
</script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- Kraj Statcounter koda -->

</body>
</html>
