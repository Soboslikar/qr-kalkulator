<script>
let ukupno = 0;
let povijest = [];
let currentAmount = 0;
let removeConfirm = false;

function updateDisplay() {
  const totalText = `UKUPNO: ${ukupno.toFixed(2)} €`;
  document.getElementById('total').innerText = totalText;
  document.getElementById('current-amount').innerText = `${currentAmount.toFixed(2)} €`;
  updateHistory();

  // DODAJ gumb vidljiv samo kad ima currentAmount
  document.getElementById('add-btn').style.display = currentAmount > 0 ? 'inline-block' : 'none';

  // OBRIŠI IZ LISTE vidljiv samo ako ima unosa
  const removeBtn = document.getElementById('remove-btn');
  const bigBtns = document.querySelector('.big-btns');
  if (povijest.length > 0) {
    bigBtns.style.display = 'flex';
    removeBtn.className = removeConfirm ? 'yellow-btn' : 'red-btn';
    removeBtn.innerText = removeConfirm ? 'Potvrdi' : 'Obriši iz liste';
  } else {
    bigBtns.style.display = 'none';
    removeConfirm = false;
  }
}

function updateHistory() {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';
  povijest.forEach((iznos, index) => {
    const listItem = document.createElement('li');
    listItem.classList.add('bold-text');
    listItem.innerText = `${index + 1}.  ${iznos.toFixed(2)} €`;
    historyList.appendChild(listItem);
  });
}

function playSound(url) {
  const audio = new Audio(url);
  audio.play();
}

function clearCurrent() {
  currentAmount = 0;
  document.getElementById('amount-label').style.display = 'none';
  document.getElementById('current-amount').style.display = 'none';
  document.getElementById('clear-current-btn').style.display = 'none';
  updateDisplay();
}

function addCurrent() {
  if (currentAmount > 0) {
    povijest.push(currentAmount);
    ukupno += currentAmount;
    playSound('https://www.soundjay.com/button/beep-08b.mp3');
    clearCurrent();
    updateDisplay();
  }
}

function startRemoveFromList() {
  const btn = document.getElementById('remove-btn');
  if (!removeConfirm) {
    removeConfirm = true;
  } else {
    if (povijest.length > 0) {
      ukupno -= povijest.pop();
    }
    removeConfirm = false;
  }
  updateDisplay();
}

function handleScan(decodedText) {
  const urlParams = new URLSearchParams(decodedText);
  const iznosCenti = parseFloat(urlParams.get('izn'));
  if (!isNaN(iznosCenti)) {
    const iznosEuri = iznosCenti / 100;
    currentAmount = iznosEuri;
    playSound('https://www.soundjay.com/button/beep-07.wav');
    document.getElementById('amount-label').style.display = 'block';
    document.getElementById('current-amount').style.display = 'block';
    document.getElementById('clear-current-btn').style.display = 'block';
    updateDisplay();
  }
}

const html5QrCode = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(devices => {
  if (devices && devices.length) {
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      handleScan
    ).catch(err => console.error(err));
  }
});
</script>
