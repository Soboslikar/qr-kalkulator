<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Kalkulator</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #reader {
      width: 90vw;
      max-width: 600px;
      margin-top: 10px;
    }
    #history {
      width: 90vw;
      max-width: 600px;
      margin-top: 20px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      padding: 4px;
      background: #111;
      border-radius: 8px;
      font-size: 18px;
    }
    #total {
      font-size: 24px;
      margin-top: 20px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #clearLast {
      background-color: #ff4444;
      color: white;
    }
    #clearAll {
      background-color: red;
      color: yellow;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #clearAll.confirm {
      background-color: yellow;
      color: red;
    }
    #includedText {
      font-size: 24px;
      color: yellow;
      animation: pulse 2s ease-in-out forwards;
    }
    #loadedText {
      font-size: 36px;
      color: lime;
      margin-top: 10px;
      animation: fadeOut 1s ease-in-out forwards;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(2); }
      100% { transform: scale(1); opacity: 0; }
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    #counter {
      font-size: 20px;
      margin-top: 10px;
      color: white;
    }
  </style>
</head>
<body>
  <div id="loadedText" style="display:none;">UČITANO</div>
  <div id="reader"></div>
  <div id="total">UKUPNO: 0.00 €</div>
  <button id="clearLast">OBRIŠI ZADNJI UNOS</button>
  <div id="counter">0 RAČUNA</div>
  <button id="clearAll">OBRIŠI IZ LISTE</button>
  <div id="history"></div>

  <audio id="scanSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
  <audio id="deleteSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    const reader = new Html5Qrcode("reader");
    const history = document.getElementById("history");
    const totalText = document.getElementById("total");
    const loadedText = document.getElementById("loadedText");
    const counter = document.getElementById("counter");
    const scanSound = document.getElementById("scanSound");
    const deleteSound = document.getElementById("deleteSound");
    const clearAllBtn = document.getElementById("clearAll");

    let total = 0;
    let items = [];
    let confirmTimeout;

    function updateDisplay() {
      history.innerHTML = "";
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        div.textContent = `${item.time} - ${item.amount.toFixed(2)} €`;
        history.appendChild(div);
      });
      totalText.textContent = `UKUPNO: ${total.toFixed(2)} €`;
      counter.textContent = `${items.length} RAČUNA`;
    }

    function parseQRCodeText(text) {
      try {
        const url = new URL(text);
        const amount = parseFloat(url.searchParams.get("izn"));
        const timeRaw = url.searchParams.get("datv").split("_")[1];
        const time = timeRaw.substring(0, 2) + ":" + timeRaw.substring(2);
        return { amount, time };
      } catch (e) {
        return null;
      }
    }

    function showAnimatedText(id) {
      const el = document.getElementById(id);
      el.style.display = "block";
      el.classList.remove("fadeOut");
      void el.offsetWidth;
      if (id === "loadedText") {
        el.style.animation = "fadeOut 1s ease-in-out forwards";
        setTimeout(() => el.style.display = "none", 1000);
      }
    }

    reader.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      (text) => {
        const data = parseQRCodeText(text);
        if (!data) return;
        items.push(data);
        total += data.amount;
        updateDisplay();
        showAnimatedText("loadedText");
        scanSound.play();
      },
      (error) => {}
    );

    document.getElementById("clearLast").addEventListener("click", () => {
      if (items.length > 0) {
        const last = items.pop();
        total -= last.amount;
        updateDisplay();
        deleteSound.play();
      }
    });

    clearAllBtn.addEventListener("click", () => {
      if (!clearAllBtn.classList.contains("confirm")) {
        clearAllBtn.classList.add("confirm");
        clearAllBtn.textContent = "SIGURNO?";
        confirmTimeout = setTimeout(() => {
          clearAllBtn.classList.remove("confirm");
          clearAllBtn.textContent = "OBRIŠI IZ LISTE";
        }, 2000);
      } else {
        clearTimeout(confirmTimeout);
        clearAllBtn.classList.remove("confirm");
        clearAllBtn.textContent = "OBRIŠI IZ LISTE";
        items = [];
        total = 0;
        updateDisplay();
        deleteSound.play();
      }
    });
  </script>
</body>
</html>
