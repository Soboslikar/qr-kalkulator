<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>QR Kalkulator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 0;
      margin: 0;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: auto;
      padding: 10px;
    }
    #current-amount {
      font-size: 2em;
      margin: 10px;
    }
    #total {
      font-size: 2.5em;
      font-weight: bold;
      margin: 20px 0;
    }
    #history {
      max-height: 300px;
      overflow-y: auto;
      margin: 10px;
      font-size: 1.2em;
    }
    #duplicate-warning {
      color: red;
      font-size: 1.5em;
      display: none;
    }
    #duplicate-warning.animate {
      animation: bounceScale 2s ease forwards;
    }
    @keyframes bounceScale {
      0%   { transform: scale(1); opacity: 1; }
      25%  { transform: scale(2); }
      50%  { transform: scale(1); }
      75%  { transform: scale(1.5); }
      100% { transform: scale(1); opacity: 0; }
    }
    #scan-success {
      position: fixed;
      top: 5vh;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2em;
      font-weight: bold;
      color: #00ff00;
      z-index: 10;
      display: none;
      animation: fadeOut 1s ease forwards;
    }
    @keyframes fadeOut {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>

  <h1>QR Kalkulator</h1>

  <div id="scan-success">UČITANO</div>
  <div id="duplicate-warning">TAJ RAČUN JE URAČUNAT</div>
  
  <div id="reader"></div>

  <div id="current-amount"></div>
  <div id="total">UKUPNO: 0,00 €</div>
  <div id="history"></div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    let currentAmount = 0;
    let currentQRCode = '';
    let ukupno = 0;
    let povijest = [];

    function updateDisplay() {
      document.getElementById('current-amount').innerText = currentAmount ? `+ ${currentAmount.toFixed(2)} €` : '';
      document.getElementById('total').innerText = `UKUPNO: ${ukupno.toFixed(2)} €`;

      const historyList = povijest.map(item => 
        `<div>${item.amount.toFixed(2)} € <span style="color: gray;">(${item.time})</span></div>`
      ).join('');
      document.getElementById('history').innerHTML = historyList;
    }

    function handleScan(decodedText) {
      const urlParams = new URLSearchParams(decodedText.split('?')[1]);
      const iznosCenti = parseFloat(urlParams.get('izn'));
      const datv = urlParams.get('datv'); // primjer: 20250303_1310

      if (!isNaN(iznosCenti) && datv && datv.includes('_')) {
        const iznosEuri = iznosCenti / 100;
        const vrijeme = datv.split('_')[1];
        const hh = vrijeme.substring(0, 2);
        const mm = vrijeme.substring(2, 4);
        const formattedTime = `${hh}:${mm}`;

        if (povijest.some(item => item.qrCode === decodedText)) {
          const warning = document.getElementById('duplicate-warning');
          warning.classList.add('animate');
          warning.style.display = 'block';
          setTimeout(() => {
            warning.classList.remove('animate');
            warning.style.display = 'none';
          }, 2000);
        } else {
          currentAmount = iznosEuri;
          currentQRCode = decodedText;
          povijest.push({ amount: currentAmount, qrCode: currentQRCode, time: formattedTime });
          ukupno += currentAmount;
          currentAmount = 0;
          currentQRCode = '';
          updateDisplay();

          const success = document.getElementById('scan-success');
          success.style.display = 'block';
          success.style.animation = 'none'; // reset
          success.offsetHeight; // reflow
          success.style.animation = 'fadeOut 1s ease forwards';
          setTimeout(() => { success.style.display = 'none'; }, 1000);
        }
      }
    }

    function onScanFailure(error) {
      // Greške se ignoriraju jer je očekivano da skeniranje ponekad ne uspije
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          handleScan,
          onScanFailure
        );
      }
    });
  </script>
</body>
</html>
