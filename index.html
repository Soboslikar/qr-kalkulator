
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR RAČUNATOR</title>
  <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
  <meta property="og:title" content="QR RAČUNATOR" />
  <meta property="og:description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu."/>
  <meta name="description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu.">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://soboslikar.github.io/QR-RACUNATOR/" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }
    body.scanner-view #history-page { display: none; }
    body.history-view { background-color: white; }
    body.history-view #history-page { display: flex; flex-direction: column; padding: 0; min-height: calc(100vh - 1em); max-height: calc(100vh - 1em); box-sizing: border-box; overflow: hidden; }
    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator, body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay, body.history-view #manual-entry-modal-overlay { display: none !important; }
    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }
    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }
    #total-container { position: fixed; top: 23.5em; left: 49%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }
    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }
    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    #ocisti-button.confirm-mode { background-color: yellow; color: black; }
    #session-name-container { position: fixed; top: 27.5em; left: 50%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; width: 95%; max-width: 400px; justify-content: space-between; min-height: 35px; text-align: center; margin-top: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; gap: 15px; }
    #session-name-wrapper { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; flex-shrink: 0; font-weight: bold; white-space: nowrap; }
    #session-name-input { font-size: 1.2em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 4px; width: 100%; display: none; box-sizing: border-box; flex-grow: 1; }
    #session-name-display { font-size: 1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; flex-grow: 1; min-width: 50px; text-align: left; box-sizing: border-box; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; flex-shrink: 0; }
    #manual-entry-btn { background-color: orange; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; line-height: 1.3; flex-shrink: 0; min-width: 90px; white-space: nowrap; margin-right: 5px; }
    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }
    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,4,8,0.2); }
    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }
    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }
    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }
    #history ul { list-style: none; padding: 0; margin: 0; } #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    #history li:last-child { border-bottom: none; }
    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    .red-btn { background: #ff0000; color: yellow; } .yellow-btn { background-color: yellow; color: black; }
    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }
    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }
    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }
    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }
    #history-page { display: none; }
    #history-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    #history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em; }
    #history-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #back-to-scanner-btn:active { background-color: darkgreen; }
    #history-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }
    #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }
    #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
    #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }
    .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }
    .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
    .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }
    #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }
    #detail-scan-list { list-style: none; padding: 0; margin: 0; }
    #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}
    #detail-scan-list li:last-child { border-bottom: none; }
    #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }
    #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }
    #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }
    #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }
    #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }
    #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }
    #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }
    #all-days-list-rendered li:hover { background-color: #e0e0e0; }
    #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }
    #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }
    #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }
    #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
    #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }
    #detail-summary-info { border-top: none; }
    #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }
    #search-container { display: none; border-bottom: 1px solid #eee; }
    #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }
    #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 25s linear infinite; white-space: pre; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    #share-prompt-overlay { position: absolute; top: 7em; left: 50%; transform: translateX(-50%); width: 60%; height: auto; background-color: rgba(0, 0, 0, 0.75); color: lightgreen; font-size: 1.3em; font-weight: bold; text-align: center; padding: 1.5em 1em; border-radius: 10px; z-index: 4; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.3); line-height: 1.4; align-items: center; justify-content: center; }
    #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    #switch-camera-btn { position: fixed; top: 10px; right: 10px; z-index: 5; padding: 6px 8px; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; font-size: 1.4em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; }
    #switch-camera-btn:active { background-color: rgba(0, 0, 0, 0.7); }
    #camera-selection-overlay { position: fixed; top: 55px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 6; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 150px; }
    #camera-list { list-style: none; padding: 0; margin: 0; }
    #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #camera-list li:hover { background-color: #f0f0f0; }
    #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }
    #manual-entry-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
    #manual-entry-modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-width: 90%; width: 300px; text-align: center; }
    #manual-entry-modal-content input[type="text"] { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
    #manual-entry-modal-content label { display: block; margin-bottom: 5px; font-weight: bold; text-align: left; }
    #manual-entry-modal-content div { margin-bottom: 15px; text-align: left; }
    #manual-entry-modal-content div:last-child { margin-bottom: 0; text-align: center; }
    #manual-entry-modal-content button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #manual-entry-modal-content button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    #manual-entry-modal-content button#manual-add-btn { background-color: green; color: white; }
    #manual-entry-modal-content button#manual-cancel-btn { background-color: #dc3545; color: white; }
    #manual-entry-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }
    #import-file-input { display: none; }
    @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
  </style>
</head>
<body class="scanner-view">

  <div id="counter-deactivated-indicator" style="display: none;">✔</div>
  <div id="header">QR Skener-Kalkulator</div>
  <div id="scan-instruction">Pozicioniraj qr kod unutar kvadrata kamere</div>
  <div id="running-text-container" style="display: none;"><span></span></div>
  <div id="share-prompt-overlay" style="display: none;">KLIKNI ZELENI GUMB<br>I PODIJELI RAČUNATOR<br>PORUKA ĆE NESTATI</div>

  <div id="reader"></div>

  <button id="switch-camera-btn" style="display: none;">🔄</button>
  <div id="camera-selection-overlay" style="display: none;"><ul id="camera-list"></ul></div>
  
  <div id="loaded-message" style="display: none;">UČITANO</div>
  <div id="duplicate-warning" style="display: none;">TAJ RAČUN JE URAČUNAT</div>

  <div id="total-container"> <div id="total">UKUPNO: 0.00 €</div> <button id="ocisti-button" onclick="startOcistiConfirm()" style="display: none;">SPREMI<br>I OČISTI</button> </div>
  
  <div id="session-name-container">
      <div id="session-name-wrapper">
          <button id="add-name-btn" onclick="startAddName()">DODAJ NAZIV</button>
          <input type="text" id="session-name-input" placeholder="Unesi naziv sesije..." maxlength="30">
          <span id="session-name-display">
              <span id="session-name-text"></span>
              <span class="edit-icon" onclick="startAddName()">Uredi</span>
          </span>
      </div>
      <button id="manual-entry-btn">SAM UPIŠI RAČ:</button>
  </div>
  
  <div id="invoice-count">0 RAČUNA</div>
  <div id="history" style="display: none;"> <ul id="historyList"></ul> </div>
  <button class="red-btn" id="remove-from-list-btn" onclick="startRemoveFromList()" style="display:none;">Obriši iz liste</button>
  <button id="history-toggle-btn">POVIJEST</button>
  <button id="share-button" style="display: none;">DIJELI RAČUNATOR</button>
  <div id="delete-warning" style="display: none;"></div>

  <div id="history-page">
      <div id="history-sticky-header">
          <div id="history-header"> <button id="back-to-scanner-btn">< NA SKENER</button> <h1>POVIJEST</h1> </div>
          <div id="history-dynamic-header-content"></div>
      </div>
      <div id="history-content"></div>
  </div>

  <div id="manual-entry-modal-overlay" style="display: none;">
      <div id="manual-entry-modal-content">
          <h3 style="margin-top: 0; color: #333;">Ručni unos računa</h3>
          <div style="margin-bottom: 15px;">
              <label for="manual-amount-input">Iznos (€):</label>
              <input type="text" id="manual-amount-input" placeholder="npr. 15,99 ili 25.00">
          </div>
          <div style="margin-bottom: 20px;">
              <label for="manual-time-input">Vrijeme (HH:MM - opcionalno):</label>
              <input type="text" id="manual-time-input" placeholder="npr. 14:35" pattern="^([0-1]?\d|2[0-3]):([0-5]?\d)$">
          </div>
          <div style="display: flex; justify-content: space-around; gap: 10px;">
              <button id="manual-add-btn">Dodaj račun</button>
              <button id="manual-cancel-btn">Odustani</button>
          </div>
           <p id="manual-entry-error" style="color: red; font-size: 0.9em; margin-top: 10px; display: none;"></p>
      </div>
  </div>
  
  <input type="file" id="import-file-input" accept=".json">

  <audio id="scan-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/Učitano.mp3" preload="auto"></audio>
  <audio id="click-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/click8.mp3" preload="auto"></audio>
  <audio id="remove-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/smeče.mp3" preload="auto"></audio>
  <audio id="error-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/error.mp3" preload="auto"></audio>
  <audio id="clear-session-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/Čiščenje.mp3" preload="auto"></audio>

  <script>
    const MAX_HISTORY_ITEMS=500,LS_PREFIX="qr_",LS_KEYS={HISTORY:`${LS_PREFIX}history`,COUNTER1:`${LS_PREFIX}counter1`,COUNTER2:`${LS_PREFIX}counter2`,COUNTER_ACTIVE:`${LS_PREFIX}counterActive`,CAMERA_ID:`${LS_PREFIX}selectedCameraID`,USER_ID:`${LS_PREFIX}userID`,FIRST_USE:`${LS_PREFIX}firstUseTimestamp`,UNSAVED_COUNT:`${LS_PREFIX}unsavedCount`,UNSAVED_AMOUNT:`${LS_PREFIX}unsavedAmount`},APPS_SCRIPT_URL="https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMqcnA/exec",SECONDS_PER_CHARACTER=.2,MIN_MARQUEE_DURATION=5,MAX_MARQUEE_DURATION=40,DUPLICATE_LOG_COOLDOWN=5e3;let ukupno=0,povijest=[],removeConfirm=!1,ocistiConfirm=!1;const removeBtnInitialText="Obriši iz liste",ocistiBtnInitialText="SPREMI<br>I OČISTI",ocistiConfirmText="POTVRDI<br>SPREMANJE?";let html5QrCodeInstance=null,isScannerActive=!1,availableCameras=[],visibilityListenerAttached=!1,currentSessionName=null,removeNameConfirm=!1,currentlyViewedDate=new Date;currentlyViewedDate.setHours(0,0,0,0);let previousHistoryViewState="day-view",lastSearchTerm="",brojac=0,brojac2=0,tekstPoruka="",isCounterDecrementActive=!0,currentUserID=null,firstUseTimestamp=null,errorSoundCooldown=!1,ignoreErrorSoundUntil=0,messageTimeoutId=null,ignoreDuplicateLogUntil=0;let totalDiv,totalContainer,ocistiButton,invoiceCountDiv,historyList,removeButton,duplicateWarning,loadedMsg,instructionDiv,deleteWarningDiv,shareButton,readerDiv,historyToggleButton,historyDiv,historyPageDiv,backToScannerButton,historyContentDiv,sessionNameContainer,addNameBtn,sessionNameInput,sessionNameDisplay,sessionNameText,historyStickyHeaderDiv,historyDynamicHeaderContentDiv,runningTextContainer,runningTextSpan,sharePromptOverlay,counterDeactivatedIndicator,switchCameraButton,cameraSelectionOverlay,cameraListUl,manualEntryBtn,manualEntryModalOverlay,manualAmountInput,manualTimeInput,manualAddBtn,manualCancelBtn,manualEntryErrorMsg,importFileInput;const parseTime=e=>e&&"string"==typeof e&&"??:??"!==e&&5===e.length&&":"===e[2]?(()=>{const t=e.split(":"),a=parseInt(t[0],10),n=parseInt(t[1],10);return isNaN(a)||isNaN(n)||a<0||a>23||n<0||n>59?-1:60*a+n})():-1;function normalizeDateForSearch(e){if(!e||"string"!=typeof e)return null;const t=e.trim(),a=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(a){const e=parseInt(a[1],10),t=parseInt(a[2],10)-1,n=parseInt(a[3],10),i=new Date(e,t,n);if(i.getFullYear()===e&&i.getMonth()===t&&i.getDate()===n)return getISODateString(i)}const n=t.match(/^(\d{1,2})[.\/](\d{1,2})[.\/]((\d{4})|(\d{2}))$/);if(n){const e=parseInt(n[1],10),t=parseInt(n[2],10)-1;let a=parseInt(n[4]||n[5],10);a<100&&(a+=2e3);const i=new Date(a,t,e);if(i.getFullYear()===a&&i.getMonth()===t&&i.getDate()===e&&!isNaN(i.getTime()))return getISODateString(i)}return null}function playSound(e){if("error-sound"===e){if(errorSoundCooldown)return;errorSoundCooldown=!0,setTimeout(()=>{errorSoundCooldown=!1},500)}const t=document.getElementById(e);t?(t.pause(),t.currentTime=0,t.play().catch(e=>{"NotAllowedError"!==e.name&&"AbortError"!==e.name&&console.warn(`Zvuk "${e}" greška:`,e)})):console.warn(`Audio element "${e}" nije pronađen.`)}function getISODateString(e){if(!(e instanceof Date)||isNaN(e))return console.error("getISODateString primio neispravan datum:",e),null;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function showTemporaryMessage(e,t,a=1500){e&&(messageTimeoutId&&(clearTimeout(messageTimeoutId),messageTimeoutId=null),e.innerText=t,e.style.display="block",e.style.animation="none",requestAnimationFrame(()=>{e.offsetHeight,"loaded-message"===e.id?e.style.animation="zoomFade 1s ease-out":"duplicate-warning"===e.id}),messageTimeoutId=setTimeout(()=>{e&&e.innerText===t&&(e.style.display="none",messageTimeoutId=null)},a))}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function initializeUserTracking(){if(!(currentUserID=localStorage.getItem(LS_KEYS.USER_ID)))try{console.log("Generiram novi UserID i FirstUseTimestamp."),currentUserID=generateUUID(),firstUseTimestamp=(new Date).toISOString(),localStorage.setItem(LS_KEYS.USER_ID,currentUserID),localStorage.setItem(LS_KEYS.FIRST_USE,firstUseTimestamp)}catch(e){console.error("Greška spremanja UserID/FirstUse u localStorage:",e),currentUserID="localStorage_error_"+generateUUID(),firstUseTimestamp=(new Date).toISOString()}console.log("UserID:",currentUserID,"FirstUse:",firstUseTimestamp)}async function sendLogData(e){if(!APPS_SCRIPT_URL||APPS_SCRIPT_URL.includes("URL_TVOJE_WEB_APLIKACIJE")||APPS_SCRIPT_URL.includes("AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMcnA"))return void console.warn("Logovanje onemogućeno: APPS_SCRIPT_URL nije postavljen ili je neispravan.");const t={...e,UserID:currentUserID,FirstUseTimestamp:firstUseTimestamp,Timestamp:(new Date).toISOString(),Counter1:brojac,Counter2:brojac2,Active:isCounterDecrementActive,UserAgent:navigator.userAgent};console.log(`Pokušavam poslati log '${t.Event}'...`);try{await fetch(APPS_SCRIPT_URL,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",body:JSON.stringify(t)}),console.log(`Log zahtev '${t.Event}' poslan (no-cors). Proverite Apps Script logove za potvrdu.`)}catch(e){console.error(`Greška prilikom slanja loga '${t.Event}':`,e)}}function saveFullHistoryToLocalStorage(e){try{localStorage.setItem(LS_KEYS.HISTORY,JSON.stringify(e)),console.log("Puna povijest spremljena.")}catch(e){console.error("Greška spremanja:",e),alert("Greška: Nije moguće spremiti povijest.")}}function loadFullHistoryFromLocalStorage(){try{const e=localStorage.getItem(LS_KEYS.HISTORY);return e?JSON.parse(e).map(e=>({timestamp:e.timestamp||Date.now(),lastQrTime:e.lastQrTime||"??:??",name:e.name||null,racuni:Array.isArray(e.racuni)?e.racuni.map(e=>({...e,scanTimestamp:e.scanTimestamp||0})):[]])):[]}catch(e){return console.error("Greška učitavanja:",e),[]}}function loadCountersState(){const e=localStorage.getItem(LS_KEYS.COUNTER1),t=localStorage.getItem(LS_KEYS.COUNTER2),a=localStorage.getItem(LS_KEYS.COUNTER_ACTIVE);brojac=null!==e?parseInt(e,10):null,brojac2=null!==t?parseInt(t,0):0,isCounterDecrementActive="true"===a,isNaN(brojac)&&(brojac=null),isNaN(brojac2)&&(brojac2=0),console.log("Učitano stanje:",{brojac,brojac2,isCounterDecrementActive}),updateDeactivatedIndicator()}function saveBrojac(){localStorage.setItem(LS_KEYS.COUNTER1,brojac)}function saveBrojac2(){localStorage.setItem(LS_KEYS.COUNTER2,brojac2)}function saveCounterActiveState(){localStorage.setItem(LS_KEYS.COUNTER_ACTIVE,isCounterDecrementActive)}async function fetchSheetData(){return console.log("Pokušavam dohvatiti podatke iz Google Sheeta..."),!APPS_SCRIPT_URL||APPS_SCRIPT_URL.includes("URL_TVOJE_WEB_APLIKACIJE")||APPS_SCRIPT_URL.includes("AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA")?(console.warn("Dohvaćanje iz Sheeta onemogućeno: APPS_SCRIPT_URL nije postavljen ili je neispravan."),tekstPoruka="",initializeCounters(),updateRunningText(),Promise.reject(new Error("URL za Sheet nije postavljen/ispravan"))):void(await fetch(APPS_SCRIPT_URL).then(e=>{if(!e.ok)throw new Error(`HTTP greška ${e.status}`);return e.json()}).then(e=>{console.log("Podaci dohvaćeni:",e);let t=void 0!==e.pragBrojac?parseInt(e.pragBrojac,10):0;t=isNaN(t)||t<0?0:t>500?500:t,brojac2=t,saveBrojac2(),tekstPoruka=e.trceciTekst||"",initializeCounters(),updateRunningText()}).catch(e=>{console.error("Greška pri dohvaćanju podataka iz Sheeta:",e),tekstPoruka="",initializeCounters(),updateRunningText()}))}function initializeCounters(){console.log("Inicijalizacija brojača..."),null===brojac?(console.log("Brojač 1 nije inicijaliziran, postavljanje na brojač 2."),brojac=brojac2,saveBrojac()):console.log("Brojač 1 učitan s vrijednošću:",brojac),checkSharePrompt(),updateRunningTextVisibility()}function checkOcistiButtonVisibility(){ocistiButton&&(ocistiButton.style.display=povijest.length>0||currentSessionName?"block":"none",0!==povijest.length||currentSessionName||!ocistiConfirm||resetOcistiMode())}function updateDisplay(){totalDiv&&(totalDiv.innerText=`UKUPNO: ${ukupno.toFixed(2)} €`);const e=povijest.length;invoiceCountDiv&&(invoiceCountDiv.innerText=`${e} ${1===e?"RAČUN":"RAČUNA"}`),document.body.classList.contains("scanner-view")&&(updateSmallHistoryList(),checkRemoveButtonVisibility(),handleInfoDeleteMessageVisibility(),checkOcistiButtonVisibility(),updateNameDisplay())}function updateSmallHistoryList(){if(historyList&&historyDiv)if(povijest.length>0){historyDiv.style.display="block",historyList.innerHTML="";const e=povijest;e.forEach((t,a)=>{const n=povijest.length-e.length+a,i=document.createElement("li");i.innerText=`${n+1}. ${t.time} - ${t.amount.toFixed(2)} €`,historyList.appendChild(i)}),historyDiv.scrollTop=historyDiv.scrollHeight}else historyDiv.style.display="none"}function checkRemoveButtonVisibility(){removeButton&&(removeButton.style.display=povijest.length>0||currentSessionName?"block":"none",0===povijest.length&&!currentSessionName&&(removeConfirm||removeNameConfirm)&&resetRemoveMode())}function handleInfoDeleteMessageVisibility(){const e=document.body.classList.contains("scanner-view");if(!deleteWarningDiv||!e)return void(deleteWarningDiv&&(deleteWarningDiv.style.display="none"));let t=!1,a="",n="";removeConfirm&&povijest.length>0?(a=`OBRIŠI ${povijest[povijest.length-1].time} = ${povijest[povijest.length-1].amount.toFixed(2)} €?`,n="delete-mode",t=!0):removeNameConfirm&&currentSessionName?(a=`OBRIŠI NAZIV "${currentSessionName}"?`,n="delete-mode",t=!0):!removeConfirm&&!removeNameConfirm&&povijest.length>0&&deleteWarningDiv.dataset.lastScanText?(a=deleteWarningDiv.dataset.lastScanText,n="info-mode",t=!0):!removeConfirm&&!removeNameConfirm&&0===povijest.length&&currentSessionName&&deleteWarningDiv.dataset.lastNameText&&(a=deleteWarningDiv.dataset.lastNameText,n="info-mode",t=!0),t?(deleteWarningDiv.innerText=a,deleteWarningDiv.className=`delete-warning ${n}`,deleteWarningDiv.style.display="block"):(deleteWarningDiv.style.display="none")}function updateRunningText(){if(runningTextSpan){if(runningTextSpan.textContent=tekstPoruka,tekstPoruka&&tekstPoruka.length>0){let e=tekstPoruka.length*SECONDS_PER_CHARACTER;e=Math.max(MIN_MARQUEE_DURATION,Math.min(MAX_MARQUEE_DURATION,e)),e=Math.max(e,.1),runningTextSpan.style.animation="none",requestAnimationFrame(()=>{runningTextSpan.offsetHeight,runningTextSpan.style.animation=`marquee ${e}s linear infinite`})}else runningTextSpan.style.animation="none"}updateRunningTextVisibility()}function updateRunningTextVisibility(){const e=manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display,t=tekstPoruka&&(!sharePromptOverlay||"none"===sharePromptOverlay.style.display)&&!e&&document.body.classList.contains("scanner-view");runningTextContainer&&(runningTextContainer.style.display=t?"block":"none")}function checkSharePrompt(){const e=manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display,t=0===brojac&&brojac2>0&&!e&&document.body.classList.contains("scanner-view");sharePromptOverlay&&(sharePromptOverlay.style.display=t?"flex":"none",updateRunningTextVisibility())}function updateDeactivatedIndicator(){const e=manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display;counterDeactivatedIndicator&&(counterDeactivatedIndicator.style.display=!isCounterDecrementActive&&document.body.classList.contains("scanner-view")&&!e?"block":"none")}function resetRemoveMode(){removeButton&&(removeButton.innerText=removeBtnInitialText,removeButton.classList.remove("yellow-btn"),removeButton.classList.add("red-btn"),removeConfirm=!1,removeNameConfirm=!1),deleteWarningDiv&&(deleteWarningDiv.dataset.beforeConfirmText?deleteWarningDiv.dataset.lastScanText=deleteWarningDiv.dataset.beforeConfirmText:deleteWarningDiv.dataset.beforeConfirmNameText?(deleteWarningDiv.dataset.lastNameText=deleteWarningDiv.dataset.beforeConfirmNameText,delete deleteWarningDiv.dataset.beforeConfirmNameText):0!==povijest.length||currentSessionName||(delete deleteWarningDiv.dataset.lastScanText,delete deleteWarningDiv.dataset.lastNameText)),handleInfoDeleteMessageVisibility(),checkRemoveButtonVisibility()}function resetOcistiMode(){ocistiButton&&(ocistiButton.innerHTML=ocistiBtnInitialText,ocistiButton.classList.remove("confirm-mode"),ocistiConfirm=!1,checkOcistiButtonVisibility())}function startAddName(){addNameBtn&&sessionNameInput&&sessionNameDisplay&&document.body.classList.contains("scanner-view")&&(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),playSound("click-sound"),addNameBtn.style.display="none",sessionNameDisplay.style.display="none",sessionNameInput.style.display="block",sessionNameInput.value=currentSessionName||"",sessionNameInput.focus(),sessionNameInput.select())}function saveName(){if(sessionNameInput&&addNameBtn&&sessionNameDisplay&&sessionNameText){if("none"===sessionNameInput.style.display)return;const e=sessionNameInput.value.trim();if("##--##"===e)return showTemporaryMessage(loadedMsg,"RJEŠENO"),isCounterDecrementActive=!1,saveCounterActiveState(),updateDeactivatedIndicator(),sessionNameInput.value="",sessionNameInput.style.display="none",updateNameDisplay(),checkRemoveButtonVisibility(),removeNameConfirm&&resetRemoveMode(),void sendLogData({Event:"cheat_code_deactivate",Details:"##--##"});if("##00##"===e)return showTemporaryMessage(loadedMsg,"RESETIRANO"),brojac=0,brojac2=0,isCounterDecrementActive=!0,saveBrojac(),saveBrojac2(),saveCounterActiveState(),localStorage.removeItem(LS_KEYS.CAMERA_ID),updateDeactivatedIndicator(),sessionNameInput.value="",sessionNameInput.style.display="none",updateNameDisplay(),checkSharePrompt(),updateRunningTextVisibility(),checkRemoveButtonVisibility(),removeNameConfirm&&resetRemoveMode(),void sendLogData({Event:"cheat_code_reset",Details:"##00##"});const t=currentSessionName;currentSessionName=e||null,deleteWarningDiv&&(currentSessionName?deleteWarningDiv.dataset.lastNameText=`NAZIV: "${currentSessionName}"`:delete deleteWarningDiv.dataset.lastNameText),t!==currentSessionName&&sendLogData({Event:"session_name_changed",Details:currentSessionName||"removed"}),sessionNameInput.style.display="none",updateNameDisplay(),checkRemoveButtonVisibility(),handleInfoDeleteMessageVisibility()}}function updateNameDisplay(){addNameBtn&&sessionNameDisplay&&sessionNameText&&(currentSessionName?(sessionNameText.textContent=currentSessionName,sessionNameDisplay.style.display="flex",addNameBtn.style.display="none"):(sessionNameDisplay.style.display="none",addNameBtn.style.display="block"))}function startRemoveFromList(){if(removeButton&&document.body.classList.contains("scanner-view")){if(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),removeNameConfirm)return playSound("remove-sound"),sendLogData({Event:"session_name_removed_confirmed",Details:currentSessionName||"N/A"}),currentSessionName=null,deleteWarningDiv&&delete deleteWarningDiv.dataset.lastNameText,resetRemoveMode(),updateNameDisplay(),void checkRemoveButtonVisibility();if(removeConfirm){if(povijest.length>0){const e=povijest.pop();ukupno-=e.amount,playSound("remove-sound");const t={amount:e.amount,time:e.time,isManual:e.qrCode.startsWith("MANUAL_")};sendLogData({Event:"last_invoice_removed_confirmed",Details:JSON.stringify(t)}),0===povijest.length&&currentSessionName?(removeButton.innerHTML="Obriši<br>Naziv?",removeButton.classList.remove("red-btn"),removeButton.classList.add("yellow-btn"),removeConfirm=!1,removeNameConfirm=!0,deleteWarningDiv&&(delete deleteWarningDiv.dataset.lastScanText,deleteWarningDiv.dataset.beforeConfirmNameText=deleteWarningDiv.innerText),handleInfoDeleteMessageVisibility()):(povijest.length>0?deleteWarningDiv&&(deleteWarningDiv.dataset.lastScanText=`ZADNJI RAČUN: ${povijest[povijest.length-1].time} = ${povijest[povijest.length-1].amount.toFixed(2)} €`):deleteWarningDiv&&(delete deleteWarningDiv.dataset.lastScanText),resetRemoveMode())}else resetRemoveMode(),console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva.");return void updateDisplay()}povijest.length>0?(playSound("click-sound"),removeButton.innerText="Potvrdi",removeButton.classList.remove("red-btn"),removeButton.classList.add("yellow-btn"),removeConfirm=!0,removeNameConfirm=!1,deleteWarningDiv&&(deleteWarningDiv.dataset.beforeConfirmText=deleteWarningDiv.dataset.lastScanText),handleInfoDeleteMessageVisibility(),sendLogData({Event:"last_invoice_remove_prompt"})):currentSessionName?(playSound("click-sound"),removeButton.innerHTML="Obriši<br>Naziv?",removeButton.classList.remove("red-btn"),removeButton.classList.add("yellow-btn"),removeConfirm=!1,removeNameConfirm=!0,deleteWarningDiv&&(deleteWarningDiv.dataset.beforeConfirmNameText=deleteWarningDiv.innerText),handleInfoDeleteMessageVisibility(),sendLogData({Event:"session_name_remove_prompt"})):(resetRemoveMode(),console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva."))}}function startOcistiConfirm(){ocistiButton&&document.body.classList.contains("scanner-view")&&(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),ocistiConfirm?(ocistiTrenutnoSkeniranje(),resetOcistiMode(),playSound("clear-session-sound")):(ocistiButton.innerHTML=ocistiConfirmText,ocistiButton.classList.add("confirm-mode"),ocistiConfirm=!0,sendLogData({Event:"save_session_prompt"})))}function ocistiTrenutnoSkeniranje(){if(0===povijest.length&&!currentSessionName)return void console.warn("Pokušaj spremanja prazne sesije.");const e=Date.now(),t=[...povijest].sort((e,t)=>{const a=parseTime(e.time),n=parseTime(t.time);return-1===a&&-1!==n?-1:-1!==a&&-1===n?1:-1===a&&-1===n?(e.scanTimestamp||0)-(t.scanTimestamp||0):a-n});let a="??:??";for(let e=t.length-1;e>=0;e--)if(t[e].time&&"??:??"!==t[e].time){a=t[e].time;break}const n={timestamp:e,lastQrTime:a,name:currentSessionName||null,racuni:t};console.log("Spremam sesiju:",n);let i=loadFullHistoryFromLocalStorage();i.push(n),saveFullHistoryToLocalStorage(i);const o=n.racuni.reduce((e,t)=>e+t.amount,0),r={sessionName:n.name,invoiceCount:n.racuni.length,totalAmount:o.toFixed(2),lastQrTime:n.lastQrTime};sendLogData({Event:"session_saved",Details:JSON.stringify(r)});try{localStorage.removeItem(LS_KEYS.UNSAVED_COUNT),localStorage.removeItem(LS_KEYS.UNSAVED_AMOUNT),console.log("Obrisano nesačuvano stanje nakon spremanja sesije.")}catch(e){console.error("Greška brisanja nesačuvanog stanja u localStorage:",e)}povijest=[],ukupno=0,currentSessionName=null,deleteWarningDiv&&(delete deleteWarningDiv.dataset.lastScanText,delete deleteWarningDiv.dataset.beforeConfirmText,delete deleteWarningDiv.dataset.lastNameText,delete deleteWarningDiv.dataset.beforeConfirmNameText),resetRemoveMode(),updateDisplay(),console.log("Trenutna sesija spremljena i očišćena.")}function handleScan(e){if(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),removeNameConfirm&&resetRemoveMode(),removeConfirm&&resetRemoveMode(),ocistiConfirm&&resetOcistiMode(),duplicateWarning&&(duplicateWarning.style.display="none"),e.includes("HRVHUB30")){try{const t=e.split("?")[1];if(!t)throw new Error("Invalid QR format");const a=new URLSearchParams(t),n=a.get("izn"),i=a.get("datv");if(!n||isNaN(parseFloat(n)))throw new Error("Invalid 'izn'");let o=!1;povijest.some(t=>t.qrCode===e)&&(o=!0);let r=!1;const s=loadFullHistoryFromLocalStorage();if(s.length>0){const e=Date.now()-2592e6;r=s.filter(t=>t.timestamp>=e).some(e=>e.racuni.some(t=>t.qrCode===e))}if(o||r)return console.warn("Duplikat pronađen:",e),void(Date.now()>=ignoreErrorSoundUntil?(playSound("error-sound"),showTemporaryMessage(duplicateWarning,"TAJ RAČUN JE URAČUNAT",1500),Date.now()>=ignoreDuplicateLogUntil&&(sendLogData({Event:"scan_duplicate"}),ignoreDuplicateLogUntil=Date.now()+DUPLICATE_LOG_COOLDOWN,console.log(`Duplicate log sent. Next duplicate log ignored until ${new Date(ignoreDuplicateLogUntil).toLocaleTimeString()} (global cooldown).`))):console.log(`Duplicate ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}). No log sent.`));const c=parseFloat(n)/100;let l="??:??";if(i&&"string"==typeof i){let e=null,t=null;const a=i.indexOf("_"),n=i.toUpperCase().indexOf("T");8===a&&i.length>=13?(e=i.substring(9,11),t=i.substring(11,13)):8===n&&i.length>=13?(e=i.substring(9,11),t=i.substring(11,13)):12===i.length&&(e=i.substring(8,10),t=i.substring(10,12));if(e&&t){const a=parseInt(e,10),n=parseInt(t,10);l=isNaN(a)||isNaN(n)||a<0||a>23||n<0||n>59?"??:??":`${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`}}instructionDiv&&(instructionDiv.style.display="none");const u={amount:c,qrCode:e,time:l,datv:i||"",scanTimestamp:Date.now()};povijest.push(u),ukupno+=c,isCounterDecrementActive&&brojac>0&&(brojac--,console.log("Brojač smanjen na:",brojac),saveBrojac(),checkSharePrompt());try{localStorage.setItem(LS_KEYS.UNSAVED_COUNT,povijest.length),localStorage.setItem(LS_KEYS.UNSAVED_AMOUNT,ukupno)}catch(e){console.error("Greška spremanja nesačuvanog stanja u localStorage:",e)}playSound("scan-sound"),ignoreErrorSoundUntil=Date.now()+2e3,updateDisplay(),showTemporaryMessage(loadedMsg,"UČITANO",1e3),deleteWarningDiv&&(deleteWarningDiv.dataset.lastScanText=`ZADNJI RAČUN: ${u.time} = ${u.amount.toFixed(2)} €`,handleInfoDeleteMessageVisibility());const d={amount:u.amount,time:u.time,sessionInvoiceNumber:povijest.length};sendLogData({Event:"scan_success",Details:JSON.stringify(d)})}catch(t){console.error("Greška obrade QR (parse error):",t,e),Date.now()>=ignoreErrorSoundUntil?(playSound("error-sound"),showTemporaryMessage(loadedMsg,"GREŠKA SKENIRANJA!",1500)):console.log(`Parse error ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}).`),sendLogData({Event:"scan_parse_error",Details:{message:t.message,qrCodeStart:e.substring(0,50)+"..."}})}else console.warn("QR kod nije u HRVHUB30 formatu. Ignoriram."),Date.now()>=ignoreErrorSoundUntil?(playSound("error-sound"),showTemporaryMessage(loadedMsg,"POGREŠAN QR KOD!",1500)):console.log(`Non-HRVHUB30 QR ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}).`),sendLogData({Event:"scan_wrong_qr_format",Details:{qrCodeStart:e.substring(0,50)+"..."}})}function startScannerWithCameraSelection(e,t){if(!e||0===e.length)return readerDiv&&(readerDiv.innerHTML='<div style="padding: 20px; color: red;">Nema dostupnih kamera na uređaju.</div>'),console.warn("Nema dostupnih kamera za startanje skenera."),instructionDiv&&(instructionDiv.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),isScannerActive=!1,void(html5QrCodeInstance=null);let a=null;const n=localStorage.getItem(LS_KEYS.CAMERA_ID);if(n){e.some(e=>e.id===n)?(console.log("Koristim spremljenu kameru:",n),a=n):(console.warn("Spremljena kamera nije pronađena, brišem iz localStorage."),localStorage.removeItem(LS_KEYS.CAMERA_ID))}if(!a){const t=e.find(e=>e.label.toLowerCase().includes("back")||e.label.toLowerCase().includes("zadnja")||e.label.toLowerCase().includes("environment"));t?(console.log("Koristim pronađenu stražnju kameru:",t.id),a=t.id):(console.log("Nema stražnje kamere, koristim prvu dostupnu:",e[0].id),a=e[0].id)}!a&&e.length>0&&(a=e[0].id,console.warn("Fallback na prvu kameru ID:",a));const i=a;if(!i)return console.error("Kritična greška: Nije bilo moguće odabrati kameru za start."),readerDiv&&(readerDiv.innerHTML='<div style="padding: 20px; color: red;">Greška: Nije moguće odabrati kameru.</div>'),instructionDiv&&(instructionDiv.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),isScannerActive=!1,void(html5QrCodeInstance=null);requestAnimationFrame(()=>{if(!html5QrCodeInstance||isScannerActive||document.body.classList.contains("history-view"))return;if(isElementOrParentHidden(readerDiv))return readerDiv&&(readerDiv.innerHTML='<div style="padding:20px; color: red;">Greška: Reader element je skriven.</div>'),console.error("[startScannerWithCameraSelection][rAF] Reader je skriven, ne mogu startati kameru."),isScannerActive=!1,void(html5QrCodeInstance=null);console.log(`[startScannerWithCameraSelection][rAF] Pokušavam startati kameru: ${i}`),html5QrCodeInstance.start(i,t,handleScan,e=>{}).then(()=>{console.log(`>>> [startScannerWithCameraSelection][rAF] start() OK za kameru: ${i}`),isScannerActive=!0,localStorage.setItem(LS_KEYS.CAMERA_ID,i),console.log("Spremljen ID aktivne kamere u localStorage:",i),switchCameraButton&&availableCameras.length>1&&(switchCameraButton.style.display="block"),setTimeout(()=>{instructionDiv&&document.body.classList.contains("scanner-view")&&(instructionDiv.style.display="block")},50)}).catch(e=>{console.error(`>>> [startScannerWithCameraSelection][rAF] start() FAILED za kameru ${i}:`,e),isScannerActive=!1,html5QrCodeInstance=null,readerDiv&&(readerDiv.innerHTML=`<div style="padding: 20px; color: red;">Greška startanja kamere (${e.name||e.message||e}). Provjerite dozvole ili pokušajte odabrati drugu kameru.</div>`),instructionDiv&&(instructionDiv.style.display="none"),switchCameraButton&&availableCameras.length>1&&(switchCameraButton.style.display="block"),sendLogData({Event:"camera_start_failed",Details:{cameraId:i,errorName:e.name,errorMessage:e.message}})})})}function isElementOrParentHidden(e){if(!e)return!0;for(;e&&e!==document.body;){if("none"===window.getComputedStyle(e).display)return!0;e=e.parentElement}return!1}function initializeScanner(){if(document.body.classList.contains("history-view")||isScannerActive)return void(isScannerActive&&document.body.classList.contains("scanner-view")&&switchCameraButton&&availableCameras.length>1&&(switchCameraButton.style.display="block"));console.log("[initializeScanner] Pokrećem..."),readerDiv&&(readerDiv.innerHTML=""),instructionDiv&&(instructionDiv.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),cameraSelectionOverlay&&(cameraSelectionOverlay.style.display="none"),loadedMsg&&(loadedMsg.style.display="none"),duplicateWarning&&(duplicateWarning.style.display="none"),manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&hideManualEntryModal(),checkSharePrompt(),updateRunningTextVisibility(),updateDeactivatedIndicator(),html5QrCodeInstance=new Html5Qrcode("reader");const e={fps:10,qrbox:{width:250,height:250}};0===availableCameras.length?(console.log("[initializeScanner] Dohvaćam popis kamera prvi put..."),Html5Qrcode.getCameras().then(t=>{console.log("[initializeScanner] Dostupne kamere (inicijalno dohvatio):",t),availableCameras=t,startScannerWithCameraSelection(t,e)}).catch(t=>{console.error("[initializeScanner] Greška dohvaćanja kamera (getCameras failed):",t),isScannerActive=!1,availableCameras=[],readerDiv&&(readerDiv.innerHTML=`<div style="padding: 20px; color: red;">Greška pristupa kamerama (${t.name||t.message||t}). Provjerite dozvole.</div>`),instructionDiv&&(instructionDiv.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),html5QrCodeInstance=null,sendLogData({Event:"get_cameras_failed",Details:{errorName:t.name,errorMessage:t.message}})})):(console.log("[initializeScanner] Koristim već dohvaćeni popis kamera:",availableCameras),startScannerWithCameraSelection(availableCameras,e))}function stopScanner(){console.log("stopScanner: Pokrenuto."),runningTextContainer&&(runningTextContainer.style.display="none"),sharePromptOverlay&&(sharePromptOverlay.style.display="none"),counterDeactivatedIndicator&&(counterDeactivatedIndicator.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),cameraSelectionOverlay&&(cameraSelectionOverlay.style.display="none"),loadedMsg&&(loadedMsg.style.display="none"),duplicateWarning&&(duplicateWarning.style.display="none"),manualEntryModalOverlay&&(manualEntryModalOverlay.style.display="none");const e=html5QrCodeInstance;return e&&isScannerActive?(console.log("Zaustavljam skener (instance postoji i active je)..."),isScannerActive=!1,instructionDiv&&(instructionDiv.style.display="none"),Promise.race([e.stop(),new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout waiting for stop()")),3e3))]).then(()=>{console.log("Skener uspješno zaustavljen.")}).catch(e=>{console.warn("Greška ili timeout pri zaustavljanju skenera:",e),sendLogData({Event:"camera_stop_failed",Details:{errorName:e.name,errorMessage:e.message}})}).finally(()=>{readerDiv&&(readerDiv.innerHTML=""),html5QrCodeInstance=null})):(isScannerActive=!1,readerDiv&&(readerDiv.innerHTML=""),html5QrCodeInstance=null,Promise.resolve())}function toggleCameraSelection(){if(playSound("click-sound"),!cameraSelectionOverlay||!cameraListUl||!switchCameraButton)return void console.error("Nedostaju elementi za odabir kamere.");if(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),!availableCameras||availableCameras.length<=1)return showTemporaryMessage(loadedMsg,"Nema drugih kamera za odabir.",1500),void(cameraSelectionOverlay.style.display="none");if("block"===cameraSelectionOverlay.style.display)return void(cameraSelectionOverlay.style.display="none");cameraListUl.innerHTML="";const e=localStorage.getItem(LS_KEYS.CAMERA_ID);availableCameras.forEach(t=>{const a=document.createElement("li");a.textContent=t.label||`Kamera ${t.id.substring(0,8)}...`,a.dataset.cameraId=t.id,a.title=t.label||t.id,t.id===e&&a.classList.add("selected-camera"),a.addEventListener("click",()=>{switchCamera(t.id,t.label)}),cameraListUl.appendChild(a)}),cameraSelectionOverlay.style.display="block"}function switchCamera(e,t){playSound("click-sound"),console.log(`Odabrana kamera: ID=${e}, Label=${t||"N/A"}`),cameraSelectionOverlay&&(cameraSelectionOverlay.style.display="none");const a=localStorage.getItem(LS_KEYS.CAMERA_ID);if(e===a&&isScannerActive)return console.log("Odabrana je već aktivna kamera, nema potrebe za restartom."),showTemporaryMessage(loadedMsg,`Kamera: ${t||"Već aktivna"}`,1500),void sendLogData({Event:"camera_switch_selected_same",Details:{cameraId:e,label:t}});localStorage.setItem(LS_KEYS.CAMERA_ID,e),sendLogData({Event:"camera_switch_attempt",Details:{cameraId:e,label:t}}),showTemporaryMessage(loadedMsg,`Mijenjam na: ${t||"Kamera"}...`,1e3),stopScanner().finally(()=>{console.log("Nakon stopScanner, pozivam initializeScanner za novu kameru."),initializeScanner()})}function showManualEntryModal(){manualEntryBtn&&manualEntryModalOverlay&&manualAmountInput&&manualTimeInput&&manualEntryErrorMsg&&document.body.classList.contains("scanner-view")?(loadedMsg&&(loadedMsg.style.display="none"),duplicateWarning&&(duplicateWarning.style.display="none"),cameraSelectionOverlay&&(cameraSelectionOverlay.style.display="none"),updateRunningTextVisibility(),checkSharePrompt(),updateDeactivatedIndicator(),playSound("click-sound"),sendLogData({Event:"manual_entry_modal_opened"}),manualAmountInput.value="",manualTimeInput.value="",manualEntryErrorMsg.innerText="",manualEntryErrorMsg.style.display="none",(()=>{const e=new Date,t=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");manualTimeInput.value=`${t}:${a}`})(),manualEntryModalOverlay.style.display="flex",manualAmountInput.focus()):console.warn("Ne mogu prikazati modal za ručni unos (DOM elementi nedostaju ili nije scanner view).")}function hideManualEntryModal(){manualEntryModalOverlay&&(manualEntryModalOverlay.style.display="none",manualAmountInput.value="",manualTimeInput.value="",manualEntryErrorMsg.innerText="",manualEntryErrorMsg.style.display="none",updateRunningTextVisibility(),checkSharePrompt(),updateDeactivatedIndicator())}function addManualEntry(){if(manualAmountInput&&manualTimeInput&&manualEntryErrorMsg){manualEntryErrorMsg.innerText="",manualEntryErrorMsg.style.display="none";const e=manualAmountInput.value.trim().replace(",","."),t=manualTimeInput.value.trim(),a=parseFloat(e);if(isNaN(a)||a<=0)return manualEntryErrorMsg.innerText="Molimo unesite ispravan iznos veći od 0.",manualEntryErrorMsg.style.display="block",manualAmountInput.focus(),void sendLogData({Event:"manual_entry_add_failed",Details:"invalid_amount"});let n="??:??";if(t){const e=t.match(/^([0-1]?\d|2[0-3]):([0-5]?\d)$/);e?(n=`${String(parseInt(e[1],10)).padStart(2,"0")}:${String(parseInt(e[2],10)).padStart(2,"0")}`):(console.warn("Neispravan format vremena unesen (manual entry):",t),manualEntryErrorMsg.innerText='Upozorenje: Vrijeme nije u formatu HH:MM. Dodano kao "??:??".',manualEntryErrorMsg.style.display="block")}const i={amount:a,qrCode:`MANUAL_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,time:n,datv:null,scanTimestamp:Date.now()};povijest.push(i),ukupno+=a,isCounterDecrementActive&&brojac>0&&(brojac--,console.log("Brojač smanjen (ručni unos) na:",brojac),saveBrojac(),checkSharePrompt());try{localStorage.setItem(LS_KEYS.UNSAVED_COUNT,povijest.length),localStorage.setItem(LS_KEYS.UNSAVED_AMOUNT,ukupno)}catch(e){console.error("Greška spremanja nesačuvanog stanja (ručni unos) u localStorage:",e)}updateDisplay(),showTemporaryMessage(loadedMsg,"RUČNO DODANO",1e3),playSound("scan-sound"),deleteWarningDiv&&(deleteWarningDiv.dataset.lastScanText=`ZADNJI DODAN: ${i.time} = ${i.amount.toFixed(2)} €`,handleInfoDeleteMessageVisibility()),hideManualEntryModal();const o={amount:a,time:n,sessionInvoiceNumber:povijest.length,isManual:!0};sendLogData({Event:"manual_entry_added",Details:JSON.stringify(o)})}else console.error("Nedostaju elementi za dodavanje ručnog unosa.")}function cancelManualEntry(){manualEntryModalOverlay&&(playSound("click-sound"),hideManualEntryModal(),sendLogData({Event:"manual_entry_cancelled"}))}function switchToScannerView(){if(console.log("switchToScannerView: Pokrenuto."),document.body.classList.contains("scanner-view"))return void(isScannerActive?switchCameraButton&&availableCameras.length>1&&(switchCameraButton.style.display="block"):(console.log("switchToScannerView: Skener nije aktivan, inicijaliziram..."),initializeScanner()),visibilityListenerAttached||attachVisibilityListener());const e=document.getElementById("clear-history-btn");e&&"true"===e.dataset.confirming&&(e.innerText="IZBRIŠI SVU POVIJEST",e.classList.remove("confirm-mode"),e.dataset.confirming="false");const t=document.getElementById("delete-session-btn");t&&"true"===t.dataset.confirming&&(t.innerText="IZBRIŠI OVAJ SKEN",t.classList.remove("confirm-mode"),t.dataset.confirming="false");const a=document.getElementById("clear-day-btn");a&&"true"===a.dataset.confirming&&(a.innerText="IZBRIŠI OVAJ DAN",a.classList.remove("confirm-mode"),a.dataset.confirming="false"),historyDynamicHeaderContentDiv&&(historyDynamicHeaderContentDiv.innerHTML=""),document.getElementById("search-container")&&(document.getElementById("search-container").style.display="none"),document.getElementById("all-days-search-container")&&(document.getElementById("all-days-search-container").style.display="none"),document.getElementById("export-history-btn")&&(document.getElementById("export-history-btn").style.display="none"),document.getElementById("import-history-btn")&&(document.getElementById("import-history-btn").style.display="none"),document.body.classList.remove("history-view"),document.body.classList.add("scanner-view"),document.body.style.backgroundColor="#f4f4f4",currentlyViewedDate=new Date,currentlyViewedDate.setHours(0,0,0,0),previousHistoryViewState="day-view",updateDisplay(),requestAnimationFrame(initializeScanner),visibilityListenerAttached||attachVisibilityListener(),console.log("switchToScannerView: Završeno.")}function switchToHistoryView(){console.log("switchToHistoryView: Pokrenuto."),document.body.classList.contains("history-view")?renderHistoryView(currentlyViewedDate):(removeConfirm||removeNameConfirm&&resetRemoveMode(),ocistiConfirm&&resetOcistiMode(),manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&cancelManualEntry(),console.log("switchToHistoryView: Zaustavljam skener..."),stopScanner().finally(()=>{console.log("switchToHistoryView: Skener zaustavljen (ili nije bio aktivan). Mijenjam klase i renderiram."),document.body.classList.remove("scanner-view"),document.body.classList.add("history-view"),document.body.style.backgroundColor="white",counterDeactivatedIndicator&&(counterDeactivatedIndicator.style.display="none"),switchCameraButton&&(switchCameraButton.style.display="none"),cameraSelectionOverlay&&(cameraSelectionOverlay.style.display="none"),instructionDiv&&(instructionDiv.style.display="none"),runningTextContainer&&(runningTextContainer.style.display="none"),sharePromptOverlay&&(sharePromptOverlay.style.display="none"),loadedMsg&&(loadedMsg.style.display="none"),duplicateWarning&&(duplicateWarning.style.display="none"),currentlyViewedDate=new Date,currentlyViewedDate.setHours(0,0,0,0),previousHistoryViewState="day-view",renderHistoryView(currentlyViewedDate),console.log("switchToHistoryView: Renderiranje završeno.")}))}function clearDynamicHeaderContent(){historyDynamicHeaderContentDiv&&(historyDynamicHeaderContentDiv.innerHTML="")}function renderHistoryView(e=currentlyViewedDate){console.log("renderHistoryView: Pokrenuto za datum:",e),previousHistoryViewState="day-view",currentlyViewedDate=new Date(e),currentlyViewedDate.setHours(0,0,0,0);const t=loadFullHistoryFromLocalStorage();if(!historyContentDiv||!historyPageDiv||!historyDynamicHeaderContentDiv)return void console.error("renderHistoryView: Kritični DOM elementi nedostaju!");clearDynamicHeaderContent();const a={weekday:"long"},n={day:"2-digit",month:"2-digit",year:"numeric"};let i=currentlyViewedDate.toLocaleDateString("hr-HR",a);i=i.charAt(0).toUpperCase()+i.slice(1);const o=currentlyViewedDate.toLocaleDateString("hr-HR",n),r=new Date(currentlyViewedDate),s=new Date(currentlyViewedDate);s.setHours(23,59,59,999);const c=t.filter(e=>{const t=new Date(e.timestamp);return t>=r&&t<=s});c.sort((e,t)=>e.timestamp-t.timestamp);const l=c.reduce((e,t)=>e+t.racuni.length,0),d=c.reduce((e,t)=>e+t.racuni.reduce((e,t)=>e+t.amount,0),0),u=document.createElement("div");u.id="history-date-info";const m=getISODateString(currentlyViewedDate),h=t.some(e=>{const t=getISODateString(new Date(e.timestamp));return t&&t!==m});u.innerHTML=`<span style="font-weight: bold;">${i}, ${o}</span> <button id="history-view-toggle-btn" style="background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;" ${h?"":"disabled"}>OSTALI DANI ></button>`,historyDynamicHeaderContentDiv.appendChild(u);const g=u.querySelector("#history-view-toggle-btn");if(g){const e=g.cloneNode(!0);g.parentNode.replaceChild(e,g),e.disabled?(e.style.cssText+=";cursor: not-allowed; opacity: 0.7;"):e.addEventListener("click",()=>{playSound("click-sound"),renderAllDaysView()})}const p=document.createElement("div");p.id="history-summary-info",p.innerHTML=`<span>RAČUNA: <span style="font-weight: bold;">${l}</span></span> <span style="font-weight: bold;">UKUPNO: ${d.toFixed(2)} €</span>`,historyDynamicHeaderContentDiv.appendChild(p);const v='<p id="history-select-group-text" style="text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;">IZABERI SKEN ILI <button id="start-search-btn" style="background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;">(TRAŽI)</button></p>';let y='<ul id="scan-group-list" style="list-style: none; padding: 0; margin: 0;">';0===c.length?y+='<li style="text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;"><i>Nema spremljenih skenova za ovaj dan.</i></li>':c.forEach((e,t)=>{y+=generirajHtmlZaSpremljenuGrupu(e,t+1)}),y+="</ul>",historyContentDiv.innerHTML=v+y;if(c.length>0){const a=document.createElement("button");a.id="clear-day-btn",a.className="red-btn",a.style.margin="2em auto 1em auto",a.style.display="block",a.innerText="IZBRIŠI OVAJ DAN",historyContentDiv.appendChild(a),a.dataset.confirming="false";const n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),n.addEventListener("click",()=>{if(n.disabled)return;"true"!==n.dataset.confirming?(playSound("click-sound"),n.innerText="Potvrdi Brisanje Dana?",n.classList.add("confirm-mode"),n.dataset.confirming="true",sendLogData({Event:"delete_day_prompt",Details:getISODateString(currentlyViewedDate)})):(deleteScansForDay(new Date(currentlyViewedDate)))});const i=e=>{const t=document.getElementById("clear-day-btn");t&&"true"===t.dataset.confirming&&!t.contains(e.target)&&(t.innerText="IZBRIŠI OVAJ DAN",t.classList.remove("confirm-mode"),t.dataset.confirming="false",sendLogData({Event:"delete_day_cancelled_outside",Details:getISODateString(currentlyViewedDate)}))};historyPageDiv.removeEventListener("click",i,!0),historyPageDiv.addEventListener("click",i,!0)}const f=document.getElementById("scan-group-list");if(f){const e=f.cloneNode(!0);f.parentNode.replaceChild(e,f),e.addEventListener("click",e=>{const a=e.target.closest("li[data-timestamp]");if(a&&a.dataset.timestamp){const e=a.dataset.timestamp,n=t.find(t=>String(t.timestamp)===e);n?(playSound("click-sound"),previousHistoryViewState="day-view",renderGroupDetailView(n)):(console.error("Nije pronađena grupa:",e),alert("Greška otvaranja detalja."))}})}const b=document.getElementById("start-search-btn");b&&(b.cloneNode(!0),b.parentNode.replaceChild(newSearchBtn,b),newSearchBtn.addEventListener("click",startSearch)),console.log("renderHistoryView: Renderiranje završeno.")}function generirajHtmlZaSpremljenuGrupu(e,t){const a=new Date(e.timestamp),n=a.getHours().toString().padStart(2,"0"),i=a.getMinutes().toString().padStart(2,"0"),o=`${n}:${i}`,r=e.racuni.reduce((e,t)=>e+t.amount,0),s=e.lastQrTime||"??:??",c=e.name?`<span class="session-name-history">${e.name} U ${o}</span>`:`<span class="scan-time-history">SKEN U ${o}</span>`;return`<li data-timestamp="${e.timestamp}" style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;"><span style="flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;"><span style="margin-right: 5px; flex-shrink: 0;">${t}.</span> ${c}</span><span class="scan-group-last-qr-time" style="flex-shrink: 0; margin-left: 15px;">${"??:??"!==s?"zadnji iz "+s:""}</span><span style="font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;">${r.toFixed(2)} €</span></span></li>`}function renderGroupDetailView(e){if(!historyContentDiv||!e||!e.racuni||!historyDynamicHeaderContentDiv)return console.error("Nedostaju podaci za detalje."),void renderHistoryView();clearDynamicHeaderContent();const t=e.timestamp,a=new Date(t),n=a.getHours().toString().padStart(2,"0"),i=a.getMinutes().toString().padStart(2,"0"),o=`${n}:${i}`,r=e.racuni.reduce((e,t)=>e+t.amount,0),s=e.racuni.length,c=e.name?e.name:`SKEN U ${o}`,l=document.createElement("div");l.id="detail-header-info",l.innerHTML=`<button id="back-to-group-list-btn" style="background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">< Lista</button><h3 style="margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;">${c}</h3><span style="font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;">${r.toFixed(2)} €</span>`,historyDynamicHeaderContentDiv.appendChild(l);const d=document.createElement("div");d.id="detail-summary-info",d.innerHTML=`<span>RAČUNA: <span style="font-weight: bold;">${s}</span></span><span style="font-weight: bold;">UKUPNO: ${r.toFixed(2)} €</span>`,historyDynamicHeaderContentDiv.appendChild(d);let u='<ul id="detail-scan-list">';e.racuni.forEach((e,t)=>{const a="??:??"!==e.time?`${e.time}`:"Vrijeme?";u+=`<li><span style="color: #333; min-width: 80px;">${t+1}. ${a}</span><span style="font-weight: bold; margin-left: auto;">${e.amount.toFixed(2)} €${e.qrCode.startsWith("MANUAL_")?" (ručno)":""}</span></li>`}),u+='</ul>',u+=`<button id="delete-session-btn" class="red-btn" data-timestamp="${t}" style="margin: 2em auto 1em auto; display: block;">IZBRIŠI OVAJ SKEN</button>`,historyContentDiv.innerHTML=u;const m=document.getElementById("back-to-group-list-btn");if(m){const e=m.cloneNode(!0);m.parentNode.replaceChild(e,m),e.addEventListener("click",()=>{playSound("click-sound"),console.log("Vraćanje iz detalja, prethodno stanje:",previousHistoryViewState);const e=document.getElementById("all-days-search-input");switch(previousHistoryViewState){case"day-search-results":renderHistoryView(currentlyViewedDate),startSearch(),document.getElementById("search-input").value=lastSearchTerm,executeSearch();break;case"all-days-search-results":renderAllDaysView(),e&&(e.value=lastSearchTerm),executeAllDaysSearch();break;case"day-view":default:renderHistoryView(currentlyViewedDate)}})}const h=document.getElementById("delete-session-btn");h?(h.dataset.confirming="false",(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{if(t.disabled)return;"true"!==t.dataset.confirming?(playSound("click-sound"),t.innerText="Potvrdi brisanje?",t.classList.add("confirm-mode"),t.dataset.confirming="true",sendLogData({Event:"delete_session_prompt",Details:groupData.timestamp})):deleteSpecificSession(t.dataset.timestamp)})})(h),(e=>{const t=a=>{const n=document.getElementById("delete-session-btn");n&&"true"===n.dataset.confirming&&!n.contains(a.target)&&(n.innerText="IZBRIŠI OVAJ SKEN",n.classList.remove("confirm-mode"),n.dataset.confirming="false",sendLogData({Event:"delete_session_cancelled_outside",Details:e.timestamp}))};historyPageDiv.removeEventListener("click",t,!0),historyPageDiv.addEventListener("click",t,!0)})(e)):console.warn("Gumb #delete-session-btn nije pronađen.")}function deleteScansForDay(e){if(!(e instanceof Date)||isNaN(e))return console.error("Pokušaj brisanja dana s neispravnim datumom."),void alert("Greška: Nije moguće identificirati dan za brisanje.");const t=getISODateString(e);if(!t)return;console.log("Brisanje svih skenova za dan:",t);let a=loadFullHistoryFromLocalStorage();const n=a.length,i=a.filter(e=>{const a=getISODateString(new Date(e.timestamp));return a===t}),o=a.filter(e=>{const a=getISODateString(new Date(e.timestamp));return a!==t}),r=o.length;console.log(`Originalna dužina: ${n}, Nova dužina: ${r}`),r<n?(saveFullHistoryToLocalStorage(o),playSound("remove-sound"),alert(`Svi skenovi za ${e.toLocaleDateString("hr-HR")} obrisani.`),(()=>{const e={date:t,sessionCount:i.length,totalCount:i.reduce((e,t)=>e+t.racuni.length,0),totalAmount:i.reduce((e,t)=>e+t.racuni.reduce((e,t)=>e+t.amount,0),0)};sendLogData({Event:"day_deleted_confirmed",Details:JSON.stringify(e)})})(),renderAllDaysView()):(console.warn("Nisu pronađeni skenovi za brisanje za dan:",t),alert("Greška: Nisu pronađeni skenovi za ovaj dan."),(()=>{const e=document.getElementById("clear-day-btn");e&&"true"===e.dataset.confirming&&(e.innerText="IZBRIŠI OVAJ DAN",e.classList.remove("confirm-mode"),e.dataset.confirming="false")})())}function renderAllDaysView(){previousHistoryViewState="all-days-view";const e=loadFullHistoryFromLocalStorage();if(!historyContentDiv||!historyPageDiv||!historyDynamicHeaderContentDiv)return;clearDynamicHeaderContent();const t='<div id="all-days-search-container"><div style="display: flex; gap: 5px;"><input type="text" id="all-days-search-input" placeholder="UPIŠI ZA PRETRAGU..." style="flex-grow: 1; padding: 0.5em; font-size: 0.9em;"><button id="execute-all-days-search-btn" style="padding: 0.5em 0.6em; font-size: 0.9em;">Traži</button><button id="close-all-days-search-btn" style="padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;">Svi Dani</button></div></div><div id="all-days-summary-info" style="display: none;"></div>';historyDynamicHeaderContentDiv.innerHTML=t;const a='<div id="search-results-all-days"><p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p></div>';historyContentDiv.innerHTML=a;const n=document.getElementById("all-days-search-input"),i=document.getElementById("execute-all-days-search-btn"),o=document.getElementById("close-all-days-search-btn"),r=document.getElementById("search-results-all-days"),s=document.getElementById("all-days-summary-info"),c=e.reduce((e,t)=>{const a=getISODateString(new Date(t.timestamp));return a?(e[a]||(e[a]={date:new Date(t.timestamp),sessions:[],totalAmount:0,totalCount:0},e[a].date.setHours(0,0,0,0)),e[a].sessions.push(t),e[a].totalAmount+=t.racuni.reduce((e,t)=>e+t.amount,0),e[a].totalCount+=t.racuni.length,e):e},{}),l=Object.values(c).sort((e,t)=>t.date-e.date);if(n&&i&&o&&r&&s){const e=n.cloneNode(!0);n.parentNode.replaceChild(e,n),e.addEventListener("keydown",e=>{"Enter"===e.key&&executeAllDaysSearch()});const t=i.cloneNode(!0);i.parentNode.replaceChild(t,i),t.addEventListener("click",()=>{executeAllDaysSearch()});const a=o.cloneNode(!0);o.parentNode.replaceChild(a,o),a.addEventListener("click",()=>{playSound("click-sound"),e.value="",renderAllDaysList(l,r);const t=punaPovijest.reduce((e,t)=>e+t.racuni.length,0),a=punaPovijest.reduce((e,t)=>e+t.racuni.reduce((e,t)=>e+t.amount,0),0);s.innerHTML=`<span>RAČUNA: <span style="font-weight: bold;">${t}</span></span><span style="font-weight: bold;">UKUPNO: ${a.toFixed(2)} €</span>`,s.style.display=punaPovijest.length>0?"flex":"none"})}else console.error("Nisu pronađeni svi elementi za pretragu u All Days View.");if(e.length>0){const t='<button id="back-to-current-day-btn" style="background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">< NATRAG</button>',a='<button id="clear-history-btn" class="red-btn" style="padding: 0.5em 1em; font-size: 1em;">IZBRIŠI SVU POVIJEST</button>',n='<div style="text-align: center; margin-top: 1em; margin-bottom: 1em;"><button id="export-history-btn" style="background-color: #007bff; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">Izvezi povijest</button><button id="import-history-btn" style="background-color: #28a745; color: white; padding: 0.5em 1em; font-size: 1em;">Uvezi povijest</button></div>',i=`<div style="text-align: center; margin-top: 1.5em; margin-bottom: 1em;">${t}${a}</div> ${n}`;document.getElementById("back-to-current-day-btn")&&document.getElementById("clear-history-btn")&&document.getElementById("export-history-btn")||historyContentDiv.insertAdjacentHTML("beforeend",i);const o=document.getElementById("export-history-btn"),r=document.getElementById("import-history-btn");o?((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",exportHistory)})(o),console.error("Export gumb nije pronađen nakon dodavanja.")):console.error("Export gumb nije pronađen nakon dodavanja."),r?((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",importHistory)})(r),console.error("Import gumb nije pronađen nakon dodavanja.")):console.error("Import gumb nije pronađen nakon dodavanja.");const s=document.getElementById("back-to-current-day-btn");s&&((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{playSound("click-sound"),renderHistoryView(currentlyViewedDate)})})(s));const c=document.getElementById("clear-history-btn");c&&(0===e.length?(c.disabled=!0,c.style.opacity="0.6",c.style.cursor="not-allowed"):(c.disabled=!1,c.style.opacity="1",c.style.cursor="pointer"),c.dataset.confirming="false",(t=>{const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",()=>{if(a.disabled)return;"true"!==a.dataset.confirming?(playSound("click-sound"),a.innerText="Potvrdi Brisanje SVEGA?",a.classList.add("confirm-mode"),a.dataset.confirming="true",sendLogData({Event:"clear_all_prompt"})):(localStorage.removeItem(LS_KEYS.HISTORY),localStorage.removeItem(LS_KEYS.COUNTER1),localStorage.removeItem(LS_KEYS.COUNTER2),localStorage.removeItem(LS_KEYS.COUNTER_ACTIVE),localStorage.removeItem(LS_KEYS.USER_ID),localStorage.removeItem(LS_KEYS.FIRST_USE),localStorage.removeItem(LS_KEYS.UNSAVED_COUNT),localStorage.removeItem(LS_KEYS.UNSAVED_AMOUNT),localStorage.removeItem(LS_KEYS.CAMERA_ID),alert("Sva spremljena povijest i podaci brojača/kamere obrisani."),sendLogData({Event:"clear_all_confirmed"}),currentlyViewedDate=new Date,currentlyViewedDate.setHours(0,0,0,0),loadCountersState(),initializeUserTracking(),fetchSheetData().then(()=>{renderAllDaysView()}).catch(()=>{renderAllDaysView()}),playSound("remove-sound"))})})(c),(t=>{const a=e=>{const n=document.getElementById("clear-history-btn");n&&"true"===n.dataset.confirming&&!n.contains(e.target)&&(n.innerText="IZBRIŠI SVU POVIJEST",n.classList.remove("confirm-mode"),n.dataset.confirming="false",sendLogData({Event:"clear_all_cancelled_outside"}))};historyPageDiv.removeEventListener("click",a,!0),historyPageDiv.addEventListener("click",a,!0)})(e)))}if(e.length>0&&r&&s){renderAllDaysList(l,r);const t=e.reduce((e,t)=>e+t.racuni.length,0),a=e.reduce((e,t)=>e+t.racuni.reduce((e,t)=>e+t.amount,0),0);s.innerHTML=`<span>RAČUNA: <span style="font-weight: bold;">${t}</span></span><span style="font-weight: bold;">UKUPNO: ${a.toFixed(2)} €</span>`,s.style.display="flex"}else s&&(s.style.display="none")}function renderAllDaysList(e,t){if(!t)return;const a={weekday:"long"},n={day:"2-digit",month:"2-digit",year:"2-digit"};let i='<ul id="all-days-list-rendered" style="list-style: none; padding: 0; margin: 0;">';0===e.length?"search-results-all-days"===t.id&&document.getElementById("all-days-search-input")?.value.trim()?i+='<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></li>':i+='<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema spremljene povijesti.</i></li>':e.forEach(e=>{let t=e.date.toLocaleDateString("hr-HR",a);t=t.charAt(0).toUpperCase()+t.slice(1);const o=e.date.toLocaleDateString("hr-HR",n),r=getISODateString(e.date);i+=`<li data-date-iso="${r}" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;"><span style="font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${t}, ${o}</span><div style="flex-shrink: 0; text-align: right;"><span style="font-size: 0.9em; color: #555; white-space: nowrap;">Računa: ${e.totalCount}</span><span style="font-weight: bold; margin-left: 15px; white-space: nowrap;">${e.totalAmount.toFixed(2)} €</span></div></li>`}),i+="</ul>",t.innerHTML=i;const o=t.querySelector("ul");if(o){const e=o.cloneNode(!0);o.parentNode.replaceChild(e,o),e.addEventListener("click",e=>{const t=e.target.closest("li[data-date-iso]");if(t&&t.dataset.dateIso){const e=new Date(t.dataset.dateIso+"T00:00:00");playSound("click-sound"),currentlyViewedDate=e,renderHistoryView(e)}})}}function executeAllDaysSearch(){const e=document.getElementById("all-days-search-input"),t=document.getElementById("search-results-all-days"),a=document.getElementById("all-days-summary-info");if(!e||!t||!a)return;const n=e.value.trim().toLowerCase();lastSearchTerm=e.value.trim();const i=normalizeDateForSearch(e.value.trim());t.innerHTML="",a.style.display="none",a.innerHTML="";if(!n&&!i)return void(t.innerHTML='<p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p>');const o=loadFullHistoryFromLocalStorage(),r=[];const s={weekday:"long"},c={day:"2-digit",month:"2-digit",year:"numeric"},l={day:"2-digit",month:"2-digit",year:"2-digit"};o.forEach((e,t)=>{const a=new Date(e.timestamp),o=a.toLocaleDateString("hr-HR",c),d=a.toLocaleDateString("hr-HR",l),u=getISODateString(a);let m=a.toLocaleDateString("hr-HR",s).toLowerCase();const h=e.name?e.name.toLowerCase():"";let g=!1;i&&u&&u===i?g=!0:n&&(d.includes(n)||o.includes(n)||m.includes(n)||h&&h.includes(n)||e.racuni.some(e=>e.qrCode.toLowerCase().includes(n)||e.datv&&e.datv.toLowerCase().includes(n)))&&(g=!0),g&&r.push(e)}),renderSessionSearchResults(r,t,n,a),t.style.display="block",sendLogData({Event:"history_search_all_days",Details:{term:n,resultCount:r.length}})}function renderSessionSearchResults(e,t,a,n){if(!t||!n)return;t.innerHTML="",n.innerHTML="",n.style.display="none";if(0===e.length)return void(t.innerHTML='<p style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></p>');const i=e.reduce((e,t)=>e+t.racuni.length,0),o=e.reduce((e,t)=>e+t.racuni.reduce((e,t)=>e+t.amount,0),0);n.innerHTML=`<span>RAČUNA: <span style="font-weight: bold;">${i}</span></span><span style="font-weight: bold;">UKUPNO: ${o.toFixed(2)} €</span>`,n.style.display="flex",e.sort((e,t)=>t.timestamp-e.timestamp);let r='<ul id="search-results-list" style="list-style: none; padding: 0; margin: 0;">';const s={day:"2-digit",month:"2-digit",year:"2-digit"};e.forEach(e=>{const t=new Date(e.timestamp),a=t.toLocaleDateString("hr-HR",s),n=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0"),o=`${n}:${i}`,c=e.racuni.reduce((e,t)=>e+t.amount,0),l=e.lastQrTime||"??:??",d=e.name?`<span class="session-name-history">${e.name}</span>`:`<span class="scan-time-history">SKEN</span>`;r+=`<li data-timestamp="${e.timestamp}" style="border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;"><div style="font-weight: bold; margin-right: 8px; color: #666;">${a}</div><div style="flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;">${d} <span style="font-size:0.9em; color:#555; margin-left: 5px;">u ${o}</span></div><div style="flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;"><span class="scan-group-last-qr-time">${"??:??"!==l?"zadnji iz "+l:""}</span><span style="font-weight: bold; margin-left: 10px;">${c.toFixed(2)} €</span></div></li>`}),r+="</ul>",t.innerHTML=r;const c=t.querySelector("ul");if(c){const e=c.cloneNode(!0);c.parentNode.replaceChild(e,c),e.addEventListener("click",e=>{const a=e.target.closest("li[data-timestamp]");if(a&&a.dataset.timestamp){const e=a.dataset.timestamp,n=loadFullHistoryFromLocalStorage().find(t=>String(t.timestamp)===e);n?(playSound("click-sound"),"search-results"===t.id?(previousHistoryViewState="day-search-results",lastSearchTerm=document.getElementById("search-input")?.value.trim()||""):"search-results-all-days"===t.id&&(previousHistoryViewState="all-days-search-results",lastSearchTerm=document.getElementById("all-days-search-input")?.value.trim()||""),currentlyViewedDate=new Date(n.timestamp),currentlyViewedDate.setHours(0,0,0,0),renderGroupDetailView(n)):(console.error("Nije pronađena grupa iz rezultata pretrage:",e),alert("Greška pri otvaranju detalja."))}})}}function executeSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-results"),a=document.getElementById("search-summary-info-day");if(!e||!t||!a)return;const n=e.value.trim().toLowerCase();lastSearchTerm=e.value.trim();const i=normalizeDateForSearch(e.value.trim());t.innerHTML="",a.style.display="none",a.innerHTML="";if(!n&&!i)return void(t.innerHTML='<p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu (datum, dan, naziv, ili dio QR/DATV stringa).</i></p>');const o=loadFullHistoryFromLocalStorage(),r=[];const s={weekday:"long"},c={day:"2-digit",month:"2-digit",year:"numeric"},l={day:"2-digit",month:"2-digit",year:"2-digit"};o.forEach((e,t)=>{const a=new Date(e.timestamp),o=a.toLocaleDateString("hr-HR",c),d=a.toLocaleDateString("hr-HR",l),u=getISODateString(a);let m=a.toLocaleDateString("hr-HR",s).toLowerCase();const h=e.name?e.name.toLowerCase():"";let g=!1;i&&u&&u===i?g=!0:n&&(d.includes(n)||o.includes(n)||m.includes(n)||h&&h.includes(n)||e.racuni.some(e=>e.qrCode.toLowerCase().includes(n)||e.datv&&e.datv.toLowerCase().includes(n)))&&(g=!0),g&&r.push(e)}),renderSessionSearchResults(r,t,n,a);const d=document.getElementById("scan-group-list");d&&(d.style.display="none");const u=document.getElementById("history-select-group-text");u&&(u.style.display="none");const m=document.getElementById("clear-day-btn");m&&(m.style.display="none"),sendLogData({Event:"history_search_day_view",Details:{term:n,resultCount:r.length}})}function startSearch(){playSound("click-sound"),console.log("Pokretanje pretrage (sada pretražuje SVE)...");if(!historyContentDiv||!historyDynamicHeaderContentDiv)return;const e=document.getElementById("scan-group-list");e&&(e.style.display="none");const t=document.getElementById("history-select-group-text");t&&(t.style.display="none");const a=document.getElementById("clear-day-btn");a&&(a.style.display="none");const n=document.getElementById("history-date-info"),i=document.getElementById("history-summary-info");n&&(n.style.display="none"),i&&(i.style.display="none");let o=document.getElementById("search-container");o||(o=document.createElement("div"),o.id="search-container",o.innerHTML='<div style="display: flex; gap: 10px; margin-bottom: 0.8em;"><input type="text" id="search-input" placeholder="Pretraži SVE (Datum, Dan, Naziv...)" style="flex-grow: 1; padding: 0.5em;"><button id="execute-search-btn" style="padding: 0.5em 1em;">Traži</button><button id="close-search-btn" style="padding: 0.5em 1em; background-color: #ccc;">Zatvori</button></div><div id="search-summary-info-day" style="display: none;"></div>',historyDynamicHeaderContentDiv.appendChild(o)),o.style.display="block",historyContentDiv.innerHTML='<div id="search-results"><p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu.</i></p></div>';const r=document.getElementById("search-results");r&&(r.style.display="block");const s=document.getElementById("search-input"),c=document.getElementById("execute-search-btn"),l=document.getElementById("close-search-btn"),d=document.getElementById("search-summary-info-day");s&&(s.value="",s.focus()),d&&(d.style.display="none",d.innerHTML=""),c&&((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",executeSearch)})(c)),l&&((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{playSound("click-sound"),e&&"none"!==e.style.display&&(e.style.display="none"),renderHistoryView(currentlyViewedDate)})})(l)),s&&((e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("keydown",e=>{"Enter"===e.key&&executeSearch()})})(s))}function deleteSpecificSession(e){if(null==e)return console.error("Pokušaj brisanja sesije s neispravnim timestampom."),alert("Greška: Nije moguće identificirati sken za brisanje."),void(document.getElementById("delete-session-btn")?.dataset.confirming==="true"&&(deleteSessionBtn.innerText="IZBRIŠI OVAJ SKEN",deleteSessionBtn.classList.remove("confirm-mode"),deleteSessionBtn.dataset.confirming="false"));console.log("Brisanje specifične sesije s timestampom:",e);let t=loadFullHistoryFromLocalStorage();const a=t.length,n=t.findIndex(t=>String(t.timestamp)===String(e));if(n>-1){const i=t[n],o={timestamp:i.timestamp,name:i.name||null,invoiceCount:i.racuni.length,totalAmount:i.racuni.reduce((e,t)=>e+t.amount,0).toFixed(2),lastQrTime:i.lastQrTime||"??:??"};t.splice(n,1);const r=t.length;r<a?(saveFullHistoryToLocalStorage(t),playSound("remove-sound"),alert("Sken (sesija) uspješno obrisan."),sendLogData({Event:"session_deleted_confirmed",Details:JSON.stringify(o)}),(()=>{switch(previousHistoryViewState){case"day-view":renderHistoryView(currentlyViewedDate);break;case"day-search-results":renderHistoryView(currentlyViewedDate),startSearch(),document.getElementById("search-input").value=lastSearchTerm,executeSearch();break;case"all-days-view":renderAllDaysView();break;case"all-days-search-results":renderAllDaysView(),(()=>{const e=document.getElementById("all-days-search-input");e&&(e.value=lastSearchTerm)})(),executeAllDaysSearch();break;default:renderHistoryView(currentlyViewedDate)}})()):(console.warn("Nije pronađen sken s timestampom za brisanje:",e),alert("Greška: Nije moguće pronaći sken za brisanje."),(()=>{const e=document.getElementById("delete-session-btn");e&&(e.innerText="IZBRIŠI OVAJ SKEN",e.classList.remove("confirm-mode"),e.dataset.confirming="false")})())}else console.warn("Nije pronađen sken s timestampom za brisanje (findIndex -1):",e),alert("Greška: Nije moguće pronaći sken za brisanje."),(()=>{const e=document.getElementById("delete-session-btn");e&&(e.innerText="IZBRIŠI OVAJ SKEN",e.classList.remove("confirm-mode"),e.dataset.confirming="false")})()}function exportHistory(){playSound("click-sound");const e=loadFullHistoryFromLocalStorage(),t=povijest.length>0||currentSessionName?{count:povijest.length,amount:ukupno,currentSession:povijest,currentName:currentSessionName||null}:null;if(0===e.length&&!t)return alert("Nema povijesti za izvoz."),void sendLogData({Event:"history_exported",Details:"no_data"});try{const a={savedHistory:e,unsavedState:t,exportTimestamp:(new Date).toISOString(),appVersion:"1.0.0"},n=JSON.stringify(a,null,2),i=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o;const s=new Date;r.download=`qr_racunator_povijest_${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),alert("Povijest je izvezena kao JSON datoteka.");const c={savedItemCount:e.length,unsavedItemCount:t?t.count:0};sendLogData({Event:"history_exported",Details:JSON.stringify(c)})}catch(e){console.error("Greška pri izvozu povijesti:",e),alert("Greška pri izvozu povijesti."),sendLogData({Event:"history_export_failed",Details:e.message})}}function importHistory(){playSound("click-sound");const e=document.getElementById("import-file-input");e?(e.click(),e.addEventListener("change",t=>{const a=t.target.files[0];if(!a)return console.log("Nije odabrana datoteka za uvoz."),e.value="",void sendLogData({Event:"history_import_cancelled",Details:"no_file_selected"});const n=new FileReader;n.onload=t=>{try{const a=t.target.result,n=JSON.parse(a);let i=null,o=null;if(Array.isArray(n))i=n,console.log("Uvezen format v1.");else{if("object"!=typeof n||null===n||!Array.isArray(n.savedHistory))throw new Error("Neispravan format datoteke. Očekuje se niz sesija ili objekt s 'savedHistory'.");i=n.savedHistory,o=n.unsavedState,console.log("Uvezen format v2.")}if(!i.every(e=>"object"==typeof e&&null!==e&&Array.isArray(e.racuni)&&e.racuni.every(e=>"object"==typeof e&&null!==e&&"number"==typeof e.amount&&"string"==typeof e.qrCode)))throw new Error("Neispravna struktura podataka unutar spremljene povijesti.");if(o){if("object"!=typeof o||null===o||"number"!=typeof o.count||"number"!=typeof o.amount||!Array.isArray(o.currentSession)||(null!==o.currentName&&"string"!=typeof o.currentName&&void 0!==o.currentName)||!o.currentSession.every(e=>"object"==typeof e&&null!==e&&"number"==typeof e.amount&&"string"==typeof e.qrCode))console.warn("Uvezeni podaci sadrže neispravno formatirano nesačuvano stanje. Ignoriram nesačuvano stanje."),o=null}const r=`Pronađeno ${i.length} spremljenih sesija ${o&&o.count>0?` i nesačuvano stanje (${o.count} računa)`:""} u datoteci.\n\nŽelite li PREPISATI vašu trenutnu povijest i nesačuvano stanje ovim podacima?\n(Trenutna povijest i nesačuvano stanje će biti trajno izbrisani!)`;if(confirm(r)){localStorage.removeItem(LS_KEYS.HISTORY),localStorage.removeItem(LS_KEYS.COUNTER1),localStorage.removeItem(LS_KEYS.COUNTER2),localStorage.removeItem(LS_KEYS.COUNTER_ACTIVE),localStorage.removeItem(LS_KEYS.USER_ID),localStorage.removeItem(LS_KEYS.FIRST_USE),localStorage.removeItem(LS_KEYS.UNSAVED_COUNT),localStorage.removeItem(LS_KEYS.UNSAVED_AMOUNT),localStorage.removeItem(LS_KEYS.CAMERA_ID),saveFullHistoryToLocalStorage(i);try{o&&o.currentSession&&o.currentSession.length>0?(povijest=o.currentSession,ukupno=o.amount,currentSessionName=o.currentName||null,localStorage.setItem(LS_KEYS.UNSAVED_COUNT,povijest.length),localStorage.setItem(LS_KEYS.UNSAVED_AMOUNT,ukupno),console.log(`Uvezeno nesačuvano stanje: ${povijest.length} računa, ${ukupno.toFixed(2)} €, Naziv: ${currentSessionName||"N/A"}`)):(povijest=[],ukupno=0,currentSessionName=null,console.log("Nema nesačuvanog stanja u uvezenoj datoteci, trenutna sesija je prazna."),localStorage.removeItem(LS_KEYS.UNSAVED_COUNT),localStorage.removeItem(LS_KEYS.UNSAVED_AMOUNT))}catch(e){console.error("Greška spremanja uvezenog nesačuvanog stanja u localStorage:",e)}deleteWarningDiv&&(delete deleteWarningDiv.dataset.lastScanText,delete deleteWarningDiv.dataset.beforeConfirmText,delete deleteWarningDiv.dataset.lastNameText,delete deleteWarningDiv.dataset.beforeConfirmNameText),resetRemoveMode(),resetOcistiMode(),loadCountersState(),initializeUserTracking(),updateDisplay(),alert("Povijest uspješno uvezena i lokalni podaci resetirani.");const t={savedItemCount:i.length,unsavedItemCount:o?o.count:0,mode:"overwrite"};sendLogData({Event:"history_imported",Details:JSON.stringify(t)}),fetchSheetData().then(()=>{renderAllDaysView()}).catch(()=>{renderAllDaysView()})}else alert("Uvoz otkazan."),sendLogData({Event:"history_import_cancelled",Details:"user_cancelled"})}catch(t){console.error("Greška pri obradi datoteke za uvoz:",t),alert(`Greška pri uvozu povijesti: ${t.message}`),sendLogData({Event:"history_import_failed",Details:t.message})}finally{e.value=""}},{once:!0})):console.error("Input za datoteku za uvoz nije pronađen.")}function handleVisibilityChange(){"visible"===document.visibilityState&&document.body.classList.contains("scanner-view")?(console.log("Aplikacija postala vidljiva u Scanner View."),initializeScanner()):"hidden"===document.visibilityState&&(console.log("Aplikacija postala nevidljiva, zaustavljam skener."),stopScanner())}function attachVisibilityListener(){visibilityListenerAttached||(document.addEventListener("visibilitychange",handleVisibilityChange),visibilityListenerAttached=!0,console.log("Visibility listener dodan."))}function globalClickListener(e){if(cameraSelectionOverlay&&"block"===cameraSelectionOverlay.style.display){const t=cameraSelectionOverlay.contains(e.target),a=switchCameraButton&&switchCameraButton.contains(e.target);t||a||(cameraSelectionOverlay.style.display="none")}if(manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display){const t=document.getElementById("manual-entry-modal-content"),a=t&&t.contains(e.target),n=manualEntryBtn&&manualEntryBtn.contains(e.target);t&&t.contains(e.target)||a||n||cancelManualEntry()}const t=removeButton&&removeButton.contains(e.target),a=ocistiButton&&ocistiButton.contains(e.target),n=sessionNameInput&&sessionNameInput.contains(e.target),i=addNameBtn&&addNameBtn.contains(e.target),o=e.target.classList.contains("edit-icon"),r=deleteWarningDiv&&"none"!==deleteWarningDiv.style.display&&deleteWarningDiv.contains(e.target),s=e.target.closest("#clear-day-btn, #delete-session-btn, #clear-history-btn"),c=historyToggleButton&&historyToggleButton.contains(e.target),l=shareButton&&shareButton.contains(e.target);if((removeConfirm||removeNameConfirm)&&!t&&!r&&resetRemoveMode(),ocistiConfirm&&!a&&resetOcistiMode(),sessionNameInput&&"block"===sessionNameInput.style.display&&!n&&!i&&!o&&saveName(),!s&&!c&&!l&&!n&&!i&&!o){const e=document.getElementById("clear-day-btn");e&&"true"===e.dataset.confirming&&(e.innerText="IZBRIŠI OVAJ DAN",e.classList.remove("confirm-mode"),e.dataset.confirming="false",sendLogData({Event:"delete_day_cancelled_outside",Details:getISODateString(currentlyViewedDate)}));const t=document.getElementById("delete-session-btn");t&&"true"===t.dataset.confirming&&(t.innerText="IZBRIŠI OVAJ SKEN",t.classList.remove("confirm-mode"),t.dataset.confirming="false");const a=document.getElementById("clear-history-btn");a&&"true"===a.dataset.confirming&&(a.innerText="IZBRIŠI SVU POVIJEST",a.classList.remove("confirm-mode"),a.dataset.confirming="false",sendLogData({Event:"clear_all_cancelled_outside"}))}}document.addEventListener("DOMContentLoaded",()=>{console.log("DOM spreman..."),totalDiv=document.getElementById("total"),totalContainer=document.getElementById("total-container"),ocistiButton=document.getElementById("ocisti-button"),invoiceCountDiv=document.getElementById("invoice-count"),historyList=document.getElementById("historyList"),removeButton=document.getElementById("remove-from-list-btn"),duplicateWarning=document.getElementById("duplicate-warning"),loadedMsg=document.getElementById("loaded-message"),instructionDiv=document.getElementById("scan-instruction"),deleteWarningDiv=document.getElementById("delete-warning"),shareButton=document.getElementById("share-button"),readerDiv=document.getElementById("reader"),historyToggleButton=document.getElementById("history-toggle-btn"),historyDiv=document.getElementById("history"),historyPageDiv=document.getElementById("history-page"),backToScannerButton=document.getElementById("back-to-scanner-btn"),historyContentDiv=document.getElementById("history-content"),sessionNameContainer=document.getElementById("session-name-container"),addNameBtn=document.getElementById("add-name-btn"),sessionNameInput=document.getElementById("session-name-input"),sessionNameDisplay=document.getElementById("session-name-display"),sessionNameText=document.getElementById("session-name-text"),historyStickyHeaderDiv=document.getElementById("history-sticky-header"),historyDynamicHeaderContentDiv=document.getElementById("history-dynamic-header-content"),runningTextContainer=document.getElementById("running-text-container"),runningTextSpan=runningTextContainer?runningTextContainer.querySelector("span"):null,sharePromptOverlay=document.getElementById("share-prompt-overlay"),counterDeactivatedIndicator=document.getElementById("counter-deactivated-indicator"),switchCameraButton=document.getElementById("switch-camera-btn"),cameraSelectionOverlay=document.getElementById("camera-selection-overlay"),cameraListUl=document.getElementById("camera-list"),manualEntryBtn=document.getElementById("manual-entry-btn"),manualEntryModalOverlay=document.getElementById("manual-entry-modal-overlay"),manualAmountInput=document.getElementById("manual-amount-input"),manualTimeInput=document.getElementById("manual-time-input"),manualAddBtn=document.getElementById("manual-add-btn"),manualCancelBtn=document.getElementById("manual-cancel-btn"),manualEntryErrorMsg=document.getElementById("manual-entry-error"),importFileInput=document.getElementById("import-file-input");if(!readerDiv||!historyPageDiv||!historyContentDiv||!backToScannerButton||!historyToggleButton||!sessionNameContainer||!historyStickyHeaderDiv||!historyDynamicHeaderContentDiv||!runningTextContainer||!runningTextSpan||!sharePromptOverlay||!counterDeactivatedIndicator||!loadedMsg||!duplicateWarning||!switchCameraButton||!cameraSelectionOverlay||!cameraListUl||!manualEntryBtn||!manualEntryModalOverlay||!manualAmountInput||!manualTimeInput||!manualAddBtn||!manualCancelBtn||!manualEntryErrorMsg||!importFileInput){const e=[];return readerDiv||e.push("#reader"),historyPageDiv||e.push("#history-page"),historyContentDiv||e.push("#history-content"),backToScannerButton||e.push("#back-to-scanner-btn"),historyToggleButton||e.push("#history-toggle-btn"),sessionNameContainer||e.push("#session-name-container"),historyStickyHeaderDiv||e.push("#history-sticky-header"),historyDynamicHeaderContentDiv||e.push("#history-dynamic-header-content"),runningTextContainer||e.push("#running-text-container"),runningTextSpan||e.push("#running-text-container span"),sharePromptOverlay||e.push("#share-prompt-overlay"),counterDeactivatedIndicator||e.push("#counter-deactivated-indicator"),loadedMsg||e.push("#loaded-message"),duplicateWarning||e.push("#duplicate-warning"),switchCameraButton||e.push("#switch-camera-btn"),cameraSelectionOverlay||e.push("#camera-selection-overlay"),cameraListUl||e.push("#camera-list"),manualEntryBtn||e.push("#manual-entry-btn"),manualEntryModalOverlay||e.push("#manual-entry-modal-overlay"),manualAmountInput||e.push("#manual-amount-input"),manualTimeInput||e.push("#manual-time-input"),manualAddBtn||e.push("#manual-add-btn"),manualCancelBtn||e.push("#manual-cancel-btn"),manualEntryErrorMsg||e.push("#manual-entry-error"),importFileInput||e.push("#import-file-input"),console.error("GREŠKA: Nedostaju kritični DOM elementi! Provjerite konzolu za detalje."),console.error("Nedostaju elementi:",e.join(", ")),document.body.innerHTML='<div style="padding: 20px; color: red; font-weight: bold;">Greška pri učitavanju aplikacije. Nedostaju ključni elementi. Osvježite stranicu ili provjerite konzolu za detalje.</div>',void sendLogData({Event:"critical_dom_missing",Details:e.join(", ")})}document.body.addEventListener("click",globalClickListener,!0),historyToggleButton?(historyToggleButton.cloneNode(!0),historyToggleButton.parentNode.replaceChild(newHistoryToggleButton,historyToggleButton),historyToggleButton.addEventListener("click",()=>{console.log("Klik na 'POVIJEST' gumb detektiran."),playSound("click-sound"),switchToHistoryView()})):console.error("DOM spreman, ali #history-toggle-btn nije pronađen!"),backToScannerButton&&backToScannerButton.addEventListener("click",()=>{playSound("click-sound"),switchToScannerView()}),navigator.share&&"function"==typeof navigator.share?shareButton&&(shareButton.style.display="block",shareButton.cloneNode(!0),shareButton.parentNode.replaceChild(newShareButton,shareButton),shareButton.addEventListener("click",async()=>{removeConfirm||removeNameConfirm&&resetRemoveMode(),ocistiConfirm&&resetOcistiMode(),manualEntryModalOverlay&&"flex"===manualEntryModalOverlay.style.display&&hideManualEntryModal();const e={title:"QR SKENER-RAČUNATOR",text:"Skenira i zbraja račune bez instaliranja. Isprobaj!",url:"https://soboslikar.github.io/QR-RACUNATOR/"};try{await navigator.share(e),console.log("Share dijalog zatvoren (vjerojatno uspješno)..."),sendLogData({Event:"share_success"})}catch(t){console.error("Greška dijeljenja:",t),"AbortError"===t.name?(console.log("Korisnik odustao od dijeljenja."),sendLogData({Event:"share_cancelled"})):(console.log("Došlo je do druge greške pri dijeljenju."),showTemporaryMessage(loadedMsg,"Dijeljenje neuspješno.",1500),sendLogData({Event:"share_failed",Details:t.message}))}finally{console.log("Share attempt finished. Checking counter state for reset."),0===brojac&&brojac2>0?(brojac=brojac2,saveBrojac(),console.log("Brojač resetiran na prag:",brojac),sendLogData({Event:"share_counter_reset",Details:brojac})):console.log("Brojač nije resetiran. Stanje: brojac="+brojac+", brojac2="+brojac2),checkSharePrompt(),updateRunningTextVisibility(),updateDeactivatedIndicator(),console.log("UI updated after share attempt.")}})):(console.log("navigator.share API nije podržan ili dostupan."),shareButton&&(shareButton.style.display="none"),sendLogData({Event:"share_api_not_supported"})),sessionNameInput?(sessionNameInput.addEventListener("keydown",e=>{"none"!==sessionNameInput.style.display&&("Enter"===e.key?(e.preventDefault(),saveName()):"Escape"===e.key&&(e.preventDefault(),sessionNameInput.value=currentSessionName||"",sessionNameInput.style.display="none",updateNameDisplay(),removeNameConfirm&&resetRemoveMode(),sendLogData({Event:"session_name_input_cancelled_escape"})))}),sessionNameInput.addEventListener("blur",saveName)):console.error("DOM spreman, ali #session-name-input nije pronađen!"),switchCameraButton?(switchCameraButton.cloneNode(!0),switchCameraButton.parentNode.replaceChild(newSwitchCameraButton,switchCameraButton),switchCameraButton.addEventListener("click",toggleCameraSelection)):console.error("DOM spreman, ali #switch-camera-btn nije pronađen!"),manualEntryBtn?manualEntryBtn.addEventListener("click",showManualEntryModal):console.error("DOM spreman, ali #manual-entry-btn nije pronađen!"),manualAddBtn?manualAddBtn.addEventListener("click",addManualEntry):console.error("DOM spreman, ali #manual-add-btn nije pronađen!"),manualCancelBtn?manualCancelBtn.addEventListener("click",cancelManualEntry):console.error("DOM spreman, ali #manual-cancel-btn nije pronađen!"),manualEntryModalOverlay?manualEntryModalOverlay.addEventListener("keydown",e=>{if("none"===manualEntryModalOverlay.style.display)return;"Enter"===e.key?document.activeElement!==manualAmountInput&&document.activeElement!==manualTimeInput||(e.preventDefault(),addManualEntry()):"Escape"===e.key&&(e.preventDefault(),cancelManualEntry())}):console.error("DOM spreman, ali #manual-entry-modal-overlay nije pronađen!"),loadCountersState(),initializeUserTracking(),updateDisplay(),console.log("Provjeravam inicijalni view..."),document.body.classList.contains("scanner-view")?(console.log("Init: Scanner view - Pokrećem inicijalizaciju skenera..."),initializeScanner(),attachVisibilityListener()):(console.log("Init: History view - Renderiram povijest."),renderHistoryView(currentlyViewedDate)),fetchSheetData().then(()=>{console.log("Sheet podaci dohvaćeni. Pripremam 'app_loaded' log.");const e={status:"ok",fetchSuccess:!0},t={Event:"app_loaded",Details:JSON.stringify(e)};sendLogData(t),updateRunningText(),checkSharePrompt(),updateDeactivatedIndicator(),document.body.classList.contains("history-view")?(console.log("Ažuriram prikaz povijesti nakon dohvaćanja podataka."),renderHistoryView(currentlyViewedDate)):console.log("UI skenera ažuriran nakon dohvaćanja podataka."),console.log("Inicijalizacija (pozadinska obrada) završena.")}).catch(e=>{console.error("Greška tijekom pozadinskog dohvaćanja podataka:",e);const t={Event:"app_loaded",Details:JSON.stringify({status:"error",fetchError:e.toString()})};sendLogData(t),console.log("Inicijalizacija završena (s greškom pozadinskog dohvaćanja)."),updateRunningText(),checkSharePrompt(),updateDeactivatedIndicator(),document.body.classList.contains("history-view")&&renderHistoryView(currentlyViewedDate)})});
  </script>

  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>

</body>
</html>
