    // --- IZMJENA: Logika prikaza poruka u handleScan s odgodom za duplikat ---
    function handleScan(decodedText) {
       if (removeConfirm) {
           removeButton.innerText = removeBtnInitialText;
           removeButton.classList.remove('yellow-btn');
           removeButton.classList.add('red-btn');
           removeConfirm = false;
           handleAmountLabelVisibility();
       }

       try {
           const qrParts = decodedText.split('?');
           if (qrParts.length < 2) {
               console.warn("QR kod nema očekivani format (nedostaje '?'):", decodedText);
               return;
           }
           const params = new URLSearchParams(qrParts[1]);
           const iznosCentStr = params.get('izn');
           const datv = params.get('datv');

           if (iznosCentStr && !isNaN(parseFloat(iznosCentStr))) {
               const iznosCenti = parseFloat(iznosCentStr);
               const iznosEura = iznosCenti / 100;
               let time = '??:??';
               if (datv && datv.length >= 13) {
                   const hour = datv.substring(9, 11);
                   const minute = datv.substring(11, 13);
                   if (!isNaN(parseInt(hour)) && !isNaN(parseInt(minute))) {
                       time = `${hour}:${minute}`;
                   }
               }

               const existingItem = povijest.find(item => item.qrCode === decodedText);

               // 1. Uvijek sakrij obje poruke na početku obrade skena
               loadedMsg.style.display = 'none';
               duplicateWarning.style.display = 'none';

               if (existingItem) {
                   // 2a. Pronađen duplikat -> Odgodi prikaz upozorenja
                   console.log("Duplikat pronađen. Čekanje 1s prije prikaza upozorenja."); // Za debug
                   setTimeout(() => {
                       console.log("Prikaz upozorenja o duplikatu."); // Za debug
                       // Pokaži upozorenje
                       duplicateWarning.style.display = 'block';
                       // Ponovno pokreni animaciju
                       duplicateWarning.style.animation = 'none';
                       duplicateWarning.offsetHeight; // Reflow
                       duplicateWarning.style.animation = 'pulse 0.5s ease-in-out 4 alternate';

                       // Sakrij upozorenje nakon što njegova animacija završi
                       // (pulse traje 4*0.5s = 2s)
                       setTimeout(() => {
                           if (duplicateWarning.style.display === 'block') {
                               duplicateWarning.style.display = 'none';
                               console.log("Upozorenje o duplikatu sakriveno."); // Za debug
                           }
                       }, 2200); // 2000ms + 200ms buffer
                   }, 1000); // Odgoda od 1 sekunde (trajanje 'loadedMsg' animacije)

               } else {
                   // 2b. Novi račun -> Pokaži "UČITANO" odmah
                   if (instructionDiv.style.display !== 'none') {
                       instructionDiv.style.display = 'none';
                   }

                   povijest.push({
                       amount: iznosEura,
                       qrCode: decodedText,
                       time: time
                   });
                   ukupno += iznosEura;
                   updateDisplay(); // Ažurira total, count, history
                   playSound('scan-sound');

                   // Pokaži "UČITANO" poruku
                   loadedMsg.style.display = 'block';
                    // Ponovno pokreni animaciju
                   loadedMsg.style.animation = 'none';
                   loadedMsg.offsetHeight; // Reflow
                   loadedMsg.style.animation = 'zoomFade 1s ease-out';

                   // Animacija zoomFade sama sakrije element nakon 1s,
                   // ali osigurajmo se (timeout ostaje isti)
                   setTimeout(() => {
                        if (loadedMsg.style.display === 'block') {
                           loadedMsg.style.display = 'none';
                        }
                    }, 1000);
               }
           } else {
              console.warn("QR kod ne sadrži validan 'izn' parametar ili 'izn' nije broj:", decodedText);
           }
       } catch (error) {
           if (error instanceof TypeError && error.message.includes("URLSearchParams")) {
               console.warn("Skenirani tekst nije validan URL ili query string:", decodedText);
           } else {
               console.error("Neočekivana greška pri obradi QR koda:", error, decodedText);
           }
           // Sakrij obje poruke i u slučaju greške
           loadedMsg.style.display = 'none';
           duplicateWarning.style.display = 'none';
       }
    }

    // Ostatak JavaScripta (updateDisplay, updateHistory, checkRemoveButtonVisibility,
    // handleAmountLabelVisibility, playSound, clearCurrent, startRemoveFromList,
    // event listener, inicijalizacija skenera) ostaje nepromijenjen...
